var CommunicationHandler=function(){CommunicationHandler.self=this;$("#profileIdT").on("input",CommunicationHandler.prototype.documentTypeSelectHandler);$("#sendHelpMessageButtonId").on("click",CommunicationHandler.prototype.sendMessage);$("#cancelProfileBottom").on("click",CommunicationHandler.prototype.resetProfileParameter);$("#backProfileBottom").on("click",CommunicationHandler.prototype.backProfileParameter);$("#editProfileBottom").on("click",CommunicationHandler.prototype.editProfileParameter);$("#confirmProfileBottom").on("click",CommunicationHandler.prototype.editProfileParameter);$("#helpMessageForm").submit(function(a){a.preventDefault()});$("#profileEditForm").submit(function(a){a.preventDefault()})};CommunicationHandler.SPEED=350;CommunicationHandler.prototype.loginFormSubmitHandler=function(b){b.preventDefault();var e=$("#actionValue").val();if("login"===e){$(".loginFormSubmitButtonText").hide();$(".loginFormSubmitButtonImage").show();statusbar("waiting for server reply on login");var f={tenantId:tenantId,username:$("#loginname").val(),password:$("#password").val()};username=f.username;ajax("/tenant/v1d/mis/user","GET",CommunicationHandler.self.loginResponseHandler,null,f,CommunicationHandler.self.loginFailedHandler)}else{if("forgotPassword"===e){$(".forgotPasswordSubmitImage").hide();var a=$("#forgotPasswordData").val();if(a==null||a==undefined||a==""){$(".message").html("Fill In the Blanks").show();return}f={tenantId:tenantId,data:$("#forgotPasswordData").val()};$(".message").html("Proccessing ... ").show();ajax("/tenant/v1d/mis/forgotPassword","POST",CommunicationHandler.self.forgotPasswordResponseHandler,null,f,CommunicationHandler.self.forgotPasswordFailedHandler)}else{if("update"===e){var h=$("#codedata").val();var d=$("#newpassword").val();var g=$("#repeatnewpassword").val();if(h.length===""||d===""||g===""){$(".message").html("Fill In the Blanks").show();return}if(d!==g){$(".message").html("Passwords Dont Match ").show();return}$(".message").html("Proccessing ... ").show();var c='{"code": "'+h+'", "password":"'+d+'", "repeatPassword": "'+g+'"}';var f={tenantId:tenantId};console.log(c);$.ajax({url:host+"/tenant/v1d/mis/updatePassword",data:c,dataType:"json",contentType:"application/json; charset=utf-8",headers:f,type:"POST",success:function(i){CommunicationHandler.self.updatePasswordResponseHandler()},complete:function(){}}).fail(function(i){if(i.status==200){CommunicationHandler.self.updatePasswordResponseHandler()}else{CommunicationHandler.self.updatePasswordfailHandler()}})}else{}}}};CommunicationHandler.prototype.loginResponseHandler=function(b){statusbar("login successful");logFancyMessage(b.username+" logging in with permissions:",b.permissions,"lime");authentication=b.authentication;user=b;user.fullname=user.lastname.capitalizeFirstLetter()+" "+user.firstname.capitalizeFirstLetter();var a=user.tenantId;var c=localStorage.tenantId;officeId=b.officeId;if(a===c){}else{localStorage.clear()}handlers.Permissions.assign_user_permissions(b.permissions);ajax("/tenant/v1d/currencycode","GET",function(d){currencyCode=d.code;localStorage.currencyCode=currencyCode;$(".currencyExtensionAddon").html(currencyCode)});$.ajax({url:host+"/officer/v1d/find?awamoId="+user.officerMasterData.awamoId+"&deviceId=cockpit&datatype=PHOTOGRAPHY",type:"GET",headers:getAuthenticationHeader(),xhrFields:{responseType:"arraybuffer"}}).done(function(g){var f=new Blob([g],{type:"image/jpg"});var d=new FileReader();d.onload=function(h){localStorage.icon=h.target.result;$("#dashboardProfileImage img").attr("src",localStorage.icon);$("#profilePanel img").attr("src",localStorage.icon)};d.readAsDataURL(f)}).fail(function(d){}).always(function(d){});$("#username").val(username);$(".navbar-fixed-top a.navbar-brand").on("click touch",function(){$("#dashboard a").click()});$(".navbar-fixed-top .nav li ul li").on("click touch",CommunicationHandler.prototype.handleMainMenu);$(".sidebar .nav li").on("click touch",CommunicationHandler.prototype.sidebarNavigationHandler);$("nav.navbar-fixed-top ul.nav").show();$("#login").hide();handlers.Dashboard.init();$("#singleActions a[data-action]").on("click touch",function(){$("#messagebox").stop().slideUp(500)})};CommunicationHandler.prototype.initData=function(){showLoader("Loading data, Please wait...");handlers.Roles.init();handlers.Settings.init();handlers.Offices.init();handlers.Countries.init();var a=[groupList,officerList,savingsAccountList,accountList,shareProductList,shareList];CommunicationHandler.self.getServerTotals(a,function(){clientList.init(a)})};CommunicationHandler.prototype.getServerTotals=function(b,d){var a=1;var c=[];c.push(clientList);b.forEach(function(e){c.push(e)});c.forEach(function(e){e.getserverTotals(e,c,function(h,f){a++;if(a===f.length){d()}var g=h.entityName;var j=["The server totals for {"+h.entityName+"} are "+h.totalServerCount];j.push("Fetching total results count for "+h.entityName+" completed");var i="yellow";logFancyMessage(g,j,i)})})};CommunicationHandler.prototype.loginFailedHandler=function(a){user=null;username=null;$(".loginbox .message").show();$(".loginFormSubmitButtonText").show();$(".loginFormSubmitButtonImage").hide()};CommunicationHandler.prototype.updatePasswordResponseHandler=function(){$("#actionValue").val("login");$("#loginRow input").attr("required","required");$("#forgotPasswordRow input").removeAttr("required");$("#loginRow").show();$("#forgotPasswordRow").hide();$("#updatePasswordRow input").removeAttr("required");$("#updatePasswordRow").hide();$(".loginFormSubmitButtonText").show();$(".loginFormSubmitButtonImage").hide();$(".loginbox .message").html("Password has successfully been updated ");$(".loginbox .message").show()};CommunicationHandler.prototype.updatePasswordfailHandler=function(){$(".message").html("Something Went Wrong Passowrd not updated ");$(".message").show()};CommunicationHandler.prototype.forgotPasswordResponseHandler=function(a){$("#updatePasswordRow").show();$("#updatePasswordRow input").attr("required","required");$("#forgotPasswordRow input").removeAttr("required");$("#forgotPasswordRow").hide();$("#loginRow input").removeAttr("required");$("#loginRow").hide();$(".message").hide();$("#codedata").val("");$("#newpassword").val("");$("#repeatnewpassword").val("");$("#actionValue").val("update")};CommunicationHandler.prototype.forgotPasswordFailedHandler=function(a){user=null;username=null;$(".loginbox .message").html("Your password request was not successful, please try again to enter valid data.<br>If you do not have a user name yet contact awamo support to register a new account. If you already have a user name, please check the spelling or contact awamo support.");$(".loginbox .message").show();$(".loginFormSubmitButtonText").show();$(".loginFormSubmitButtonImage").hide()};CommunicationHandler.prototype.sidebarNavigationHandler=function(f){f.preventDefault();$("#messagebox").stop().slideUp(500);var c=function(i){var h=350;var j=i.attr("id");var e=i.parent().find('.subitem[data-parent!="'+j+'"]');e.each(function(l,k){$(k).animate({height:"0"},h,function(){$(k).addClass("hidden")})});var e=i.parent().find('[data-parent="'+j+'"]');e.each(function(l,k){$(k).removeClass("hidden");if("reporting"===j&&$(k).data("action")==="keyPerformanceIndicators"&&"SHOWROOM"!==tenantId.toUpperCase()){$(k).addClass("hidden")}$(k).animate({height:$(k).css("max-height")},h)})};var g=$(this);$(".sidebar .nav li.active").removeClass("active");g.addClass("active");if(g.hasClass("parentitem")){c(g)}else{if(g.hasClass("subitem")){c($("#"+g.data("parent")))}}var b=g.data("handler");var d=g.data("action");var a=g.data("args");if(exists(b)&&exists(d)){handlers[b][d](a)}};CommunicationHandler.prototype.handleMainMenu=function(){var d=$(this);var b=d.data("handler");var c=d.data("action");var a=d.data("args");if(exists(b)&&exists(c)){handlers[b][c](a)}};CommunicationHandler.prototype.showProfile=function(){addHistory("Profile","#userProfile","#profile");var c=$(".sidebar .nav li.active");var d=c.attr("id");var a=c.parent().find('.subitem[data-parent="'+d+'"]');a.each(function(f,e){$(e).animate({height:"0"},CommunicationHandler.SPEED,function(){$(e).addClass("hidden")})});c.removeClass("active");initDefaultContent("User Profile");$("#profilePanel .panel-heading span").text(user.fullname);var b=$("#profileArea");$("#cancelProfileBottom").hide();$("#backProfileBottom").show();$("#confirmProfileBottom").hide();$("#editProfileBottom").show();b.find("input[data-target]").each(function(){$(this).val(getTargetFromObject($(this),user))});$("#profileGender").val(user.officerMasterData.gender);if(user.officerMasterData.nationality!==null){$("#profileNationality").val(user.officerMasterData.nationality.toLowerCase())}if(user.officerMasterData.iddocumenttype!==null){$("#profileIdT").val(user.officerMasterData.iddocumenttype)}if(user.officerMasterData.birthdate!==null){$("#profileBirthdate").val(formatDate(user.officerMasterData.birthdate))}$("#singleActions a").off("click touch");$("#singleActions a").on("click touch",CommunicationHandler.prototype.actionButtonHandler);$("#singleActions a[data-action]").hide();$('#singleActions a[data-action="back"]').hide();$('#singleActions a[data-action="submit"]').hide();$('#singleActions a[data-action="resetChanges"]').hide();showContent($("#singleActions"));showContent(b)};CommunicationHandler.prototype.showAccount=function(){addHistory("account","#tenantAccount","#tenantAccount");initDefaultContent("Account");$("#accountPanel .panel-heading span").text(tenant.name);var a=$("#accountArea");a.find("input[data-target]").each(function(){$(this).val(getTargetFromObject($(this),tenant))});showContent(a)};CommunicationHandler.prototype.help=function(){clearExportButtons();$("#syncNow").off("click touch");$("#syncNow").attr("title","Nothing to sync");$("#printNow").off("click touch");$("#printNow").hide();addHistory("Help","#help","#help");$("#nameC").val("");$("#nameC").val(user.fullname);$("#emailC").val("");$("#emailC").val(user.email);$("#phoneNumberC").val("");$("#phoneNumberC").val(user.officerMasterData.phone1);initDefaultContent("Help");registerKeyPressValidators($("#helpMessageForm"));populatePhoneInputFlagAddon($("#phoneNumberC"),$("#phoneNumberCCountryBtn"),$("#phoneNumberCCountryList"));showContent($("#helpOverview"))};CommunicationHandler.prototype.logout=function(){ajax("/tenant/v1d/mis/logout","POST",undefined,undefined,undefined,undefined,undefined);location.reload()};CommunicationHandler.prototype.about=function(){addHistory("About","#about","#about");initDefaultContent("About");$("h4.sub-header").html('<p id="aboutLink">Please visit our <a href="http://www.awamo.com" target="_blank">website</a> to get more information about awamo.</p>');$("h4.sub-header").show()};CommunicationHandler.prototype.sendMessage=function(){if(validateForm($("#helpMessageForm"))){showLoader("Validating phone input");validatePhoneInput(("#phoneNumberC"),function(){hideLoader();if(document.getElementById("nameC").checkValidity()&&document.getElementById("phoneNumberC").checkValidity()&&document.getElementById("emailC").checkValidity()&&document.getElementById("messageC").checkValidity()&&document.getElementById("subjectC").checkValidity()){headers={tenantId:tenantId};var b="/tenant/v1d/mis/contactForm";var a='{"name":"'+$("#nameC").val()+'","phone":"'+$("#phoneNumberC").val()+'","email":"'+$("#emailC").val()+'","message":"'+$("#messageC").val()+'","subject":"'+$("#subjectC").val()+'"}';clientList.showLoading();ajax(b,"POST",CommunicationHandler.prototype.messageSentResponseHandler,a,headers,CommunicationHandler.prototype.messageSentFailedResponseHandler)}},function(){hideLoader();showAlertMessage("Invalid Phone input",AlertTypes.danger)})}else{showAlertMessage("Please ensure all the fields are filled in correctly.",AlertTypes.danger)}};CommunicationHandler.prototype.messageSentResponseHandler=function(a){document.getElementById("nameC").value="";document.getElementById("phoneNumberC").value="";document.getElementById("emailC").value="";document.getElementById("messageC").value="";clientList.hideLoading();showAlertMessage("Message Sent Successfully",AlertTypes.success);DashboardHandler.prototype.overview()};CommunicationHandler.prototype.messageSentFailedResponseHandler=function(a){clientList.hideLoading();showAlertMessage("Error "+esponse.responseJSON.message,AlertTypes.warning)};CommunicationHandler.prototype.actionButtonHandler=function(a){a.preventDefault();hideContent();switch($(this).data("action")){case"back":history.back();break;case"resetChanges":break;case"submit":break;default:break}};CommunicationHandler.prototype.resetProfileParameter=function(){$("#profilePhone").val($("#profilePhoneHidden").val());$("#profilePhone1").val($("#profilePhoneHidden1").val());$("#profileEmail").val($("#profileEmailHidden").val());$("#profileGender").val($("#profileGenderHidden").val());$("#profileBirthdate").val($("#profileBirthdateHidden").val());$("#profileNationality").val($("#profileNationalityHidden").val());$("#profileIdT").val($("#profileIdTHidden").val());$("#profileIdN").val($("#profileIdNHidden").val());$("#profileBirthdate").val(formatDate($("#profileBirthdateHidden").val()));CommunicationHandler.prototype.showProfile()};CommunicationHandler.prototype.backProfileParameter=function(){handlers.Dashboard.overview()};CommunicationHandler.prototype.editProfileParameter=function(){showAlertMessage("Unfortunately you cannot edit your profile right now",AlertTypes.info)};CommunicationHandler.prototype.submitProfileParameter=function(){if(document.getElementById("profilePhone").checkValidity()&&document.getElementById("profilePhone1").checkValidity()&&document.getElementById("profileEmail").checkValidity()&&document.getElementById("profileBirthdate").checkValidity()&&document.getElementById("profileGender").checkValidity()&&document.getElementById("profileIdT").checkValidity()&&document.getElementById("profileIdN").checkValidity()&&document.getElementById("profileNationality").checkValidity()){ajax("/officer/v1d/"+user.officerMasterData.awamoId,"GET",function(b){if($("#profileGender").val()!=="NULL"){b.gender=$("#profileGender").val()}b.email=$("#profileEmail").val();b.phone1=$("#profilePhone").val();b.phone2=$("#profilePhone1").val();if($("#profileNationality").val()!=="NULL"){b.nationality=$("#profileNationality").val().toUpperCase()}if($("#profileBirthdate").datepicker("getDate")!==null){b.birthdate=$("#profileBirthdate").datepicker("getDate").getTime()}b.iddocumenttype=$("#profileIdT").val();b.iddocument=$("#profileIdN").val();var c=b;console.log(b);var a='{"iddocument":"'+b.iddocument+'","iddocumenttype":"'+b.iddocumenttype+'","birthdate":"'+b.birthdate+'","nationality":"'+b.nationality+'","phone2":"'+b.phone2+'","phone1":"'+b.phone1+'","email":"'+b.email+'","gender":"'+b.gender+'","awamoId":"'+b.awamoId+'","firstname":"'+b.firstname+'","lastname":"'+b.lastname+'","submitDate":"'+b.submitDate+'","location":"'+b.location+'"}';ajax("/officer/v1d/update","POST",function(d){user.officerMasterData.gender=c.gender;user.officerMasterData.iddocumenttype=c.iddocumenttype;user.officerMasterData.iddocument=c.iddocument;user.officerMasterData.birthdate=c.birthdate;user.officerMasterData.nationality=c.nationality;user.officerMasterData.phone2=c.phone2;user.officerMasterData.phone1=c.phone1;user.officerMasterData.email=c.email;user.officerMasterData.submitDate=c.submitDate;CommunicationHandler.prototype.showProfile();message("Success","Data updated Successfully",MessageType.SUCCESS)},a,getAuthenticationHeader(),function(d){console.log(d);$("#profilePhone").val($("#profilePhoneHidden").val());$("#profilePhone1").val($("#profilePhoneHidden1").val());$("#profileEmail").val($("#profileEmailHidden").val());$("#profileGender").val($("#profileGenderHidden").val());$("#profileBirthdate").val($("#profileBirthdateHidden").val());$("#profileNationality").val($("#profileNationalityHidden").val());$("#profileIdT").val($("#profileIdTHidden").val());$("#profileIdN").val($("#profileIdNHidden").val());$("#profileBirthdate").val(formatDate($("#profileBirthdateHidden").val()));CommunicationHandler.prototype.showProfile();message("Warning"," Please fill all fields before Submitting",MessageType.WARNING)})},null,getAuthenticationHeader(),function(a){console.log(a);$("#profilePhone").val($("#profilePhoneHidden").val());$("#profilePhone1").val($("#profilePhoneHidden1").val());$("#profileEmail").val($("#profileEmailHidden").val());$("#profileGender").val($("#profileGenderHidden").val());$("#profileBirthdate").val($("#profileBirthdateHidden").val());$("#profileNationality").val($("#profileNationalityHidden").val());$("#profileIdT").val($("#profileIdTHidden").val());$("#profileIdN").val($("#profileIdNHidden").val());$("#profileBirthdate").val(formatDate($("#profileBirthdateHidden").val()));CommunicationHandler.prototype.showProfile();message("Warning"," Please fill all fields before Submitting",MessageType.WARNING)})}};CommunicationHandler.prototype.documentTypeSelectHandler=function(){if(document.getElementById("profileIdT").value!=="NONE"){document.getElementById("profileIdN").required=true;document.getElementById("profileIdN").disabled=false}else{document.getElementById("profileIdN").required=false;document.getElementById("profileIdN").disabled=true;document.getElementById("profileIdN").value=""}};