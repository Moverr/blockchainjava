var currentChangedFil="ALL";var transactionsFromDate="0";var transactionsToDate="999999999999999";var ReportingHandler=function(){ReportingHandler.self=this;ReportingHandler.self.portFolioData=[];loanList.addDataModelChangedEventListenerCallback(ReportingHandler.prototype.dataModelChanged);savingsAccountList.addDataModelChangedEventListenerCallback(ReportingHandler.prototype.dataModelChanged);$("#TransactionsAccountReportTypeForm select").on("input",ReportingHandler.prototype.genericTransactionReportSelectHandler);ReportingHandler.self.pieChartConfig={series:{pie:{radius:0.7,innerRadius:0.3,show:true,stroke:{color:"rgba(255,255,255,1.0)",width:0},highlight:{opacity:0.25},offset:{top:0,left:0},label:{show:true,radius:3/4,formatter:function(a,b){return'<div style="border:1px solid grey;font-size:8pt;text-align:center;padding:5px;color:white;">'+a+" : "+Math.round(b.percent)+"%</div>"},background:{opacity:0.5,color:"#000"}},combine:{color:"#999",threshold:0.05}}},legend:{show:false},grid:{hoverable:true,clickable:true},tooltip:{show:true,content:"%p.0%, %s, n=%n",shifts:{x:20,y:0},defaultTheme:false}};this.commandStack=[];this.argumentStack=[]};function drawChart(b,e){var g=b.length;var f=new google.visualization.DataTable();f.addColumn("string","Topping");f.addColumn("number","Slices");b=sortAssociateArray(b);for(var a=0;a<g;a++){f.addRow([""+b[a].label,b[a].data])}var c={tooltip:{isHtml:true},pieHole:0.4,legend:{position:"bottom",alignment:"end"},colors:["#006600","#078e07","#1baa2f","#66cc00","#81fe04","#404041","#666666","#9e9a9a","#bcbbbb","#e5e1e1","#025b5a","#059da6","#02c5d0","#97d9ff"]};var d=new google.visualization.PieChart(document.getElementById("panel-body-"+e));google.visualization.events.addListener(d,"error",function(h){console.log("The chart error:",h)});d.draw(f,c);add_extended_data(b,e)}add_extended_data=function(f,d){var e="<div class=' row col-md-6  panel-body-"+d+"-details' id='panel-body-"+d+"-details'>";e+=" <ul class='nav' style='width:80%; margin:auto; list-style:circle;' > ";var c=0;for(var a=0;a<f.length;a++){c+=f[a].data}for(var a=0;a<f.length;a++){var b=(calcuate_percentage(c,f[a].data));if(b>0){e+=" <li>  <strong style='text-transform: uppercase;'>"+f[a].label+" : </strong> "+b+"% </li>"}}e+=" </ul> ";e+="</div>";$(e).insertAfter("#panel-body-"+d).fadeOut("slow")};google.charts.load("current",{packages:["corechart"]});ReportingHandler.prototype.drawGoogleChart=function(b,a){google.charts.load("current",{packages:["corechart"]});google.charts.setOnLoadCallback(drawChart(b,a))};ReportingHandler.TRANSACTION_TITLES={transactionDate:"Date",accountType:"Account type",amount:"Amount",transactionType:"Transaction type",balance:"Balance"};ReportingHandler.KPI_TITLES={kpi:"Indicator",value:"Value"};ReportingHandler.MAX_TRANSACTION_AGE=2592000000;ReportingHandler.prototype.overview=function(){addHistory("Reporting overview","#reportingOverview","#reporting a");initDefaultContent("Reporting");currentTable="reporting";clearExportButtons();$("#syncNow").off("click touch");$("#syncNow").attr("title","Nothing to sync");$("#printNow").off("click touch");$("#printNow").hide();var l=getDefaultRowContainer({type:"Items Available"});var k=[];var b=savingsAccountList.getEntities();var c=b.length;for(var g=0;g<c;g++){var a=b[g];var m=a.transactionList;if(exists(m)){var n=m.length;for(var e=0;e<n;e++){if(Date.now()-m[e].transactionDate<ReportingHandler.MAX_TRANSACTION_AGE){k.push(m[e])}}}}var h=loanList.getEntities();var d=h.length;for(var g=0;g<d;g++){var f=h[g];var m=f.transactionList;if(exists(m)){var n=m.length;for(var e=0;e<n;e++){if(Date.now()-m[e].transactionDate<ReportingHandler.MAX_TRANSACTION_AGE){k.push(m[e])}}}}if(handlers.Permissions.check_access("_VIEW_PORTFOLIO_ANALYSIS")){addRow(l,{type:"Portfolio Analysis"},"Reporting",ReportingHandler.self.rowClickHandler,"collectPortfolioData")}if(handlers.Permissions.check_access("_VIEWKEYPERFORMANCEINDICATOR")){if(handlers.Permissions.check_access("_VIEW_CLIENTS")){addRow(l,{type:"Clients"},"Client",ReportingHandler.self.rowClickHandler,"getAll")}}if(handlers.Permissions.check_access("_VIEW_LOANS")){addRow(l,{type:"Loans"},"Loan",ReportingHandler.self.rowClickHandler,"firstGenericLoanReportsForReporting")}if(handlers.Permissions.check_access("_MANAGE_SAVINGS_ACCOUNTS")){addRow(l,{type:"Savings Accounts"},"SavingsAccount",ReportingHandler.self.rowClickHandler,"getAllForReporting")}if(handlers.Permissions.check_access("_MANAGE_TRANSACTIONS")){addRow(l,{type:"Transactions"},"Reporting",ReportingHandler.self.rowClickHandler,"getTransactions")}};ReportingHandler.prototype.getTransactions=function(){hideContent();addHistory("Reporting transactions","#reportingTransactions",getSidebarSubitemSelector("reporting","Reporting","getTransactions"));initDefaultContent("");currentTable="transactions";$("#TransactionsAccountReportType").show();$("#TransactionsAccountReportTypeForm").show();document.getElementById("TransactionsAccountReportType").selectedIndex="0";currentChangedFil="ALL";$.datepicker._clearDate($("#tToDatePicker"));$.datepicker._clearDate($("#tFromDatePicker"));transactionsFromDate="0";transactionsToDate="999999999999999";ReportingHandler.self.showTransactions()};ReportingHandler.prototype.showTransactions=function(){var k=getDefaultRowContainer(ReportingHandler.TRANSACTION_TITLES,true);var g=k.parent();var s=[];var f=savingsAccountList.getEntities();var h=f.length;for(var q=0;q<h;q++){var l=f[q];var o=l.transactionList;if(exists(o)){var d=o.length;for(var p=0;p<d;p++){if(Date.now()-o[p].transactionDate<ReportingHandler.MAX_TRANSACTION_AGE){if(currentChangedFil==="ALL"){if(o[p]["transactionDate"]<transactionsToDate&&o[p]["transactionDate"]>transactionsFromDate){s.push(o[p])}}else{if(currentChangedFil===o[p]["transactionType"]){if(o[p]["transactionDate"]<transactionsToDate&&o[p]["transactionDate"]>transactionsFromDate){s.push(o[p])}}}}}}}var t=loanList.getEntities();var u=t.length;for(var q=0;q<u;q++){var b=t[q];var o=b.transactionList;if(exists(o)){var d=o.length;for(var p=0;p<d;p++){if(Date.now()-o[p].transactionDate<ReportingHandler.MAX_TRANSACTION_AGE){if(currentChangedFil==="ALL"){if(o[p]["transactionDate"]<transactionsToDate&&o[p]["transactionDate"]>transactionsFromDate){s.push(o[p])}}else{if(currentChangedFil===o[p]["transactionType"]){if(o[p]["transactionDate"]<transactionsToDate&&o[p]["transactionDate"]>transactionsFromDate){s.push(o[p])}}}}}}}var n=s.length;for(var q=0;q<n;q++){var r=s[q];var a=ReportingHandler.prototype.getTransactionRowData(r);addRow(k,a,r)}$("#tableTotal").text(n);showContent($("#tableTotalSum"));var m=getDefaultTableSorter();m.headers={0:{sorter:"awamoDateSorter"},2:{sorter:"awamoCurrencySorter"},4:{sorter:"awamoCurrencySorter"}};initialize_datatable(g);var c=document.getElementById("defaultTableContainer").getElementsByTagName("table");for(var q=0;q<c.length;q++){c[q].style.textAlign="right"}addClassToTableColumn(g,0,"currency");addClassToTableColumn(g,2,"currency");addClassToTableColumn(g,4,"currency");if(handlers.Permissions.check_access("_EXPORT_TRANSACTIONS")){var e=$("#defaultTableContainer").tableExport();e.tableExport.update({formats:["xls","xlsx"],fileName:"Transactions",headings:true})}$("#hiddenPrintedTitle").val("Transactions Report");showPrintButton(exportListName.transactions,exportListFilter.all,ReportingHandler.TRANSACTION_TITLES);showExcelButton(exportListName.transactions,exportListFilter.all,ReportingHandler.TRANSACTION_TITLES)};ReportingHandler.prototype.getTransactionRowData=function(c){var d={};for(var a in ReportingHandler.TRANSACTION_TITLES){var b=c[a];switch(a){case"accountType":if(exists(c.accountId)){b="savings account"}else{if(exists(c.loanId)){b="loan account"}else{b="unknown"}}break;case"transactionDate":b=formatDate(b);break;case"amount":case"balance":b=exists(b)?formatCurrency(b)+" "+currencyCode:"---";break;default:break}d[a]=String(b)}return d};ReportingHandler.prototype.rowClickHandler=function(){var b=$(this).data("id");var a=$(this).data("object");$('li[data-parent~="reporting"][data-handler="'+a+'"][data-action~="'+b+'"] a').click()};ReportingHandler.prototype.reporting_type="number";ReportingHandler.prototype.changePortfolioType=function(){ReportingHandler.self.reporting_type=$("#portfolioReportTypeForm").find(":selected").val();ReportingHandler.self.createLoansByHealthChart();ReportingHandler.self.createLoansByAgeChart();ReportingHandler.self.createLoansBySexChart();ReportingHandler.self.createLoansBySectorChart()};ReportingHandler.prototype.collectPortfolioData=function(){console.log("in collect portfolio data");console.log(ReportingHandler.self.portFolioData);if(ReportingHandler.self.portFolioData===null||ReportingHandler.self.portFolioData==="undefined"||ReportingHandler.self.portFolioData.length<1){console.log("in collect portfolio data, fetch data");var a="/loan/v1d/loanReports";var b=getAuthenticationHeader();$.ajax({url:host+a,dataType:"json",contentType:"application/json; charset=utf-8",headers:b,type:"GET",beforeSend:function(){showLoader("Loading Portfolio Data . . .")},success:function(c){console.log("response");console.log(c);if(c){if(c.length>0){ReportingHandler.self.portFolioData=c;ReportingHandler.prototype.getPortfolio()}else{hideLoader();showAlertMessage("An error occured while retrieving portfolio details, Please try again.",AlertTypes.danger)}}else{hideLoader();showAlertMessage("An error occured while retrieving portfolio details, Please try again.",AlertTypes.danger)}},complete:function(){hideLoader()}}).fail(function(c){console.log("fail response");console.log(c);hideLoader();showAlertMessage("An error occured while retrieving portfolio details, Please try again.",AlertTypes.danger)})}else{console.log("in collect portfolio data, no need to fetch data");ReportingHandler.prototype.getPortfolio()}};ReportingHandler.prototype.getPortfolio=function(){clearExportButtons();$("#syncNow").off("click touch");$("#syncNow").attr("title","Nothing to sync");$("#printNow").off("click touch");$("#printNow").hide();addHistory("Reporting portfolio","#reportingPortfolio",getSidebarSubitemSelector("reporting","Reporting","collectPortfolioData"));initDefaultContent("Portfolio");var a=$("#portfolioArea");showContent(a);ReportingHandler.self.reporting_type="number";$("#portfolioReportTypeForm").off();$("#portfolioReportTypeForm").on("change",ReportingHandler.self.changePortfolioType);ReportingHandler.self.createLoansByHealthChart();ReportingHandler.self.createLoansByAgeChart();ReportingHandler.self.createLoansBySexChart();ReportingHandler.self.createLoansBySectorChart()};ReportingHandler.prototype.getPorfolioDetailsFromServerReport=function(a){var b=[];$.each(ReportingHandler.self.portFolioData,function(c,d){switch(d.reportName){case"LOANS-AGE-REPORT-BY-AMOUNT":if(d.reportName===a){b=d.reportDetails}break;case"LOANS-AGE-REPORT-BY-NUMBERS":if(d.reportName===a){b=d.reportDetails}break;case"LOANS-EMPLOYEMENT-SECTOR-REPORT-BY-AMOUNT":if(d.reportName===a){b=d.reportDetails}break;case"LOANS-EMPLOYEMENT-SECTOR-REPORT-BY-NUMBERS":if(d.reportName===a){b=d.reportDetails}break;case"LOANS-GENDER-REPORT-BY-AMOUNT":if(d.reportName===a){b=d.reportDetails}break;case"LOANS-GENDER-REPORT-BY-NUMBERS":if(d.reportName===a){b=d.reportDetails}break;case"LOANS-HEALTH-REPORT-BY-AMOUNT":if(d.reportName===a){b=d.reportDetails}break;case"LOANS-HEALTH-REPORT-BY-NUMBER":if(d.reportName===a){b=d.reportDetails}break;default:break}if(b.length>0){return}});return b};ReportingHandler.prototype.createLoansByHealthChart=function(){var b;var c=[];if(ReportingHandler.self.reporting_type==="number"){c=ReportingHandler.prototype.getPorfolioDetailsFromServerReport("LOANS-HEALTH-REPORT-BY-NUMBER");console.log("health reports by number");console.log(c)}else{if(ReportingHandler.self.reporting_type==="amount"){c=ReportingHandler.prototype.getPorfolioDetailsFromServerReport("LOANS-HEALTH-REPORT-BY-AMOUNT");console.log("health reports by amount");console.log(c)}}var a=[];$.each(c,function(d,e){a.push({label:e.key,data:e.value})});ReportingHandler.prototype.loansByHealthChart=ReportingHandler.prototype.drawGoogleChart(a,"loansByHealth")};ReportingHandler.prototype.createLoansByAgeChart=function(){var f={sector0:"< 26",sector1:"26 - 35",sector2:"36 - 45",sector3:"46 - 55",sector4:"> 55"};var c={sector0:0,sector1:0,sector2:0,sector3:0,sector4:0};var e=loanList.getEntities();var b=e.length;var d=[];if(ReportingHandler.self.reporting_type==="number"){d=ReportingHandler.prototype.getPorfolioDetailsFromServerReport("LOANS-AGE-REPORT-BY-NUMBERS");console.log("age reports by number");console.log(d)}else{if(ReportingHandler.self.reporting_type==="amount"){d=ReportingHandler.prototype.getPorfolioDetailsFromServerReport("LOANS-AGE-REPORT-BY-AMOUNT");console.log("age reports by amount");console.log(d)}}var a=[];$.each(d,function(g,h){a.push({label:h.key,data:h.value})});ReportingHandler.prototype.loansByHealthChart=ReportingHandler.prototype.drawGoogleChart(a,"loansByAge")};ReportingHandler.prototype.createLoansBySexChart=function(){var c={male:0,female:0};var e=loanList.getEntities();var b=e.length;var d=[];if(ReportingHandler.self.reporting_type==="number"){d=ReportingHandler.prototype.getPorfolioDetailsFromServerReport("LOANS-GENDER-REPORT-BY-NUMBERS");console.log("gender reports by number");console.log(d)}else{if(ReportingHandler.self.reporting_type==="amount"){d=ReportingHandler.prototype.getPorfolioDetailsFromServerReport("LOANS-GENDER-REPORT-BY-AMOUNT");console.log("gender reports by amount");console.log(d)}}var a=[];$.each(d,function(f,g){a.push({label:g.key,data:g.value})});ReportingHandler.prototype.loansByHealthChart=ReportingHandler.prototype.drawGoogleChart(a,"loansBySex")};ReportingHandler.prototype.createLoansBySectorChart=function(){var a=[];var b;var c=[];if(ReportingHandler.self.reporting_type==="number"){c=ReportingHandler.prototype.getPorfolioDetailsFromServerReport("LOANS-EMPLOYEMENT-SECTOR-REPORT-BY-NUMBERS");console.log("sector reports by number");console.log(c)}else{if(ReportingHandler.self.reporting_type==="amount"){c=ReportingHandler.prototype.getPorfolioDetailsFromServerReport("LOANS-EMPLOYEMENT-SECTOR-REPORT-BY-AMOUNT");console.log("sector reports by amount");console.log(c)}}$.each(c,function(d,e){a.push({label:e.key,data:e.value})});ReportingHandler.prototype.loansByHealthChart=ReportingHandler.prototype.drawGoogleChart(a,"loansBySector")};ReportingHandler.prototype.dataModelChanged=function(a){};ReportingHandler.prototype.labelFormatter=function(a,b){return'<div style="font-size:12px; text-align:center; padding:4px; color: #333333; background-color: '+b.color+'; border: solid 1px #000000">'+a+"<br/>"+Math.round(b.percent)+"%</div>"};ReportingHandler.prototype.getClientMap=function(){addHistory("Geo Information","#geoInformation","#getClientMap a");initDefaultContent("Geo Information");showContent($("#geoInformationArea"));currentTable=null;var e=clientList.getEntities();var a={center:new google.maps.LatLng(8.7832,34.5085),zoom:4,mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:true,mapTypeControl:false,panControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER},zoomControl:true,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.RIGHT_CENTER},scaleControl:false,streetViewControl:false,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER}};var d=new google.maps.Map(document.getElementById("geoInformationMap"),a);var c=new google.maps.LatLngBounds();var b=0;e.forEach(function(f){if(exists(f.location)){if(f.location.latitude!==0&&f.location.longitude!==0){var g={lat:f.location.latitude,lng:f.location.longitude};c.extend(new google.maps.LatLng(f.location.latitude,f.location.longitude));b=b+1;new google.maps.Marker({position:g,map:d})}}});if(b>0){d.fitBounds(c)}};ReportingHandler.prototype.performance_indicators=function(){ReportingHandler.self.keyPerformanceIndicators()};ReportingHandler.prototype.keyPerformanceIndicators=function(){addHistory("Key Performance Indicators","#keyPerformanceIndicators",getSidebarSubitemSelector("reporting","Reporting","keyPerformanceIndicators"));initDefaultContent("Key Performance Indicators");ReportingHandler.self.stack(ReportingHandler.prototype.keyPerformanceIndicators);var a=getDefaultRowContainer(ReportingHandler.KPI_TITLES);var b=a.parent();var c=[{kpi:"Return on assets",value:10},{kpi:"Return on equity",value:12}];c.forEach(function(d){addRow(a,ReportingHandler.prototype.getKPIRowData(d))});b.tablesorter(getDefaultTableSorter());addClassToDefaultTableColumn(3,"currency")};ReportingHandler.prototype.getKPIRowData=function(c){var d={};for(var a in ReportingHandler.KPI_TITLES){var b=c[a];switch(a){case"code":if(c.glCode%1000===0){b="<b>"+c.glCode+"</b"}else{if(c.glCode%100===0){b="&emsp;&emsp;"+c.glCode}else{b="&emsp;&emsp;&emsp;&emsp;"+c.glCode}}break;case"name":if(c.glCode%1000===0){b="<b>"+c.name+"</b"}else{if(c.glCode%100===0){b="&emsp;&emsp;"+c.name}else{b="&emsp;&emsp;&emsp;&emsp;"+c.name}}break;case"balance":b=formatCurrency(this._sumOfJournal(c))+" "+currencyCode;break;default:break}d[a]=String(b)}return d};ReportingHandler.prototype.stack=function(b,a){ReportingHandler.self.commandStack.push(b);ReportingHandler.self.argumentStack.push(a)};ReportingHandler.prototype.back=function(){ReportingHandler.self.commandStack.pop()(ReportingHandler.self.argumentStack.pop())};ReportingHandler.prototype.genericTransactionReportSelectHandler=function(){switch($(this).val()){case"ALL":currentChangedFil="ALL";break;case"DEPOSIT":currentChangedFil="DEPOSIT";break;case"WITHDRAWAL":currentChangedFil="WITHDRAWAL";break;case"DISBURSEMENT":currentChangedFil="DISBURSEMENT";break;case"REPAYMENT":currentChangedFil="REPAYMENT";break;default:break}ReportingHandler.prototype.showTransactions()};$(".export").on("click touch",function(){var a=$(this).data("attr");var b=$(this).data("contentid");var c=$(this).closest(".panel-heading").children(".header").html();exportArea(a,b,c)});