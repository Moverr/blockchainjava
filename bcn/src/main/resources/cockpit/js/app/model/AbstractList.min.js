var totalListCounts=0;var totalListLeft=0;var percentageLoaded=0;var totalLists=0;var progressLoaded=false;var failedRequests=[];var retries=0;function AbstractList(){this.mainIds=[];this.entityMap={};this.entityArray=[];this.dataModelChangedEventListenerCallbacks=[];this.entityChangedEventListenerCallbacks=[];this.callbacks={};this.reloadIds=[];this.reloadInProgress=false;this.totalServerCount=0;this.tempTotalServerCount=0;this.syncInProgress=false}AbstractList.prototype={rootPath:null,alternativeGetAllLoansUrl:null,defaultPageSize:null,storagePrefix:null,constructor:AbstractList,initLocal:function(a){this.loadAllFromLocal(a)},init:function(a){progressLoaded=false;totalLists=a.length+1;var c=[];a.forEach(function(d){c.push(d)});this.initLocal(c);if(!this.updated){this.updated=true;showProgress(false,true,0,b);this.loadAllAtOnce(a);var b=this;this.reloadTimer=window.setInterval(function(){},1000*60*60)}},reload:function(){progressLoaded=false;this.syncInProgress=true;this.loadAllAtOnce()},get:function(b,a){if(!exists(this.entityMap[b])){a(this.entityMap[b])}else{a(this.entityMap[b])}},getTotalCount:function(){return this.mainIds.length},getMainIds:function(){return this.mainIds},getEntities:function(){return this.entityArray},hideLoading:function(){hideLoader()},showLoading:function(){showLoader()},addDataModelChangedEventListenerCallback:function(a){this.dataModelChangedEventListenerCallbacks.push(a)},removeDataModelChangedEventListenerCallback:function(a){var b=this.dataModelChangedEventListenerCallbacks.indexOf(a);if(b>-1){this.dataModelChangedEventListenerCallbacks.splice(b,1)}},addEntityChangedEventListenerCallback:function(a){this.entityChangedEventListenerCallbacks.push(a)},removeEntityChangedEventListenerCallback:function(b){var a=this.entityChangedEventListenerCallbacks.indexOf(b);if(a>-1){this.entityChangedEventListenerCallbacks.splice(a,1)}},store:function(b){b=this.enrich(b);if(!exists(b)){return}var d=eventtype.CREATE;var a=this.entityArray.length;var c=0;for(;c<a;c++){if(this.entityArray[c].mainId===b.mainId){if(this.equals(this.entityArray[c],b)){d=eventtype.UNCHANGED}else{d=eventtype.UPDATE}break}}if(d!==eventtype.UNCHANGED){if(!this.mainIds.includes(b.mainId)){this.mainIds.push(b.mainId)}this.entityMap[b.mainId]=b;this.entityArray[c]=b;if(typeof(Storage)!=="undefined"){try{localStorage.setItem(this.storagePrefix+b.mainId,JSON.stringify(b))}catch(e){console.log(JSON.stringify(e))}}this.notifyEntityChangedListener(b,d);this.notifyDataModelChangedListener();ActionRequiredHandler.prototype._dataModelChanged()}},loadOne:function(c,b){this.callbacks[c]=[b];var a=this;ajax(this.rootPath+c,"GET",function(d){hideLoader();console.log(d);a.put(a,d);try{var f=a.callbacks[c].pop();while(exists(f)){f(d);f=a.callbacks[c].pop()}}catch(e){console.log(e)}delete a.callbacks[c]},null,undefined,function(d){hideLoader();if(d.status===0){console.log("Network lost");showAlertMessage("Network Lost , please reload your page and try again",AlertTypes.warning)}console.error(d);manageErrors(d)},function(){hideLoader()})},loadAllFromLocal:function(b){if(typeof(Storage)!=="undefined"){for(var e=0,a=localStorage.length;e<a;++e){var d=localStorage.key(e);if(d.startsWith(this.storagePrefix)){var g=localStorage.getItem(d);var c=JSON.parse(g);this.store(c)}}if(Array.isArray(b)){var f=b.shift();if(exists(f)){f.initLocal(b)}}}},loadAll:function(b){var h=[];if(typeof(Storage)!=="undefined"){for(var f=0,a=localStorage.length;f<a;++f){var e=localStorage.key(f);if(e.startsWith(this.storagePrefix)){var g=localStorage.getItem(e);var d=JSON.parse(g);h.push(d.mainId);this.store(d)}}}var c=this;ajax(this.rootPath+"mainIds/0?limit="+pageSize||-1,"GET",function(i){console.log("loaded main ids for "+c.entityName+" are "+i.length);h.forEach(function(j){if(!i.includes(j)){if(typeof(Storage)!=="undefined"){localStorage.removeItem(c.storagePrefix+j)}c.mainIds.remove(j);delete c.entityMap[j];c.entityArray=c.entityArray.filter(function(k){return k.mainId!==j});c.notifyDataModelChangedListener();c.notifyEntityChangedListener(j,eventtype.DELETE)}});i.sort(function(k,j){return parseInt(k)>parseInt(j)}).reverse();c.reloadIds=i;if(!c.reloadInProgress){c.loadNext(c,b)}})},loadNext:function(b,a){console.log("inside loadNext ");if(!exists(b.reloadIds)){console.log("self.reloadIds not exists ");return}var e=b.reloadIds.shift();if(exists(e)){b.reloadInProgress=true;var d=b.rootPath+e;if(b.entityName==="client"){d=b.rootPath+"get/full/"+e}console.log(b.entityName);console.log(d);ajax(d,"GET",function(f){b.put(b,f,b.loadNext,a)},undefined,undefined,function(f){if(f.status===0){console.log("Network lost")}console.error(f)},function(){console.log("using complete to calload next");b.loadNext(b,a)});b.loadNext(b,a)}else{b.reloadInProgress=false;if(Array.isArray(a)){var c=a.shift();if(exists(c)){c.init(a)}}}},loadNextList:function(b,a){if(Array.isArray(a)){var c=a.shift();if(exists(c)){b.reloadInProgress=true;c.loadAllAtOnce(a)}else{$body=$("body");$body.removeClass("loading")}}},getserverTotals:function(c,a,b){c.totalServerCount=0;if(c.totalServerCount===0){ajax(c.rootPath+"count","GET",function(e){var d="Loading Totals";var f=[];if(e>=0){c.tempTotalServerCount=e;c.totalServerCount=e;totalListCounts+=e;totalListLeft=totalListCounts;f.push("Added "+c.totalServerCount+" "+c.entityName+"s to total")}else{console.error("Loading Totals\nError, the server returned a negative total: "+e+"!!!")}f.push("The total entities to load are: "+totalListCounts);f.push("The pending entities are: "+totalListLeft);logColor="blue";logFancyMessage(d,f,logColor);b(c,a)},undefined,undefined,function(d){console.log(d)},function(){})}else{b(c,a)}},loadAllAtOnce:function(d,j){var a=[];var b=[];if(typeof(Storage)!=="undefined"){for(var f=0,h=localStorage.length;f<h;++f){var l=localStorage.key(f);if(l.startsWith(this.storagePrefix)){var k=localStorage.getItem(l);var e=JSON.parse(k);a.push(e.mainId);this.store(e)}}}var m=this;statusbar("Synchronizing "+m.entityName+"s,  please wait...");var c=function(o){var n=[];if(m.entityName==="account"){n.push(m.totalServerCount)}else{var s=m.defaultPageSize===null?pageSize:m.defaultPageSize;var q=Math.floor(o/s);var p=o%s;for(var r=0;r<q;r++){n.push(s)}if(p>0){n.push(p)}}return n};var g=c(m.totalServerCount);if(g.length===0){percentageLoaded=parseFloat((((totalListCounts-totalListLeft)/totalListCounts)*100).toFixed(1));if(percentageLoaded===0){statusbar("Sorry, nothing to load from the server");percentageLoaded=100}m.checkComplete(m);if(totalListLeft>0){m.loadNextList(m,d)}}g.forEach(function(i,p){var q=m.defaultPageSize===null?pageSize:m.defaultPageSize;var s=p*q;var o="";if(m.alternativeGetAllLoansUrl!==null){o=m.alternativeGetAllLoansUrl+"?awamoId=0&limit="+(i+1)+"&offset="+s}else{o=m.rootPath+"all?awamoId=0&limit="+i+"&offset="+s}var r=ajax(o,"GET",function(A,y,x){if(exists(A)){var u=m.entityName;var B=[];B.push(A.length+" "+m.entityName+"s returned from the server.");var w=i-A.length;if(m.entityName==="loan"){console.log("loan entities");console.log(A)}A.forEach(function(C){if(exists(C)){if(m.entityName==="loan"){console.log("startingloan ...........................................................");console.log("loan entity b4 push");console.log(C)}b.push(C.mainId);if(m.entityName==="loan"){console.log("loan entity b4 populate");console.log(C)}m.populate(m,C,null,null)}});var z="";if(m.tempTotalServerCount>0){z=m.tempTotalServerCount+" "+m.entityName+"s pending to load.";var v="yellow"}else{z="All "+m.entityName+"s loaded successfully!";var v="green"}B.push(z);statusbar("Synchronizing "+m.entityName+"s, "+z);console.log("The server return differences: ",w);logFancyMessage(u,B,v);if(w!==0){logFancyMessage(m.entityName,["The values returned by the server are out of sync, we requested {"+i+"} and {"+A.length+"} were returned"],"red");totalListLeft-=w}m.checkComplete(m)}},undefined,undefined,function(B,v,w){failedRequests.push({list:m,failedUrl:B.uniqueUrl,failedItems:i});var u=parseInt(B.pageSize||i);var C=parseFloat((((totalListCounts-totalListLeft)/totalListCounts)*100).toFixed(1));totalListLeft=totalListLeft-u;percentageLoaded=parseFloat((((totalListCounts-totalListLeft)/totalListCounts)*100).toFixed(1));var z=parseFloat(((u/totalListCounts)*100).toFixed(1));m.checkComplete(m);showProgressFailure(C,z);var A=m.entityName;var y=[];y.push(B.pageSize+" "+m.entityName+"s failed to return from the server.");var x="orange";logFancyMessage(A,y,x)},function(x,y,u){if(exists(j)){j()}var v="Loading Totals";var z=[];z.push("Subtracted "+i+" "+m.entityName+"s from total");z.push("The total entities to load are: "+totalListCounts);z.push("The pending entities are: "+totalListLeft);var w="teal";if(totalListLeft==0){z.push("Completed Successfully");w="lime"}logFancyMessage(v,z,w);if(!m.reloadInProgress){m.reloadInProgress=false;m.loadNextList(m,d)}});r.pageSize=i;r.entityName=m.entityName;r.uniqueUrl=o;r.offset=s;var n=m.entityName;var t=[];t.push("Request sent to server for {"+i+"} "+m.entityName+"s");logFancyMessage(n,t,"yellow")})},checkComplete:function(c){if(percentageLoaded===100){c.syncInProgress=false;hideLoader();if(failedRequests.length>0){var f=0;failedRequests.forEach(function(g){f+=g.failedItems});var b="";var e="";var a="";if(retries<3){b=f+" items didn't load successfully from the server.";e="Do you want to retry loading these items?";a="No";var d="Yes";showDialogPopupWithHandlers(b,e,d,function(){c.retry(f)},a,function(){})}else{b="You seem to have retried 3 times";e="Please use the Sync button later to synchronize your activities";a="Ok";showDialogPopupWithHandlers(b,e,d,function(){},a,function(){},true)}}else{if(totalListCounts>0){statusbar("Completed Successfully")}}}else{showProgress(false,false,percentageLoaded,c)}},retry:function(a){totalListCounts=a;totalListLeft=a;showProgress(false,true,0,self);failedRequests.forEach(function(c,b){var d=ajax(c.failedUrl,"GET",function(g,f,e){failedRequests.splice(b,1);if(exists(g)){g.forEach(function(h){if(exists(h)){c.list.populate(c.list,h,null,null)}})}},undefined,undefined,function(h,j,g){var e=c.failedItems;var i=parseFloat((((totalListCounts-totalListLeft)/totalListCounts)*100).toFixed(1));totalListLeft=totalListLeft-e;percentageLoaded=parseFloat((((totalListCounts-totalListLeft)/totalListCounts)*100).toFixed(1));var f=parseFloat(((e/totalListCounts)*100).toFixed(1));c.list.checkComplete(c.list);showProgressFailure(i,f)},function(f,g,e){})});retries++},populate:function(b,a,d,c){if(b.entityName==="loan"){console.log("populate loan");console.log(a);if("INDIVIDUAL"===a.loanType){clientList.get(a.awamoId,function(e){(function(g,f){if(exists(f)){g.client=f;g.ownerName=f.fullname}})(a,e)})}else{if("GROUP"===a.loanType){groupList.get(a.awamoId,function(e){(function(f,g){if(exists(g)){f.group=g;f.ownerName=g.name}})(a,e)})}}AbstractList.prototype.put(b,a,d,c);b.tempTotalServerCount--;totalListLeft--;percentageLoaded=parseFloat((((totalListCounts-totalListLeft)/totalListCounts)*100).toFixed(1));b.checkComplete(b);return}b.put(b,a,d,c);b.tempTotalServerCount--;totalListLeft--;percentageLoaded=parseFloat((((totalListCounts-totalListLeft)/totalListCounts)*100).toFixed(1));b.checkComplete(b)},put:function(j,d,h,c){if(j.entityName==="client"){var b=d;if(exists(d.loans)){b.loans.splice(b.loans.length,0)}if(exists(d.savingsAccount)){b.savingsAccount.splice(b.savingsAccount.length,0)}j.store(b);if(exists(d.loans)){for(var f=0,g=d.loans.length;f<g;f++){var e=d.loans[f];loanList.addOwner(loanList,e,null,null);loanList.store(e)}}if(exists(d.savingsAccount)){for(var f=0,g=d.savingsAccount.length;f<g;f++){var a=d.savingsAccount[f];savingsAccountList.addOwner(savingsAccountList,a,null,null);savingsAccountList.store(a)}}}else{if(j.entityName==="loan"){console.log("Putting Loan entity . . ."+d.loanId);console.log(d)}j.store(d)}if($.isFunction(h)){console.log("calling next in put");h(j,c)}},notifyDataModelChangedListener:function(){this.dataModelChangedEventListenerCallbacks.forEach(function(a){if(a){a()}})},notifyEntityChangedListener:function(a,b){this.entityChangedEventListenerCallbacks.forEach(function(c){if(c){c(a,b)}})},sorter:function(b,a){return b>a},equals:function(e,f){if(e===f){return true}if(!exists(e)||!exists(f)){return false}var j=Object.keys(e).sort();var a=Object.keys(f).sort();var h=j.length;var g=a.length;if(h!==g){return false}for(var d=0;d<h;d++){var b=j[d];var c=a[d];if(b!==c){return false}else{if(e[b]!==f[c]){return false}}}return true},getById:function(c){var b=function(d){return d.mainId===c};var a=this.getEntities().filter(b);if(a.length===1){return a[0]}return null}};