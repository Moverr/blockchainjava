var AccountingHandler=function(){AccountingHandler.self=this;$("#singleActions a").off("click touch");$("#singleActions a").on("click touch",AccountingHandler.prototype.singleObjectActionHandler);this.commandStack=[];this.argumentStack=[]};AccountingHandler.prototype.stack=function(b,a){AccountingHandler.self.commandStack.push(b);AccountingHandler.self.argumentStack.push(a)};AccountingHandler.prototype.back=function(){AccountingHandler.self.commandStack.pop()(AccountingHandler.self.argumentStack.pop())};AccountingHandler.GL_TYPES={balanceSheet:["ASSETS","LIABILITIES","EQUITY"],incomeStatement:["INCOME","EXPENSE"]};AccountingHandler.JOURNAL_TITLES={glAccountType:"Type",accountName:"Name",creditValue:"Credit",debitValue:"Debit",entityType:"Entity",transactionDate:"Date"};AccountingHandler.REPORT_SUM_TITLES={type:"Type",name:"Name",balance:"Balance"};AccountingHandler.CHART_OF_ACCOUNTS_TITLES={code:"GL Code",name:"Name",balance:"Balance"};AccountingHandler.HEADER_ACCOUNTS=[{glCode:"1000",name:"Assets"},{glCode:"2000",name:"Liabilities"},{glCode:"3000",name:"Equity"},{glCode:"4000",name:"Revenues"},{glCode:"5000",name:"Expenses"}];AccountingHandler.BALANCE_SHEET_TITLES={name:"Name",balance:"Balance"};AccountingHandler.BALANCE_SHEET_EXPAND_GL_CODES=["1300","1600","3200","3300","4100","5100","5200","5400"];AccountingHandler.prototype.overview=function(){addHistory("Accounting overview","#accountingOverview","#accounting");initDefaultContent("Accounting");currentTable="accounting";clearExportButtons();$("#syncNow").off("click touch");$("#syncNow").attr("title","Nothing to sync");$("#printNow").off("click touch");$("#printNow").hide();var a=getDefaultRowContainer({type:"Items Available"});if(handlers.Permissions.check_access("_VIEW_CHART_OF_ACCOUNTS")){addRow(a,{type:"Chart of Accounts"},"Accounting",AccountingHandler.self.overviewRowClickHandler,"chartOfAccounts")}if(handlers.Permissions.check_access("_NEW_ACCOUNTING_ENTRY")){addRow(a,{type:"New Account Entry"},"Accounting",AccountingHandler.self.overviewRowClickHandler,"create")}if(handlers.Permissions.check_access("_VIEW_BALANCE_SHEET")){addRow(a,{type:"Balance Sheet"},"Accounting",AccountingHandler.self.overviewRowClickHandler,"balanceSheet")}if(handlers.Permissions.check_access("_VIEW_INCOME_STATEMENT")){addRow(a,{type:"Income Statement"},"Accounting",AccountingHandler.self.overviewRowClickHandler,"incomeStatement")}if(handlers.Permissions.check_access("_VIEW_GENERAL_LEDGER_ACCOUNT")){addRow(a,{type:"General Ledger Account"},"Accounting",AccountingHandler.self.overviewRowClickHandler,"generalLedgerAccount")}};AccountingHandler.prototype.overviewRowClickHandler=function(){var b=$(this).data("id");var a=$(this).data("object");$('li[data-parent~="accounting"][data-handler="'+a+'"][data-action~="'+b+'"] a').click()};AccountingHandler.prototype.create=function(){addHistory("create accounting entry","#createAccountingEntry",getSidebarSubitemSelector("accounting","Accounting","create"));initDefaultContent("Accounting");var b=$('div[data-type="debit"] select');var a=$('div[data-type="credit"] select');accountList.getEntities().filter(function(c){return parseInt(c.glCode)%100!==0}).forEach(function(c){b.append($('<option value="'+c.accountId+'">'+c.name+" ("+c.glCode+")</option>"));a.append($('<option value="'+c.accountId+'">'+c.name+" ("+c.glCode+")</option>"))});$('#glAccountPanel div[data-type="debit"] button').on("click touch",AccountingHandler.prototype.createAccountBlockHandler);$('#glAccountPanel div[data-type="credit"] button').on("click touch",AccountingHandler.prototype.createAccountBlockHandler);$("#glAccountApplicationForm").off();$("#glAccountApplicationForm").on("submit",AccountingHandler.self.submitHandler);$("#glAccountTransactionDatePicker").datetimepicker({weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:1,pickerPosition:"bottom-center",keyboardNavigation:0});$("#glAccountTransactionDatePicker").datetimepicker("setValue");showContent($("#glAccountTransaction"))};AccountingHandler.prototype.rowClickHandler=function(){var a=$(this).data("object");hideContent();$(".navbar-content").show();$("h3.page-header").text('GL Account "'+a.name+'"');$("h3.page-header").show();$("h4.sub-header").hide();AccountingHandler.self.displayJournal(a.journal);$("#singleActions a[data-action]").hide();$('#singleActions a[data-action="back"]').show();$("#singleActions a").off("click touch");$("#singleActions a").on("click touch",AccountingHandler.prototype.singleObjectActionHandler);showContent($("#singleActions"));showContent($("#glAccount"))};AccountingHandler.prototype.adjustSingleActionsByStatus=function(a){$("#singleActions a[data-action]").hide();$('#singleActions a[data-action="back"]').show();switch(a){case"SUBMITTED":$('#singleActions a[data-action="approve"]').show();$('#singleActions a[data-action="reject"]').show();break;case"REJECTED":break;case"ACTIVE":$('#singleActions a[data-action="close"]').show();break;case"CLOSED":break;default:break}};AccountingHandler.prototype.singleObjectActionHandler=function(a){a.preventDefault();hideContent();switch($(this).data("action")){case"back":AccountingHandler.self.back();break;default:break}};AccountingHandler.prototype.displayJournal=function(a){var j=getRowContainer("#glAccountJournalTableContainer",AccountingHandler.JOURNAL_TITLES,true);var h=j.parent();if(!exists(a)){return}var e=a.length;for(var c=0;c<e;c++){var f=a[c];var g=AccountingHandler.prototype.getJournalEntryData(f);addRow(j,g,f)}addClassToTableColumn(h,2,"currency");addClassToTableColumn(h,3,"currency");var d=getDefaultTableSorter();var b=document.getElementById("glAccountJournalTableContainer").getElementsByTagName("table");for(var c=0;c<b.length;c++){b[c].style.textAlign="right"}d.headers={2:{sorter:"awamoCurrencySorter"},3:{sorter:"awamoCurrencySorter"},5:{sorter:"awamoDateSorter"}};initialize_datatable(h)};AccountingHandler.prototype.getJournalEntryData=function(c){var e={};var d=accountList.getById(c.accountId);for(var a in AccountingHandler.JOURNAL_TITLES){var b=c[a];switch(a){case"glAccountType":b=d.type;break;case"accountName":b=d.name;break;case"creditValue":if(c.entryType==="CREDIT"){b=formatCurrency(c.value)+" "+currencyCode}else{b=""}break;case"debitValue":if(c.entryType==="DEBIT"){b=formatCurrency(c.value)+" "+currencyCode}else{b=""}break;case"transactionDate":b=formatDate(b);break;default:break}e[a]=String(b)}return e};AccountingHandler.prototype.createAccountBlockHandler=function(){var b=$(this).parent().parent();if(b.find("span").hasClass("glyphicon-plus")){var a=b.clone();b.find("span").removeClass("glyphicon-plus").addClass("glyphicon-minus");a.find("label").text("");a.find("select")[0].selectedIndex=0;a.find("input").val("");a.find("button").on("click touch",AccountingHandler.prototype.createAccountBlockHandler);b.after(a)}else{if(b.find("span").hasClass("glyphicon-minus")){b.remove()}}};AccountingHandler.prototype.submitHandler=function(f){f.preventDefault();var a=$('div[data-type="debit"]');var c=$('div[data-type="credit"]');var g=[];var e=[];a.each(function(){g.push({glAccountId:parseInt($(this).find("select").val()),amount:parseFloat($(this).find("input").val())*100})});c.each(function(){e.push({glAccountId:parseInt($(this).find("select").val()),amount:parseFloat($(this).find("input").val())*100})});var b={transactionDate:new Date($("#glAccountTransactionDate").val()).getTime(),comments:$("#accountingComment").text(),debits:g,credits:e};var d=accountList.rootPath+"journal";showLoader();ajax(d,"POST",function(h){hideLoader();showAlertMessage("Record Saved Successfully ",AlertTypes.success);ajax(accountList.rootPath+"transactions/?transactionId="+h.id,"GET",accountList.addJournalEntries);console.log($("#glAccountPanel").find(".row"));$("#glAccountPanel .row").each(function(){$(this).find(".form-group").not(":first").remove()});$("#glAccountPanel .row .form-group").find("select,input").val("");$('li.subitem[data-handler="Accounting"][data-action="chartOfAccounts"] a').click();showAlertMessage("Record Saved Successfully ",AlertTypes.success)},JSON.stringify(b),undefined,function(h){hideLoader();showAlertMessage(h.responseJSON.message,AlertTypes.warning)})};AccountingHandler.prototype._sumOfJournal=function(a){if(!exists(a.journal)){return 0}return a.journal.reduce(function(c,b){if(b.entryType==="CREDIT"){return c+b.value}else{if(b.entryType==="DEBIT"){return c-b.value}else{return c}}},0)};AccountingHandler.prototype.chartOfAccounts=function(){addHistory("chart of accounts","#chartOfAccounts",getSidebarSubitemSelector("accounting","Accounting","chartOfAccounts"));initDefaultContent("Chart of Accounts");AccountingHandler.self.stack(AccountingHandler.prototype.chartOfAccounts);var a=getDefaultRowContainer(AccountingHandler.CHART_OF_ACCOUNTS_TITLES,true);accountList.getEntities().concat(AccountingHandler.HEADER_ACCOUNTS).sort(function(f,e){return f.glCode-e.glCode}).forEach(function(e){addRow(a,AccountingHandler.prototype.getChartOfAccountsSheetRowData(e),e,AccountingHandler.self.rowClickHandler,e.accountId)});var c=a.parent();var b={paging:false,scrollY:500,scrollCollapse:true};var d=initialize_datatable(c,b);new $.fn.dataTable.FixedHeader(d);addClassToDefaultTableColumn(3,"currency");showContent($("#glAccount"))};AccountingHandler.prototype.getChartofAccountsByType=function(d){var c=accountList.getEntities();var b=[];var a=0;$.each(c,function(e,f){if(f.type===d){b[a]=f;a++}});return b};AccountingHandler.prototype.getChartOfAccountsSheetRowData=function(c){var d={};for(var a in AccountingHandler.CHART_OF_ACCOUNTS_TITLES){var b=c[a];switch(a){case"code":if(c.glCode%1000===0){b="<b>"+c.glCode+"</b"}else{if(c.glCode%100===0){b="&emsp;&emsp;"+c.glCode}else{b="&emsp;&emsp;&emsp;&emsp;"+c.glCode}}break;case"name":if(c.glCode%1000===0){b="<b>"+c.name+"</b"}else{if(c.glCode%100===0){b="&emsp;&emsp;"+c.name}else{b="&emsp;&emsp;&emsp;&emsp;"+c.name}}break;case"balance":b=formatCurrency(this._sumOfJournal(c))+" "+currencyCode;break;default:break}d[a]=String(b)}return d};AccountingHandler.prototype.balanceSheet=function(){addHistory("balance sheet","#balanceSheet",getSidebarSubitemSelector("accounting","Accounting","balanceSheet"));initDefaultContent("Balance Sheet");AccountingHandler.self.stack(AccountingHandler.prototype.balanceSheet);var j=accountList.getBalanceSheet();var d=$("#balanceSheetTableContainer");d.empty();var b=AccountingHandler.GL_TYPES.balanceSheet.length;var f;var g;var c;var e;for(var a=0;a<b;a++){f=getEmptyTable(false);g=f.find("thead");addRow(g,[AccountingHandler.GL_TYPES.balanceSheet[a],"Balance"]);g=f.find("tbody");var h=j.root.children[a];e=0;h.children.forEach(function(i){e+=i.balance();AccountingHandler.self.addRowForNode(i,g,0)});c=addRow(g,{name:"Total "+capitalize(AccountingHandler.GL_TYPES.balanceSheet[a]),balance:formatCurrency(e)+" "+currencyCode});c.addClass("total");addClassToTableColumn(f,1,"currency");d.append(f)}e=j.root.getChildByGLCode("2000").balance()+j.root.getChildByGLCode("3000").balance();c=addRow(g,{name:"Total Liabilities + Equity",balance:formatCurrency(e)+" "+currencyCode});c.addClass("total");addClassToTableColumn(f,1,"currency");showContent(d)};AccountingHandler.prototype.addRowForNode=function(c,b,a){addRow(b,AccountingHandler.self.getAccountingRowData(c,a),c.account,AccountingHandler.self.rowClickHandler,c.account.accountId);if(AccountingHandler.BALANCE_SHEET_EXPAND_GL_CODES.includes(c.account.glCode)){c.children.forEach(function(d){AccountingHandler.self.addRowForNode(d,b,a+1)})}};AccountingHandler.prototype.incomeStatement=function(){addHistory("income statement","#incomeStatement",getSidebarSubitemSelector("accounting","Accounting","incomeStatement"));initDefaultContent("Income Statement");AccountingHandler.self.stack(AccountingHandler.prototype.incomeStatement);var k=accountList.getBalanceSheet();var f=$("#balanceSheetTableContainer");f.empty();var i=getDefaultRowContainer({title:"Financial Revenue",anotherColumn:""},true);var h=i.parent();var e;var g;var j;var b=0;j=k.root.getChildByGLCode("4000");e=addRow(i,["Financial Revenue",""]);g=0;j.children.forEach(function(l){if(l.account.glCode<"4500"){g+=l.balance();AccountingHandler.self.addRowForNode(l,i,1)}});e.find("td:last-child").html(formatCurrency(g)+" "+currencyCode);e.addClass("incomeStatementMainRow");b+=g;j=k.root.getChildByGLCode("5000");e=addRow(i,["Financial Expense",""]);g=0;j.children.forEach(function(l){if(l.account.glCode<"5200"){g+=l.balance();AccountingHandler.self.addRowForNode(l,i,1)}});e.find("td:last-child").html(formatCurrency(g)+" "+currencyCode);e.addClass("incomeStatementMainRow");b-=g;var d=b;e=addRow(i,["Net Financial Income",formatCurrency(b)+" "+currencyCode]);g=0;j.children.forEach(function(l){if(l.account.glCode>"5199"&&l.account.glCode<"5300"){g+=l.balance();AccountingHandler.self.addRowForNode(l,i,1)}});e.addClass("incomeStatementMainRow");d-=g;e=addRow(i,["OPERATING EXPENSES",""]);g=0;j.children.forEach(function(l){if(l.account.glCode>"5299"&&l.account.glCode<"5600"){g+=l.balance();AccountingHandler.self.addRowForNode(l,i,1)}});e.find("td:last-child").html(formatCurrency(g)+" "+currencyCode);e.addClass("incomeStatementMainRow");d-=g;e=addRow(i,["Net Operating Income",formatCurrency(d)+" "+currencyCode]);e.addClass("incomeStatementMainRow");g=k.root.getChildByGLCode("4500").balance()-k.root.getChildByGLCode("5600").balance();e=addRow(i,["Net Nonoperating Income/(Expense)",formatCurrency(g)+" "+currencyCode]);e.addClass("incomeStatementMainRow");g=d+g;var c=k.root.getChildByGLCode("5900");e=addRow(i,["Net Income (Before Taxes and Donations)",formatCurrency(g)+" "+currencyCode]);AccountingHandler.self.addRowForNode(c,i,1);e.addClass("incomeStatementMainRow");g=g-c.balance();var a=k.root.getChildByGLCode("4600");e=addRow(i,["Net Income (After Taxes and Before donations)",formatCurrency(g)+" "+currencyCode]);AccountingHandler.self.addRowForNode(a,i,1);e.addClass("incomeStatementMainRow");g=g+a.balance();e=addRow(i,["Net Income (After Taxes and Donations)",formatCurrency(g)+" "+currencyCode]);e.addClass("incomeStatementMainRow");addClassToTableColumn(h,1,"currency");h=initialize_datatable(h,{dom:"<i<t>lp>",language:{info:"_TOTAL_ Total Entries"},scrollX:true,iDisplayLength:25,ordering:false});f.append(h);showContent(f)};AccountingHandler.prototype.getAccountingRowData=function(f,a){var b="";var g={};if(f.account.glCode==="5130"){a-=1}for(var d=0;d<a;d++){b+="&emsp;&emsp;&emsp;&emsp;"}for(var c in AccountingHandler.BALANCE_SHEET_TITLES){var e;switch(c){case"name":e=b+f.account.name+" ("+f.account.glCode+")";break;case"balance":e=formatCurrency(f.balance())+" "+currencyCode;break;default:break}g[c]=String(e)}return g};AccountingHandler.prototype.generalLedgerAccount=function(){addHistory("general ledger account","#generalLedgerAccount",getSidebarSubitemSelector("accounting","Accounting","generalLedgerAccount"));initDefaultContent("General Ledger Account");var a=[];accountList.getEntities().forEach(function(b){a=a.concat(b.journal)});AccountingHandler.self.displayJournal(a);showContent($("#glAccount"))};