var ShareHandler=function(){ShareHandler.self=this;this.commandStack=[];this.argumentStack=[]};ShareHandler.APPLICATION_TITLES={clientName:"Client name",numberOfShares:"Number of shares",valueOfShares:"Value of shares"};ShareHandler.APPLICATION_PENDING_TITLES={accountNo:"Account #",shareAccount:"Share Account",clientName:"Client name",totalPendingShares:"Pending Shares"};ShareHandler.ALL_ACCOUNTS_TITLES={clientName:"Name",accountNo:"Account",status:"Status",totalPendingShares:"Total Pending Shares",totalApprovedShares:"Total Approved  Shares",shareAccount:"Share Account"};ShareHandler.CURRENT_MARKET_PRICE=50000;ShareHandler.CLIENT_TITLES={fullname:"Name",gender:"Sex",birthdate:"Birth date",submitDate:"Registration",phone1:"Phone"};ShareHandler.prototype.overview=function(){addHistory("Bankings Services Savings Account","#bankingServicesSavingsAccountOverview",getSidebarSubitemSelector("bankingServices","SavingsAccount","sharesAccountMainMenuOverview"));initDefaultContent("Shares Accounts");clearExportButtons();$("#syncNow").off("click touch");$("#syncNow").attr("title","Nothing to sync");$("#printNow").off("click touch");$("#printNow").hide();currentTable="options";var a=getDefaultRowContainer({type:"Items Available"});if(handlers.Permissions.check_access("_CREATE_NEW_SHARE")){addRow(a,{type:"Create New Account"},"SharesAccount",ShareHandler.self.showAllClientsForSharesAccountApplication,"showAllClientsForSharesAccountApplication")}if(handlers.Permissions.check_access("_MANAGE_SHARES")){addRow(a,{type:"Use Existing Account"},"SharesAccount",SavingsAccountHandler.prototype.getAllForCloseDepositAndWithdraw,"getAllForCloseDepositAndWithdraw")}};ShareHandler.prototype.getApplications=function(){ShareHandler.forReporting=false;addHistory("Shares Account Applications","#sharesAccountApplications",getSidebarSubitemSelector("actionRequired","Share","getApplications"));currentTable="sharesAccountApplications";ShareHandler.self.previousPage=ShareHandler.self.getApplications;ShareHandler.self.displaySavingsAccountApplications()};ShareHandler.prototype.approveApplications=function(){ShareHandler.forReporting=false;addHistory("Shares Account Applications","#sharesAccountApplications",getSidebarSubitemSelector("actionRequired","Share","getApplications"));currentTable="sharesAccountApplications";ShareHandler.self.previousPage=ShareHandler.self.approveApplications;ShareHandler.self.displayPendingSharesApplications()};ShareHandler.prototype.activateApplications=function(){ShareHandler.forReporting=false;addHistory("Shares Account Applications","#sharesAccountApplications",getSidebarSubitemSelector("actionRequired","Share","getApplications"));currentTable="sharesAccountApplications";ShareHandler.self.previousPage=ShareHandler.self.activateApplications;ShareHandler.self.displayApprovedSharesApplications()};ShareHandler.prototype.share_status="ALL";ShareHandler.prototype.getListByStatus=function(b){var a=ShareHandler.self.share_status;if(undefined!==b&&b!==a){a=b}switch(a){case"ALL":return shareList.getEntities();break;case"REJECTED":return shareList.getListByStatus("REJECTED");break;case"ACTIVE":return shareList.getListByStatus("ACTIVE");break;case"PENDING":return shareList.getListByStatus("PENDING");break;case"APPROVED":return shareList.getListByStatus("APPROVED");break;case"CLOSED":return shareList.getListByStatus("CLOSED");break;default:break}};ShareHandler.prototype.approveApplication=function(){var d=ShareHandler.self.currentshareAccount;if(d==null){return}var b=d.id;var a=host+"/share/v1d/"+b+"/approve";var c=getAuthenticationHeader();$.ajax({url:a,dataType:"json",contentType:"application/json; charset=utf-8",headers:c,type:"POST",beforeSend:function(){showLoader()},success:function(e){alert("Success");hideLoader()},complete:function(){hideLoader()}}).fail(function(e){console.log(e);alert("Something went wrong");hideLoader()})};ShareHandler.prototype.rejectApplication=function(){var d=ShareHandler.self.currentshareAccount;if(d==null){return}var b=d.id;var a=host+"/share/v1d/"+b+"/reject";var c=getAuthenticationHeader();$.ajax({url:a,dataType:"json",contentType:"application/json; charset=utf-8",headers:c,type:"POST",beforeSend:function(){showLoader()},success:function(e){alert("Success");hideLoader()},complete:function(){hideLoader()}}).fail(function(e){console.log(e);alert("Something went wrong");hideLoader()})};ShareHandler.prototype.activateApplication=function(){var d=ShareHandler.self.currentshareAccount;if(d==null){return}var b="Confirm  Account Activation";var e="Are you sure you want to activate this application ?";var c="Yes";var a="No";showDialogPopupWithHandlers(b,e,c,function(){var g=d.id;var f=host+"/share/v1d/"+g+"/activate";var h=getAuthenticationHeader();$.ajax({url:f,dataType:"json",contentType:"application/json; charset=utf-8",headers:h,type:"POST",beforeSend:function(){showLoader()},success:function(i){alert("Success");hideLoader()},complete:function(){hideLoader()}}).fail(function(i){console.log(i);alert("Something went wrong");hideLoader()})},a,function(){})};ShareHandler.prototype.singleObjectActionHandler=function(d){d.preventDefault();switch($(this).data("action")){case"back":hideContent();SavingsAccountHandler.self.previousPage();hideControlsForReporting("SavingsAccount");break;case"activate":var b="Confirm Savings Accounts Application Approval";var e="Are you sure you want to approve this application ?";var c="Yes";var a="No";showDialogPopupWithHandlers(b,e,c,function(){ShareHandler.self.approveApplication()},a,function(){SavingsAccountHandler.prototype.backToDisplayOneSavingsAccount()});break;case"approve":var b="Confirm Savings Accounts Application Approval";var e="Are you sure you want to approve this application ?";var c="Yes";var a="No";showDialogPopupWithHandlers(b,e,c,function(){ShareHandler.self.approveApplication()},a,function(){SavingsAccountHandler.prototype.backToDisplayOneSavingsAccount()});break;case"reject":var b="Confirm Savings Accounts Application Rejection";var e="Are you sure you want to reject this application ?";var c="Yes";var a="No";showDialogPopupWithHandlers(b,e,c,function(){SavingsAccountHandler.prototype.rejectApplication()},a,function(){SavingsAccountHandler.prototype.backToDisplayOneSavingsAccount()});break;case"close":hideContent();$("#closeApplication .panel-body .closeObject").text("savings account");showContent($("#closeApplication"));break;default:break}};ShareHandler.prototype.adjustSingleActionsByStatus=function(a){$("#singleActions a[data-action]").hide();$('#singleActions a[data-action="back"]').show();console.log(a);switch(a){case"SUBMITTED":$('#singleActions a[data-action="approve"]').show();$('#singleActions a[data-action="reject"]').show();break;case"PENDING":$('#singleActions a[data-action="approve"]').show();$('#singleActions a[data-action="reject"]').show();break;case"APPROVED":$('#singleActions a[data-action="activate"]').show();$('#singleActions a[data-action="reject"]').show();break;case"REJECTED":break;case"ACTIVE":$('#singleActions a[data-action="close"]').show();break;case"CLOSED":break;default:break}};ShareHandler.prototype.currentshareAccount=null;ShareHandler.prototype.displayApprovedSharesApplications=function(){var e=ShareHandler.self.getListByStatus("APPROVED");console.log(e);ShareHandler.self.currentshareAccount=null;initDefaultContent("Shares Account Applications");$("#syncNow").off("click touch");$("#syncNow").on("click touch",ShareHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync savings accounts applications");$("#syncNow").show();var f=$("#defaultTableContainer");f.empty();var a=null;if("actionRequiredSharesAcTable"===undefined){a=getDefaultRowContainer(ShareHandler.APPLICATION_PENDING_TITLES,true)}else{a=getDefaultRowContainer(ShareHandler.APPLICATION_PENDING_TITLES,true,"actionRequiredSharesAcTable")}var c=a.parent();for(var d=0;d<e.length;d++){addRow(a,ShareHandler.self.getRowData(ShareHandler.APPLICATION_PENDING_TITLES,e[d]),e[d],ShareHandler.self.rowClickHandler,e[d].accountId)}var b=getDefaultTableSorter();b.headers={3:{sorter:"awamoPercentageSorter"},4:{sorter:"awamoCurrencySorter"}};initialize_datatable(c);$("#tableTotal").text(e.length);showContent($("#tableTotalSum"));showContent($("#emailLoanReportDiv"));clearExportButtons();$("#syncNow").off("click touch");$("#syncNow").attr("title","Nothing to sync");$("#printNow").off("click touch");$("#printNow").hide();$("#singleActions a").off("click touch");$("#singleActions a").on("click touch",ShareHandler.self.singleObjectActionHandler);$("#_activate").off();$("#_activate").on("click touch",ShareHandler.self.activateApplication);$("#rejectYes").off("click touch");$("#rejectYes").on("click touch",ShareHandler.self.rejectApplication)};ShareHandler.prototype.displayPendingSharesApplications=function(){var e=ShareHandler.self.getListByStatus("PENDING");console.log(e);ShareHandler.self.currentshareAccount=null;initDefaultContent("Shares Account Applications");$("#syncNow").off("click touch");$("#syncNow").on("click touch",ShareHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync savings accounts applications");$("#syncNow").show();var f=$("#defaultTableContainer");f.empty();var a=null;if("actionRequiredSharesAcTable"===undefined){a=getDefaultRowContainer(ShareHandler.APPLICATION_PENDING_TITLES,true)}else{a=getDefaultRowContainer(ShareHandler.APPLICATION_PENDING_TITLES,true,"actionRequiredSharesAcTable")}var c=a.parent();for(var d=0;d<e.length;d++){addRow(a,ShareHandler.self.getRowData(ShareHandler.APPLICATION_PENDING_TITLES,e[d]),e[d],ShareHandler.self.rowClickHandler,e[d].accountId)}var b=getDefaultTableSorter();b.headers={3:{sorter:"awamoPercentageSorter"},4:{sorter:"awamoCurrencySorter"}};initialize_datatable(c);$("#tableTotal").text(e.length);showContent($("#tableTotalSum"));showContent($("#emailLoanReportDiv"));clearExportButtons();$("#syncNow").off("click touch");$("#syncNow").attr("title","Nothing to sync");$("#printNow").off("click touch");$("#printNow").hide();$("#singleActions a").off("click touch");$("#singleActions a").on("click touch",ShareHandler.self.singleObjectActionHandler);$("#approveYes").off("click touch");$("#approveYes").on("click touch",ShareHandler.self.approveApplication);$("#rejectYes").off("click touch");$("#rejectYes").on("click touch",ShareHandler.self.rejectApplication)};ShareHandler.prototype.rowClickHandler=function(b,a){if(exists(a)){ShareHandler.self.previousPage=a}ShareHandler.self.displayOneShareAccount($(b.currentTarget).data("object"))};ShareHandler.prototype.displayOneShareAccount=function(b){ShareHandler.self.currentshareAccount=b;if(!exists(b)){return}clearExportButtons();$("#syncNow").off("click touch");$("#syncNow").attr("title","Nothing to sync");$("#printNow").off("click touch");$("#printNow").hide();SavingsAccountHandler.self.sharesAccount=b;initDefaultContent("Shares Account");var a=ShareHandler.self.getRowData(ShareHandler.ALL_ACCOUNTS_TITLES,b);$("#sharesAccountNumber").val(a.accountNo);$("#sharesAccountName").val(a.clientName);$("#sharesAccountStatus").val(a.status);$("#sharesAccountshares").val(a.totalPendingShares);$("#sharesAccount .shareAccountProduct").val(a.shareAccount);console.log(b);console.log("svngs AC 0");ShareHandler.self.adjustSingleActionsByStatus(b.status);showContent($("#singleActions"));hideControlsForReporting("SavingsAccount");showContent($("#sharesAccount"))};ShareHandler.prototype.getRowData=function(d,a){var e={};for(var b in d){var c=a[b];switch(b){case"clientImage":c='<img src="images/personPlaceholderNoText.png" alt="client" height="32" />';if("GROUP"===a.sharesAccountType){c='<img src="images/groupPlaceholder.png" alt="client" height="32" />'}else{if("INDIVIDUAL"===a.sharesAccountType){c='<img src="images/personPlaceholderNoText.png" alt="client" height="32" />'}}break;case"interestRate":c=formatPercentage(c)+" %";break;case"balance":c=formatCurrency(c)+" "+currencyCode;break;case"submittedDate":c=formatDate(c);default:break}e[b]=String(c)}return e};ShareHandler.prototype.displayInTable=function(c,f,k){var e=$("#defaultTableContainer");e.empty();var j=null;if(k===undefined){j=getDefaultRowContainer(c,true)}else{j=getDefaultRowContainer(c,true,k)}var h=j.parent();for(var b=0;b<f.length;b++){addRow(j,ShareHandler.prototype.getRowData(c,f[b]),f[b],ShareHandler.self.rowClickHandler,f[b].accountId)}var d=getDefaultTableSorter();d.headers={3:{sorter:"awamoPercentageSorter"},4:{sorter:"awamoCurrencySorter"}};initialize_datatable(h);var a=document.getElementById("defaultTableContainer").getElementsByTagName("table");for(var b=0;b<a.length;b++){a[b].style.textAlign="right"}addClassToTableColumn(h,3,"percentage");addClassToTableColumn(h,4,"currency");$("#tableTotal").text(f.length);showContent($("#tableTotalSum"));showContent($("#emailLoanReportDiv"));showContent(e);e.show();$("#sendsavingaccountEmailReportBotton").off("click touch");$("#sendsavingaccountEmailReportBotton").on("click touch",SavingsAccountHandler.self.sendEmailLoanReportRequest);$("#sendsavingaccountEmailReportBotton").show();if(handlers.Permissions.check_access("_EXPORT_ACCOUNTS")){var g=$("#defaultTableContainer").tableExport();g.tableExport.update({formats:["xls","xlsx"],fileName:"SavingsAccounts",headings:true})}$("#hiddenPrintedTitle").val("Savingaccounts Report")};ShareHandler.prototype.showAllClientsForSharesAccountApplication=function(){addHistory("Shares Accounts All Clients","#bankingServicesSharesAccountAllClients",getSidebarSubitemSelector("SharesAccountMainMenu","SharesAccount","showAllClientsForSharesAccountApplication"));currentTable="allClients";SavingsAccountHandler.self.previousPage=ShareHandler.self.showAllClientsForSharesAccountApplication;ShareHandler.self.displayAllClientsForSharesAccountApplication()};ShareHandler.prototype.currentClient=null;ShareHandler.prototype.displayAllClientsForSharesAccountApplication=function(){ShareHandler.self.currentClient=null;initDefaultContent("Select Client For Shares Account Application");var n=clientList.getEntities();var q=getDefaultRowContainer(ShareHandler.CLIENT_TITLES,true);var p=q.parent();for(var f=0;f<n.length;f++){var r={};for(var o in SavingsAccountHandler.CLIENT_TITLES){var e=n[f][o];if("birthdate"===o||"submitDate"===o){e=formatDate(e)}if("account"===o){var a=sharesAccountList.getByClient(n[f]["awamoId"]);var l=a.length;if(l>0){var k=0;for(var c=0;c<l;c++){var m=a[c];k=k+m.balance}e=currencyCode+" "+formatCurrency(k)}else{e=currencyCode+" "+0}}if("loan"===o){var g=loanList.getByClient(n[f]["awamoId"]);var l=g.length;if(l>0){var k=0;for(var c=0;c<l;c++){var d=g[c];if(d.status==="ACTIVE"){k=k+d.principal}}e=currencyCode+" "+formatCurrency(k)}else{e=currencyCode+" "+0}}if(e===" "){e="n.a."}r[o]=e}addRow(q,r,n[f],ShareHandler.self.newSharesApplication,n[f].accountId)}var h=getDefaultTableSorter();h.headers={3:{sorter:"awamoDateSorter"},4:{sorter:"awamoDateSorter"}};initialize_datatable(p);var b=document.getElementById("defaultTableContainer").getElementsByTagName("table");for(var f=0;f<b.length;f++){b[f].style.textAlign="right"}$("#tableTotal").text(n.length);showContent($("#tableTotalSum"));showContent($("#emailLoanReportDiv"));$("#hiddenPrintedTitle").val("Clients Report")};ShareHandler.prototype.newSharesApplication=function(){var c=$(this).data("object");ShareHandler.self.currentClient=c;console.log("Client");console.log(c);hideLoader();if(!exists(c)){return}ShareHandler.self.stack(ShareHandler.prototype.transactionApplication);ShareHandler.self.shareApplication=null;initDefaultContent(" share");var d=$("#shareClient");var b=$("#shareSavingsAccount");var g=null;var f=shareProductList.getEntities();var h='<option value=""> Select </option>  ';$.each(f,function(i,j){h+='<option value="'+j.id+'"> '+j.name+"</option>"});$("#shareProduct").html(h);console.log(f);var a=savingsAccountList.getByClient(c.awamoId);var e='<option value=""> Select </option>  ';$.each(a,function(i,j){e+='<option value="'+j.accountId+'"> '+j.accountNo+"</option>"});$("#shareSavingsAccount").html(e);console.log(a);$("#sharePurchaseDatePicker").datetimepicker("setValue");$("#createShareApplicationForm").off("submit");$("#createShareApplicationForm").on("submit",ShareHandler.prototype.submitSharesApplication);showContent($("#shareApplication"))};ShareHandler.prototype.submitSharesApplication=function(i){i.preventDefault();var g=$("#shareProduct").val();var b=$("#share_purchase_date").val();b=new Date(b).getTime();console.log(b);var k=$("#shareSavingsAccount").val();var c=$("#shareCount").val();if(isEmpty(g)==false||isEmpty(b)==false||isEmpty(k)==false||isEmpty(c)==false){alert("Fill Mandatory FIelds ");return}var f=shareProductList.getEntities();$.each(f,function(e,n){if(n.id===g){console.log("row");console.log(n);if(c>n.maximumClientShares){alert("Number of shares is greater than Maximum set Client Shares ");return}}});var j=ShareHandler.self.currentClient.awamoId;var h='{"productId":'+g+', "awamoId":"'+j+'", "totalPendingShares":'+c+', "currencyCode":"'+currencyCode+'","sharesAccountId":'+k+" }";console.log(h);var a="Confirm Share Application";var l="Are you sure you want to proceede?";var m="Yes";var d="No";showDialogPopupWithHandlers(a,l,m,function(){var e=host+"/share/v1d/create";var n=getAuthenticationHeader();$.ajax({url:e,dataType:"json",contentType:"application/json; charset=utf-8",headers:n,data:h,type:"POST",beforeSend:function(){showLoader()},success:function(o){alert("Success");hideLoader()},complete:function(){hideLoader()}}).fail(function(o){console.log(o);alert("Something went wrong");hideLoader()})},d,function(){})};ShareHandler.prototype.purchaseApplication=function(){ShareHandler.self.transactionApplication("purchase")};ShareHandler.prototype.fillClientList=function(){var a=$("#shareClient");a.find("option").not(":first").remove();clientList.getEntities().filter(function(b){return sharesAccountList.getByClient(b.awamoId).length>0}).sort(function(c,b){return c.fullname>b.fullname}).forEach(function(b){a.append($('<option value="'+b.awamoId+'">'+b.fullname+"</option>"))})};ShareHandler.prototype.transactionApplication=function(c){ShareHandler.self.stack(ShareHandler.prototype.transactionApplication);ShareHandler.self.shareApplication=null;initDefaultContent(c+" share");var b=$("#shareClient");var a=$("#shareSavingsAccount");ShareHandler.self.fillClientList();b.off("input");b.on("input",function(){a.find("option").not(":first").remove();sharesAccountList.getByClient($(this).val()).filter(function(d){return d.status==="ACTIVE"}).forEach(function(d){a.append($('<option value="'+d.accountId+'">'+d.accountNo+"</option>"))})});$("#shareCount").off("input");$("#shareCount").on("input",function(){var d=Math.round(Math.abs($(this).val()));if(d===0){$('#singleActions a[data-action="purchase"]').text(c)}else{$('#singleActions a[data-action="purchase"]').text(c+" "+d+" share"+(d===1?"":"s")+" for "+formatCurrency(d*ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode)}});$("#shareCount").next(".input-group-addon").text(formatCurrency(ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode+" each");$("#shareApplicationForm").data("transactionType",c);$("#shareApplicationForm").off("submit");$("#shareApplicationForm").on("submit",ShareHandler.prototype.submitTransactionApplicationHandler);$("#sharePurchaseDatePicker").datetimepicker({weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:1,pickerPosition:"bottom-center",keyboardNavigation:0});$("#sharePurchaseDatePicker").datetimepicker("setValue");ShareHandler.self.showActionButtons();showContent($("#shareApplication"))};ShareHandler.prototype.submitTransactionApplicationHandler=function(c){if(exists(c)){c.preventDefault()}var b=Math.round(Math.abs($("#shareCount").val()));var a={transactionDate:new Date($("#sharePurchaseDate").val()).getTime(),clientAwamoId:$("#shareClient").val(),sharesAccountId:$("#shareSavingsAccount").val(),requestedShares:b,submittedDate:new Date().getTime(),transactionType:$("#shareApplicationForm").data("transactionType").toUpperCase()};ajax(shareList.rootPath,"POST",function(d){message("Success","successfully submitted application for purchase of "+b+" share"+(b===1?"":"s")+" for "+(b*ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode,MessageType.SUCCESS);$("#sharePurchaseDatePicker").datetimepicker("setDate",new Date());$("#shareClient").find("option").not(":first").remove();$("#shareSavingsAccount").find("option").not(":first").remove();$("#shareCount").val("");$('#singleActions a[data-action="purchase"]').text("Purchase");$('#singleActions a[data-action="purchase"]').prop("disabled",true);$("#sharePurchaseDatePicker").blur();$("#shareClient").blur();$("#shareSavingsAccount").blur();$("#shareCount").blur();$('#singleActions a[data-action="purchase"]').blur();ShareHandler.self.fillClientList()},JSON.stringify(a),undefined,function(d){message("Error",d.responseJSON.message,MessageType.WARNING)})};ShareHandler.prototype.sellApplication=function(){ShareHandler.self.stack(ShareHandler.prototype.sellApplication);initDefaultContent("Sell share(s)");var a=$("#shareSaleApplicationClient");a.find("option").not(":first").remove();ajax(shareList.rootPath+"clientsWithShares","GET",function(b){b.forEach(function(d){var c=$('<option value="'+d.clientAwamoId+'" data-max="'+d.numberOfShares+'">'+d.clientName+"</option>");a.append(c)});a.off("input");a.on("input",function(){var c=$(this).find(":selected").data("max");$("#shareSaleApplicationCount").attr("max",c);$("#shareSaleApplicationCount").next(".input-group-addon").text(formatCurrency(ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode+" each, min 1 and max "+c+" shares")})});$("#shareSaleApplicationForm").off("submit");$("#shareSaleApplicationForm").on("submit",ShareHandler.prototype.submitSellApplicationHandler);ShareHandler.self.shareApplication={status:"WANT_TO_SELL"};ShareHandler.self.showActionButtons();showContent($("#shareSaleApplication"))};ShareHandler.prototype.submitSellApplicationHandler=function(d){if(exists(d)){d.preventDefault()}var a=$("#shareSaleApplicationClient");var c=Math.round(Math.abs($("#shareSaleApplicationCount").val()));var b={transactionDate:new Date().getTime(),clientAwamoId:a.val(),requestedShares:c,submittedDate:new Date().getTime(),transactionType:"SALE"};ajax(shareList.rootPath,"POST",function(e){message("Success","successfully submitted application for sale of "+c+" share"+(c===1?"":"s")+" for "+(c*ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode,MessageType.SUCCESS);$("#shareSaleApplicationCount").val("");$("#shareSaleApplicationCount").next(".input-group-addon").text(formatCurrency(ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode+" each");$('#singleActions a[data-action="sell"]').text("Sell");$('#singleActions a[data-action="sell"]').prop("disabled",true);a.blur();$("#shareSaleApplicationCount").blur();$('#singleActions a[data-action="sell"]').blur();a.find("option").not(":first").remove();ajax(shareList.rootPath+"clientsWithShares","GET",function(f){f.forEach(function(h){var g=$('<option value="'+h.clientAwamoId+'" data-max="'+h.numberOfShares+'">'+h.clientName+"</option>");a.append(g)});a.off("input");a.on("input",function(){var g=$(this).find(":selected").data("max");$("#shareSaleApplicationCount").attr("max",g);$("#shareSaleApplicationCount").next(".input-group-addon").text(formatCurrency(ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode+" each, min 1 and max "+g+" shares")})})},JSON.stringify(b),undefined,function(e){message("Error",e.responseJSON.message,MessageType.WARNING)})};ShareHandler.prototype.approvePurchase=function(){ShareHandler.self.stack(ShareHandler.prototype.approvePurchase);initDefaultContent("Purchase applications");var a=getDefaultRowContainer(ShareHandler.APPLICATION_TITLES);ajax(shareList.rootPath+"listApplications?transactionType=PURCHASE","GET",function(b){ShareHandler.self.counter=b.length;if(ShareHandler.self.counter===0){tableMessage("no applications found")}b.forEach(function(c){clientList.get(c.clientAwamoId,function(d){c.client=d;c.status="SUBMITTED_FOR_PURCHASE";sharesAccountList.get(c.sharesAccountId,function(e){c.sharesAccount=e;addRow(a,ShareHandler.self.getShareRowData(c),c,ShareHandler.self.approvePurchaseRowClickHandler,c.clientAwamoId);ShareHandler.self.counter=ShareHandler.self.counter-1;if(ShareHandler.self.counter===0){a.parent().tablesorter(getDefaultTableSorter("unsorted"));addClassToTableColumn(a.parent(),2,"currency")}})})})});showContent($("#defaultTableContainer"))};ShareHandler.prototype.approvePurchaseRowClickHandler=function(){$("#approveNo").off("click touch");$("#approveNo").on("click touch",ShareHandler.prototype.back);$("#rejectNo").off("click touch");$("#rejectNo").on("click touch",ShareHandler.prototype.back);$("#approveYes").off("click touch");$("#approveYes").on("click touch",ShareHandler.prototype.approvePurchaseApplication);$("#rejectYes").off("click touch");$("#rejectYes").on("click touch",ShareHandler.prototype.rejectPurchaseApplication);$("#approveApplication .panel-body .approvalObject").text("share purchase");$("#rejectApplication .panel-body .rejectionObject").text("share purchase");ShareHandler.self.displaySingleShare($(this).data("object"))};ShareHandler.prototype.approvePurchaseApplication=function(){ShareHandler.self.shareApplication.status="APPROVED_PURCHASE";ajax(shareList.rootPath+ShareHandler.self.shareApplication.id+"/approvePurchase","POST",ShareHandler.prototype.approvePurchaseApplicationSuccessful);window.setTimeout(function(){ShareHandler.self.back();ShareHandler.self.back()},1000)};ShareHandler.prototype.approvePurchaseApplicationSuccessful=function(){ShareHandler.self.shareApplication.status="APPROVED_PURCHASE"};ShareHandler.prototype.rejectPurchaseApplication=function(){ShareHandler.self.shareApplication.status="REJECTED_PURCHASE";ajax(shareList.rootPath+ShareHandler.self.shareApplication.id+"/rejectPurchase","POST",ShareHandler.prototype.rejectPurchaseApplicationSuccessful,'{"note":"'+$("#rejectionNote").val()+'"}');ShareHandler.self.back();ShareHandler.self.back()};ShareHandler.prototype.rejectPurchaseApplicationSuccessful=function(){ShareHandler.self.shareApplication.status="REJECTED_PURCHASE"};ShareHandler.prototype.saleRowClickHandler=function(){var a=$(this).data("object");ShareHandler.self.displaySingleShare(a);$("#shareSaleCount").val(a.requestedShares)};ShareHandler.prototype.approveSale=function(){ShareHandler.self.stack(ShareHandler.prototype.approveSale);initDefaultContent("Sale applications");var a=getDefaultRowContainer(ShareHandler.APPLICATION_TITLES);ajax(shareList.rootPath+"listApplications?transactionType=SALE","GET",function(b){ShareHandler.self.counter=b.length;if(ShareHandler.self.counter===0){tableMessage("no applications found")}b.forEach(function(c){clientList.get(c.clientAwamoId,function(d){c.client=d;c.status="SUBMITTED_FOR_SALE";sharesAccountList.get(c.sharesAccountId,function(e){c.sharesAccount=e;addRow(a,ShareHandler.self.getShareRowData(c),c,ShareHandler.self.approveSaleRowClickHandler,c.clientAwamoId);ShareHandler.self.counter=ShareHandler.self.counter-1;if(ShareHandler.self.counter===0){a.parent().tablesorter(getDefaultTableSorter("unsorted"));addClassToTableColumn(a.parent(),2,"currency")}})})})});showContent($("#defaultTableContainer"))};ShareHandler.prototype.approveSaleRowClickHandler=function(){$("#approveNo").off("click touch");$("#approveNo").on("click touch",ShareHandler.prototype.back);$("#rejectNo").off("click touch");$("#rejectNo").on("click touch",ShareHandler.prototype.back);$("#approveYes").off("click touch");$("#approveYes").on("click touch",ShareHandler.prototype.approveSaleApplication);$("#rejectYes").off("click touch");$("#rejectYes").on("click touch",ShareHandler.prototype.rejectSaleApplication);$("#approveApplication .panel-body .approvalObject").text("share sale");$("#rejectApplication .panel-body .rejectionObject").text("share sale");ShareHandler.self.displaySingleShare($(this).data("object"))};ShareHandler.prototype.approveSaleApplication=function(){ShareHandler.self.shareApplication.status="APPROVED_SALE";ajax(shareList.rootPath+ShareHandler.self.shareApplication.id+"/approveSale","POST",ShareHandler.prototype.approveSaleApplicationSuccessful);window.setTimeout(function(){ShareHandler.self.back();ShareHandler.self.back()},1000)};ShareHandler.prototype.approveSaleApplicationSuccessful=function(){ShareHandler.self.shareApplication.status="APPROVED_SALE"};ShareHandler.prototype.rejectSaleApplication=function(){ShareHandler.self.shareApplication.status="REJECTED_SALE";ajax(shareList.rootPath+ShareHandler.self.shareApplication.id+"/rejectSale","POST",ShareHandler.prototype.rejectPurchaseApplicationSuccessful,'{"note":"'+$("#rejectionNote").val()+'"}');ShareHandler.self.back();ShareHandler.self.back()};ShareHandler.prototype.rejectSaleApplicationSuccessful=function(){ShareHandler.self.shareApplication.status="REJECTED_SALE"};ShareHandler.prototype.displayApprove=function(a){ShareHandler.self.stack(ShareHandler.prototype.displayApprove,a);hideContent();showContent($("#approveApplication"))};ShareHandler.prototype.displayReject=function(a){ShareHandler.self.stack(ShareHandler.prototype.displayReject,a);hideContent();$("#rejectionNote").val("");showContent($("#rejectApplication"))};ShareHandler.prototype.getShareRowData=function(c){var d={};for(var a in ShareHandler.APPLICATION_TITLES){var b=c[a];switch(a){case"clientName":b=c.client.fullname;break;case"numberOfShares":b=c.requestedShares;break;case"valueOfShares":b=formatCurrency(parseInt(c.requestedShares)*parseInt(ShareHandler.CURRENT_MARKET_PRICE))+" "+currencyCode;break;default:break}d[a]=String(b)}return d};ShareHandler.prototype.displaySingleShareApplication=function(a){ShareHandler.self.stack(ShareHandler.prototype.displaySingleShare,a);ShareHandler.self.shareApplication=a;hideContent();$("#singleSharePurchaseDate").val(formatDate(a.submittedDate));$("#singleShareClient").val(a.awamoId);$("#singleShareSavingsAccount").val(a.sharesAccount.accountNo);$("#singleShareCount").val(a.requestedShares);$("#singleShareCount").next(".input-group-addon").text(ShareHandler.CURRENT_MARKET_PRICE+" "+currencyCode);ShareHandler.self.showActionButtons();showContent($("#singleShare"))};ShareHandler.prototype.displaySingleShare=function(a){ShareHandler.self.stack(ShareHandler.prototype.displaySingleShare,a);ShareHandler.self.shareApplication=a;hideContent();$("#singleSharePurchaseDate").val(formatDate(a.transactionDate));$("#singleShareClient").val(a.client.fullname);$("#singleShareSavingsAccount").val(a.sharesAccount.accountNo);$("#singleShareCount").val(a.requestedShares);$("#singleShareCountValue").val(formatCurrency(a.requestedShares*ShareHandler.CURRENT_MARKET_PRICE)+" "+currencyCode);ShareHandler.self.showActionButtons();showContent($("#singleShare"))};ShareHandler.prototype.singleObjectActionHandler=function(){var a=$(this).data("action");switch(a){case"approve":ShareHandler.self.displayApprove(ShareHandler.self.shareApplication);break;case"reject":ShareHandler.self.displayReject(ShareHandler.self.shareApplication);break;case"back":ShareHandler.self.back();break;case"purchase":$('#shareApplicationForm input[type="submit"]').click();break;case"sell":$('#shareSaleApplicationForm input[type="submit"]').click();break;default:break}};ShareHandler.prototype.showActionButtons=function(){$("#singleActions a[data-action]").hide();if(ShareHandler.self.shareApplication===null){$('#singleActions a[data-action="purchase"]').show()}else{$('#singleActions a[data-action="back"]').show();switch(ShareHandler.self.shareApplication.status){case"WANT_TO_SELL":$('#singleActions a[data-action="sell"]').show();break;case"SUBMITTED_FOR_PURCHASE":case"SUBMITTED_FOR_SALE":$('#singleActions a[data-action="approve"]').show();$('#singleActions a[data-action="reject"]').show();break;case"ACTIVE":$('#singleActions a[data-action="sell"]').show();break;default:break}}showContent($("#singleActions"))};ShareHandler.prototype.dataModelChanged=function(){};ShareHandler.prototype.entityChanged=function(a,b){};ShareHandler.prototype.stack=function(b,a){ShareHandler.self.commandStack.push(b);ShareHandler.self.argumentStack.push(a)};ShareHandler.prototype.back=function(){ShareHandler.self.commandStack.pop();ShareHandler.self.argumentStack.pop();ShareHandler.self.commandStack.pop()(ShareHandler.self.argumentStack.pop())};