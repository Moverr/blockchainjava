"use strict";var fromRepaymentDateLimit="0";var toRepaymentDateLimit="999999999999999";var fromLoanEndDateDateLimit="0";var toLoanEndDateDateLimit="999999999999999";var hideLoanSingleActionButtons=false;var LOAN_STATUS=Object.freeze({REGISTERING:"new loan application",VERIFIED:"did client verification",SUBMITTED:"submitted and pending approval",REJECTED:"closed - rejected",WITHDRAWN:"closed - withdrawn",APPROVED:"approved",CONTRACT_SIGNED:"contract is signed by client",AWAITING_DISBURSEMENT:"loan is allwed to be disbursed",ACTIVE:"active",CLOSED:"closed - obligations met",CANCELED:"closed - written off",OVERPAID:"overpaid"});var LoanHandler=function(){LoanHandler.self=this;this.forReporting=false;loanList.addDataModelChangedEventListenerCallback(LoanHandler.prototype.dataModelChanged);loanList.addEntityChangedEventListenerCallback(LoanHandler.prototype.loanEntityChanged);$("#loanApplicationForm input").on("input",LoanHandler.prototype.dataChangedHandler);$("#loanApplicationForm select").on("input",LoanHandler.prototype.dataChangedHandler);$("#loanReportType").on("input",LoanHandler.prototype.genericLoanReportSelectHandler);$("#loanReportTypePortfolio").on("input",LoanHandler.prototype.genericLoanReportProfileSelectHandler);$("#loanActionsResetBtn").off("click touch");$("#loanActionsResetBtn").click(function(){LoanHandler.prototype.handleResetChangesAction()});$("#loanActionsBackBtn").off("click touch");$("#loanActionsBackBtn").on("click touch",LoanHandler.prototype.handleBackAction);$("#loanActionsApproveWithChangesBtn").off("click touch");$("#loanActionsApproveWithChangesBtn").on("click touch",LoanHandler.self.approveApplicationWithChanges);$("#loanActionsApproveBtn").off("click touch");$("#loanActionsApproveBtn").on("click touch",LoanHandler.self.handleApproveAction);$("#loanActionsRejectBtn").off("click touch");$("#loanActionsRejectBtn").on("click touch",LoanHandler.prototype.handleRejectAction);$("#loanActionsAllowDisbursementBtn").off("click touch");$("#loanActionsAllowDisbursementBtn").on("click touch",LoanHandler.prototype.handleAllowDisbursmentAction);$("#loanActionsConfirmContractSignedBtn").off("click touch");$("#loanActionsConfirmContractSignedBtn").on("click touch",LoanHandler.prototype.handleConfirmContractSignedAction);$("#loanActionsDisburseBtn").off("click touch");$("#loanActionsDisburseBtn").on("click touch",LoanHandler.prototype.handleDisburseAction);$("#loanActionsMakeRepaymentBtn").off("click touch");$("#loanActionsMakeRepaymentBtn").click(function(){LoanHandler.prototype.handleMakeLoanRepaymentAction()});$("#repaymentSchedule-tab").on("hide.bs.tab",function(a){$('#singleActions a[data-action="print"]').hide();$("#printNow").off("click touch");$("#printNow").hide()});$("#repaymentSchedule-tab").on("show.bs.tab",function(a){$("#printNow").off("click touch");$("#printNow").on("click touch",LoanHandler.self.printRepaymentSchedule);$("#printableTitle").text("Repayment Schedule");$("#printNow").show()})};LoanHandler.prototype.hideLoanActionButtons=function(){$("#loanActionsAcceptModificationsBtn").hide();$("#loanActionsWithdrawApplicationBtn").hide();$("#loanActionsResetBtn").hide();$("#loanActionsBackBtn").hide();$("#loanActionsApproveWithChangesBtn").hide();$("#loanActionsApproveBtn").hide();$("#loanActionsRejectBtn").hide();$("#loanActionsAllowDisbursementBtn").hide();$("#loanActionsConfirmContractSignedBtn").hide();$("#loanActionsDisburseBtn").hide();$("#loanActionsMakeRepaymentBtn").hide()};LoanHandler.ROOT_PATH="/loan/v1d/";LoanHandler.TRANSACTION_TITLES={transactionDate:"Date",amount:"Amount",transactionType:"Type",balance:"Balance"};LoanHandler.APPLICATIONS_TITLES={loanId:"ID",ownerName:"Name",principal:"Principal",interestRate:"Rate",status:"Status",disbursementDate:"Disbursement"};LoanHandler.UNAPPROVED_LOAN_TITLES={loanId:"ID",ownerName:"Name",principal:"Principal",interestRate:"Rate",status:"Status",lastModified:"Submission Date"};LoanHandler.UNSIGNED_LOAN_TITLES={loanId:"ID",ownerName:"Name",principal:"Principal",interestRate:"Rate",status:"Status",lastModified:"Approval Date"};LoanHandler.AWAITING_DISBURSEMENT_APPROVAL_LOAN_TITLES={loanId:"ID",ownerName:"Name",principal:"Principal",interestRate:"Rate",status:"Status",lastModified:"Signed Date"};LoanHandler.AWAITING_DISBURSEMENT_LOAN_TITLES={loanId:"ID",ownerName:"Name",principal:"Principal",interestRate:"Rate",status:"Status",lastModified:"Allowed Date"};LoanHandler.ALL_TITLES={loanId:"ID",ownerName:"Name",principal:"Principal",interestRate:"Rate",disbursementDate:"Disbursement",status:"Status",lastModified:"Modified"};LoanHandler.REPAYMENT_SCHEDULE_TITLES={no:"#",dueDate:"Due date",due:"Installment",amortization:"Principal",interest:"Interest",paidDate:"Paid date",outstanding:"Outstanding"};LoanHandler.prototype.getApplications=function(){LoanHandler.forReporting=false;addHistory("Loan applications","#loanApplications",getSidebarSubitemSelector("actionRequired","Loan","getApplications"));currentTable="loanApplications";hideLoanSingleActionButtons=false;LoanHandler.self.previousPage=LoanHandler.self.getApplications;LoanHandler.self.displayApplications()};LoanHandler.prototype.getSingngContracts=function(){addHistory("Loan applications","#loanApproved",getSidebarSubitemSelector("actionRequired","Loan","getSingngContracts"));currentTable="loanSingngContracts";hideLoanSingleActionButtons=false;LoanHandler.self.previousPage=LoanHandler.self.getSingngContracts;LoanHandler.self.displayApproved()};LoanHandler.prototype.getAllowedDisbursements=function(){addHistory("Disburse Loan","#loanDisburse",getSidebarSubitemSelector("actionRequired","Loan","getAllowedDisbursements"));currentTable="loanAllowedDisbursements";hideLoanSingleActionButtons=false;LoanHandler.self.previousPage=LoanHandler.self.getAllowedDisbursements;LoanHandler.self.displayAllowedDisbursements()};LoanHandler.prototype.getDisbursements=function(){addHistory("Loan disbursements","#loanDisbursements",getSidebarSubitemSelector("actionRequired","Loan","getDisbursements"));currentTable="loanDisbursements";hideLoanSingleActionButtons=false;LoanHandler.self.previousPage=LoanHandler.self.getDisbursements;LoanHandler.self.displayDisbursements()};LoanHandler.prototype.firstGenericLoanReports=function(a){LoanHandler.forReporting=false;addHistory("Loan reports","#loanReports",getSidebarSubitemSelector("reporting","Loan","firstGenericLoanReports"));console.log("Loan List  Handling ");a=LoanHandler.self.getListByStatus();if("ALL"===a|!exists(a)||!Array.isArray(a)){a=loanList.getEntities();LoanHandler.self.loan_status="ALL";$("#loanReportType").val("ALL")}currentTable="genericLoanReports";LoanHandler.self.previousPage=LoanHandler.self.firstGenericLoanReports;LoanHandler.self.displayGenericLoanReports(a)};LoanHandler.prototype.firstGenericLoanReportsForReporting=function(a){LoanHandler.forReporting=true;hideLoanSingleActionButtons=true;addHistory("Loan reports","#loanReports",getSidebarSubitemSelector("reporting","Loan","firstGenericLoanReportsForReporting"));console.log("Loan List  Handling ");a=LoanHandler.self.getListByStatus();if("ALL"===a|!exists(a)||!Array.isArray(a)){a=loanList.getEntities();LoanHandler.self.loan_status="ALL";$("#loanReportType").val("ALL")}currentTable="genericLoanReports";LoanHandler.self.previousPage=LoanHandler.self.firstGenericLoanReportsForReporting;LoanHandler.self.displayGenericLoanReports(a)};LoanHandler.prototype.getListByStatus=function(b){var a=LoanHandler.self.loan_status;if(undefined!==b&&b!==a){a=b}switch(a){case"ALL":return loanList.getEntities();break;case"REJECTED":return loanList.getListByStatus("REJECTED");break;case"OUTSTANDING_BALANCE":return loanList.getListByStatus("ACTIVE");break;case"PORTFOLIO":return loanList;break;case"ARREARS":return[];break;case"PORTFOLIO_AT_RISK":return loanList.getListByStatus("ACTIVE").filter(function(c){return c.health!=="PAR_0"});break;case"PREPAID":return loanList.getListByStatus("ACTIVE").filter(function(c){return LoanHandler.prototype.isPrePaid(c)&&!LoanHandler.prototype.fullyRepaid(c)});break;case"FullyRepaid":return loanList.getEntities().filter(function(c){return LoanHandler.prototype.fullyRepaid(c)});$("#datesSelectorLoanEndDate").show();break;case"REPAYMENTDUE":return loanList.getListByStatus("ACTIVE").filter(function(c){return LoanHandler.prototype.hasPayment(c)});$("#datesSelectorPaymentDue").show();break;case"OVERPAID":return loanList.getListByStatus("OVERPAID");break;default:break}};LoanHandler.prototype.genericLoanReports=function(a){if(LoanHandler.forReporting===true){addHistory("Loan reports","#loanReports",getSidebarSubitemSelector("reporting","Loan","genericLoanReportsForReporting"));currentTable="genericLoanReports"}else{addHistory("Loan reports","#loanReports",getSidebarSubitemSelector("reporting","Loan","genericLoanReports"));currentTable="genericLoanReports"}a=LoanHandler.self.getListByStatus();LoanHandler.self.previousPage=LoanHandler.self.firstGenericLoanReportsForReporting;LoanHandler.self.displayGenericLoanReports(a)};LoanHandler.prototype.outputLoan=function(b){var a=null;if("loanApplications"===currentTable){if(b.status==="SUBMITTED"){a=LoanHandler.self.addToTable(b)}else{}}else{if("loanDisbursements"===currentTable){if(b.status==="CONTRACT_SIGNED"){a=LoanHandler.self.addToTable(b)}else{}}else{if("rejectedLoans"===currentTable){if(b.status==="REJECTED"){a=LoanHandler.self.addToTable(b)}else{}}else{if("allLoans"===currentTable){a=LoanHandler.self.addToTable(b)}else{}}}}return a};LoanHandler.prototype.displayApplications=function(){LoanHandler.prototype.currentLoan=null;initDefaultContent("Loan Applications Not Yet Approved ");$("#syncNow").off("click touch");$("#syncNow").on("click touch",LoanHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync Loan Applications");$("#syncNow").show();LoanHandler.self.removeTableFilterClassesLoans();LoanHandler.self.displayInTable(LoanHandler.UNAPPROVED_LOAN_TITLES,loanList.getSubmittedLoanList());showPrintButton(exportListName.loans,exportListFilter.submitted,LoanHandler.APPLICATIONS_TITLES);showExcelButton(exportListName.loans,exportListFilter.submitted,LoanHandler.APPLICATIONS_TITLES)};LoanHandler.prototype.displayApproved=function(){LoanHandler.prototype.currentLoan=null;initDefaultContent("Loans With Unsigned Contracts");$("#syncNow").off("click touch");$("#syncNow").on("click touch",LoanHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync unsigned contract loans");$("#syncNow").show();LoanHandler.self.removeTableFilterClassesLoans();LoanHandler.self.displayInTable(LoanHandler.UNSIGNED_LOAN_TITLES,loanList.getApprovedLoanList());showPrintButton(exportListName.loans,exportListFilter.approved,LoanHandler.APPLICATIONS_TITLES);showExcelButton(exportListName.loans,exportListFilter.approved,LoanHandler.APPLICATIONS_TITLES)};LoanHandler.prototype.displayDisbursements=function(){LoanHandler.prototype.currentLoan=null;initDefaultContent("Loans Awaiting Disbursement Approval");$("#syncNow").off("click touch");$("#syncNow").on("click touch",LoanHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync loans awaiting disbursement approval");$("#syncNow").show();LoanHandler.self.removeTableFilterClassesLoans();LoanHandler.self.displayInTable(LoanHandler.AWAITING_DISBURSEMENT_APPROVAL_LOAN_TITLES,loanList.getContractSignedLoanList());showPrintButton(exportListName.loans,exportListFilter.contract_signed,LoanHandler.APPLICATIONS_TITLES);showExcelButton(exportListName.loans,exportListFilter.contract_signed,LoanHandler.APPLICATIONS_TITLES)};LoanHandler.prototype.displayAllowedDisbursements=function(){LoanHandler.prototype.currentLoan=null;initDefaultContent("Loans Awaiting Disbursement");$("#syncNow").off("click touch");$("#syncNow").on("click touch",LoanHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync loans awaiting disbursement");$("#syncNow").show();LoanHandler.self.removeTableFilterClassesLoans();LoanHandler.self.displayInTable(LoanHandler.AWAITING_DISBURSEMENT_LOAN_TITLES,loanList.getDisburesmentAllowedList());showPrintButton(exportListName.loans,exportListFilter.awaiting_disbursement,LoanHandler.APPLICATIONS_TITLES);showExcelButton(exportListName.loans,exportListFilter.awaiting_disbursement,LoanHandler.APPLICATIONS_TITLES)};LoanHandler.prototype.displayLoans=function(){LoanHandler.prototype.currentLoan=null;initDefaultContent("All loans");$("#syncNow").off("click touch");$("#syncNow").on("click touch",LoanHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync loans");$("#syncNow").show();LoanHandler.self.removeTableFilterClassesLoans();LoanHandler.self.displayInTable(LoanHandler.ALL_TITLES,loanList.getEntities());showPrintButton(exportListName.loans,exportListFilter.all,LoanHandler.ALL_TITLES);showExcelButton(exportListName.loans,exportListFilter.all,LoanHandler.ALL_TITLES);$("#defaultTableContainer").addClass("allLoansTable")};LoanHandler.prototype.displayRejectedLoans=function(){LoanHandler.prototype.currentLoan=null;initDefaultContent("Rejected loans");$("#syncNow").off("click touch");$("#syncNow").on("click touch",LoanHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync rejected loans");$("#syncNow").show();$("#printNow").off("click touch");$("#printNow").on("click touch",printData);$("#printableTitle").text("Rejected Loans");$("#printNow").show();LoanHandler.self.removeTableFilterClassesLoans();LoanHandler.self.displayInTable(LoanHandler.APPLICATIONS_TITLES,loanList.getRejectedLoanList());showPrintButton(exportListName.loans,exportListFilter.rejected,LoanHandler.ALL_TITLES);showExcelButton(exportListName.loans,exportListFilter.rejected,LoanHandler.ALL_TITLES)};LoanHandler.prototype.displayGenericLoanReports=function(f){var e=f.length;LoanHandler.prototype.currentLoan=null;hideContent();$("#tableTotal").text(e);$("h3.page-header").hide();$("h4.sub-header").hide();$("#loanReportType").show();$("#syncNow").off("click touch");$("#syncNow").on("click touch",LoanHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync loans");$("#syncNow").show();$("#sendLoanEmailReportBotton").off("click touch");$("#sendLoanEmailReportBotton").on("click touch",LoanHandler.self.sendEmailLoanReportRequest);$("#sendLoanEmailReportBotton").show();var c={loanId:"ID  ",ownerName:"Name",principal:"Principal",disbursedAmount:"D.amount",disbursementDate:"D.date",interest:"Rate",status:"Status",reason:"Reason"};LoanHandler.self.removeTableFilterClassesLoans();var g=function(m){var p=exists(m.client)?m.client.gender:"--&nbsp;group&nbsp;--";var s="";if(exists(m.transactionList)){var q=m.transactionList.filter(function(u){return u.transactionType==="DISBURSEMENT"});if(q.length>0){s=q[0].transactionDate}}var r=exists(m.repaymentSchedule)?m.repaymentSchedule.rows.map(function(u){return u.interest}).sum():0;var o=exists(m.client)?m.client.phone1:"--&nbsp;group&nbsp;--";var t="--&nbsp;open&nbsp;--";if(m.status==="CLOSED"){t=formatDate(m.transactionList.filter(function(u){return u.transactionType==="REPAYMENT"&&u.balance===0})[0].transactionDate)}else{if(m.status==="REJECTED"){t=formatDate(m.lastModified)}}var n=LoanHandler.prototype.getEndDate(m);if(n!=="---"){n=formatDate(LoanHandler.prototype.getEndDate(m))}var l=formatDate(s).replaceAll(" ","&nbsp;");var i="";if(l.trim()===""){i="N/A"}else{i=m.health}return{loanId:m.loanId,ownerName:exists(m.ownerName)?m.ownerName.replaceAll(" ","&nbsp;"):exists(m.clientName)?m.clientName.replaceAll(" ","&nbsp;"):"",principal:formatCurrency(m.principal).replaceAll(" ","&nbsp;")+" "+currencyCode,disbursedAmount:formatCurrency(m.principal).replaceAll(" ","&nbsp;")+" "+currencyCode,disbursementDate:formatDate(s).replaceAll(" ","&nbsp;"),interest:formatPercentage(m.interestRate).replaceAll(" ","&nbsp;"),status:m.status,reason:m.reason}};var k=getDefaultRowContainer(c,true,"reportingLoansTable");var j=k.parent();for(var b=0;b<e;b++){addRow(k,g(f[b]),f[b],LoanHandler.self.rowClickHandler,f[b].mainId)}var d=getDefaultTableSorter();d.headers={4:{sorter:"awamoDateSorter"},6:{sorter:"awamoCurrencySorter"},10:{sorter:"awamoCurrencySorter"},11:{sorter:"awamoCurrencySorter"},16:{sorter:"awamoLoanHealthSorter"},17:{sorter:"awamoDateSorter"}};initialize_datatable(j);var a=document.getElementById("defaultTableContainer").getElementsByTagName("table");for(var b=0;b<a.length;b++){a[b].style.textAlign="right"}addClassToTableColumn(j,6,"currency");addClassToTableColumn(j,10,"currency");addClassToTableColumn(j,11,"currency");showContent($("#loanReportTypeForm"));showContent($("#tableTotalSum"));showContent($("#emailLoanReportDiv"));if(handlers.Permissions.check_access("_EXPORT_LOANS")){var h=$("#defaultTableContainer").tableExport();h.tableExport.update({formats:["xls","xlsx"],fileName:"Loans",headings:true})}showPrintButton(exportListName.loans,exportListFilter.all,LoanHandler.ALL_TITLES);showExcelButton(exportListName.loans,exportListFilter.all,LoanHandler.ALL_TITLES);$("#hiddenPrintedTitle").val("Loans Report")};LoanHandler.prototype.getTransactionsRowData=function(c){var d={};for(var a in LoanHandler.TRANSACTION_TITLES){var b=c[a];switch(a){case"transactionDate":b=formatDate(b);break;case"amount":case"balance":b=exists(b)?formatCurrency(b)+" "+currencyCode:"---";break;default:break}d[a]=String(b)}return d};LoanHandler.prototype.loan_status="ALL";LoanHandler.prototype.genericLoanReportSelectHandler=function(){$("#ClearDatesPd").click();$("#ClearDatesEd").click();var a=$(this).val();LoanHandler.self.loan_status=$(this).val();switch(a){case"ALL":LoanHandler.self.genericLoanReports(loanList.getEntities());break;case"REJECTED":LoanHandler.self.genericLoanReports(loanList.getListByStatus("REJECTED"));break;case"OUTSTANDING_BALANCE":LoanHandler.self.genericLoanReports(loanList.getListByStatus("ACTIVE"));break;case"PORTFOLIO":LoanHandler.self.genericLoanReports(loanList);$("#loanReportTypePortfolio").val("ALL");$("#loanReportTypePortfolio").show();break;case"ARREARS":LoanHandler.self.genericLoanReports([]);break;case"PORTFOLIO_AT_RISK":LoanHandler.self.genericLoanReports(loanList.getListByStatus("ACTIVE").filter(function(b){return b.health!=="PAR_0"}));break;case"PREPAID":LoanHandler.self.genericLoanReports(loanList.getListByStatus("ACTIVE").filter(function(b){return LoanHandler.prototype.isPrePaid(b)&&!LoanHandler.prototype.fullyRepaid(b)}));break;case"FullyRepaid":LoanHandler.self.genericLoanReports(loanList.getEntities().filter(function(b){return LoanHandler.prototype.fullyRepaid(b)}));$("#datesSelectorLoanEndDate").show();break;case"REPAYMENTDUE":LoanHandler.self.genericLoanReports(loanList.getListByStatus("ACTIVE").filter(function(b){return LoanHandler.prototype.hasPayment(b)}));$("#datesSelectorPaymentDue").show();break;case"OVERPAID":LoanHandler.self.genericLoanReports(loanList.getListByStatus("OVERPAID"));break;default:break}};LoanHandler.prototype.genericLoanReportProfileSelectHandler=function(){switch($(this).val()){case"ALL":LoanHandler.self.genericLoanReports(loanList.getEntities());$("#loanReportTypePortfolio").show();break;case"PAR_0":LoanHandler.self.genericLoanReports(loanList.getEntities().filter(function(a){return a.health==="PAR_0"}));$("#loanReportTypePortfolio").show();break;case"PAR_3":LoanHandler.self.genericLoanReports(loanList.getEntities().filter(function(a){return a.health==="PAR_3"}));$("#loanReportTypePortfolio").show();break;case"PAR_30":LoanHandler.self.genericLoanReports(loanList.getEntities().filter(function(a){return a.health==="PAR_30"}));$("#loanReportTypePortfolio").show();break;case"PAR_60":LoanHandler.self.genericLoanReports(loanList.getEntities().filter(function(a){return a.health==="PAR_60"}));$("#loanReportTypePortfolio").show();break;case"PAR_90":LoanHandler.self.genericLoanReports(loanList.getEntities().filter(function(a){return a.health==="PAR_90"}));$("#loanReportTypePortfolio").show();break;case"DEFAULTED":LoanHandler.self.genericLoanReports(loanList.getEntities().filter(function(a){return a.health==="DEFAULTED"}));$("#loanReportTypePortfolio").show();break;default:break}};LoanHandler.prototype.removeTableFilterClassesLoans=function(){$("#defaultTableContainer").removeClass("allLoansTable")};LoanHandler.prototype.displayInTable=function(h,g){var a=getDefaultRowContainer(h,true,"actionRequiredLoansTable");var c=a.parent();for(var f=0;f<g.length;f++){addRow(a,LoanHandler.prototype.getRowData(h,g[f]),g[f],LoanHandler.self.rowClickHandler,g[f].loanId)}var b=getDefaultTableSorter();b.headers={3:{sorter:"awamoPercentageSorter"},4:{sorter:"awamoDateSorter"}};initialize_datatable(c);var e=document.getElementById("defaultTableContainer").getElementsByTagName("table");for(var f=0;f<e.length;f++){e[f].style.textAlign="right"}if(handlers.Permissions.check_access("_EXPORT_LOANS")){var d=$("#defaultTableContainer").tableExport();d.tableExport.update({formats:["xls","xlsx"],fileName:"export",headings:true})}$("#tableTotal").text(g.length);showContent($("#tableTotalSum"))};LoanHandler.prototype.addToTable=function(f){var a=null;if("loanApplications"===currentTable||"loanDisbursements"===currentTable||"allLoans"===currentTable||"rejectedLoans"===currentTable){var h=LoanHandler.APPLICATIONS_TITLES;if("allLoans"===currentTable){h=LoanHandler.ALL_TITLES}var e=$("#defaultTableContainer");if(e.is(":visible")){var c=e.find("table");var b=c.find("tbody");var a=b.find('[data-id="'+f.loanId+'"]');var g=a.data("object");var d=LoanHandler.prototype.getRowData(h,f);LoanHandler.self.previousPage()}}};LoanHandler.prototype.getRowData=function(d,c){var e={};for(var a in d){var b=c[a];switch(a){case"clientImage":b='<img src="images/personPlaceholderNoText.png" alt="client" height="32" />';if(c.loanType==="GROUP"){b='<img src="images/groupPlaceholder.png" alt="client" height="32" />'}else{if(c.loanType==="INDIVIDUAL"){b='<img src="images/personPlaceholderNoText.png" alt="client" height="32" />'}}break;case"submitDate":case"disbursementDate":case"lastModified":b=formatDate(b);break;case"principal":b=formatCurrency(b)+" "+currencyCode;break;case"interestRate":b=formatPercentage(b)+" %";break;default:break}e[a]=String(b)}return e};LoanHandler.prototype.handleCancelRejectLoanWithMissingClientData=function(){};LoanHandler.prototype.displayOneLoan=function(a){if(a.loanClients&&a.repaymentSchedule){LoanHandler.prototype.displayLoanCompleteData(a)}else{LoanHandler.prototype.loadLoanData(a.loanId)}};LoanHandler.prototype.displayLoanCompleteData=function(d){clearExportButtons();LoanHandler.rejectNote=null;LoanHandler.self.loan=d;LoanHandler.self.loan.isInitLoanRepaymentPage=null;if(typeof(d.loanClients)==="undefined"||d.loanClients===null||d.loanClients.length===0){console.log(d);if(d.status==="REJECTED"){var b="No associated clients information";var e="Loan had missing client data and could not be further processed, user chose to reject it for purposes of recreating it";var c="Back";var a="Cancel";showDialogPopupWithHandlers(b,e,c,LoanHandler.prototype.handleCancelRejectLoanWithMissingClientData,a,LoanHandler.prototype.handleCancelRejectLoanWithMissingClientData,true);return}else{LoanHandler.rejectNote="Loan had missing client data and could not be further processed, user chose to reject it for purposes of recreating it";var b="No associated clients information";var e="Loan does not have associated clients data on it, its not possible to process it, please reject recreate the loan";var c="Reject";var a="Cancel";showDialogPopupWithHandlers(b,e,c,LoanHandler.prototype.rejectApplication,a,LoanHandler.prototype.handleCancelRejectLoanWithMissingClientData);return}}initDefaultContent("");$("#syncNow").off("click touch");$("#syncNow").on("click touch",function(){loanList.loadOne(d.loanId,LoanHandler.self.displayOneLoan)});$("#syncNow").show();populatePhoneInputFlagAddon($("#disburseLoanPhoneNumber"),$("#disburseLoanPhoneNumberCountryBtn"),$("#disburseLoanPhoneNumberCountryList"));LoanHandler.self.displayLoanDataOfLoan(d);LoanHandler.prototype.displayClientsOfLoan(d);if(d.loanType==="INDIVIDUAL"){LoanHandler.self.adjustForIndividualLoan(d)}else{if(d.loanType==="GROUP"){LoanHandler.self.adjustForGroupLoan(d)}else{}}LoanHandler.prototype.displayRepaymentScheduleOfLoan(d);if(exists(d.transactionList)&&d.transactionList.length>0){$("#loanTransactionsTableContainer").siblings(".no-info-to-display").addClass("hidden");LoanHandler.prototype.displayTransactionsOfLoan(d)}else{$("#loanTransactionsTableContainer").siblings(".no-info-to-display").removeClass("hidden")}LoanHandler.self.adjustSingleActionsByStatus(d.status);LoanHandler.self.disableFieldsOfSingleLoan(d.status!=="SUBMITTED");if(hideLoanSingleActionButtons){hideControlsForReporting("Loans")}showContent($("#loan"))};LoanHandler.prototype.loadLoanData=function(b){var a="/loan/v1d/getLoanDetails/"+b;console.log("getting loan data url : "+a);var c=getAuthenticationHeader();$.ajax({url:host+a,dataType:"json",contentType:"application/json; charset=utf-8",headers:c,type:"GET",beforeSend:function(){showLoader("Loading Loan Details . . .")},success:function(d){if(d.health){loanList.put(loanList,d);LoanHandler.prototype.displayLoanCompleteData(d);hideLoader()}else{showAlertMessage("An error occured while retrieving the loan details, Please try again.",AlertTypes.danger)}},complete:function(){hideLoader()}}).fail(function(d){hideLoader();showAlertMessage("An error occured while retrieving the loan details, Please try again.",AlertTypes.danger)})};LoanHandler.prototype.displayLoanDataOfLoan=function(d){$(".transactionPaymentField").hide();console.log("Loan xtr");console.log(d);var b=LoanHandler.prototype.getTotalOutstandingAmountAndTotalAmountOverDue(d);if(b!==null){$("#loanTotalOutstandingAmount").val(formatCurrency(b.totalAmountOutstanding)+" "+currencyCode)}else{$("#loanTotalOutstandingAmount").val(formatCurrency(0)+" "+currencyCode)}if(b!==null){$("#loanTotalOverdueAmount").val(formatCurrency(b.totalAmountOverdue)+" "+currencyCode)}else{$("#loanTotalOverdueAmount").val(formatCurrency(0)+" "+currencyCode)}$("#principal").val(formatCurrency(d.principal));$("#reason").val(d.reason);$("#disbursementDate").val(formatDate(d.disbursementDate));$("#amortization").val(d.amortizationType);$("#status").val(d.status);$("#submitDate").val(formatDate(d.submitDate));$("#duration").val(d.duration);$("#repayments").val(d.repayments);$("#interestRate").val(formatPercentage(d.interestRate));$("#repayments").val(d.numberOfRepayments);$("#interestType").val(d.interestType);$("#amortization").val(d.amortizationType);$("#interestCalculationPeriodType").val(d.interestCalculationPeriodType);$("#officerComment").text(d.officerComment);if(d.status==="REJECTED"){$("#rejectNoteGroup").show();$("#rejectNote").text(d.rejectNote)}else{$("#rejectNoteGroup").hide();$("#rejectNote").text("")}if(d.loanType==="GROUP"){$("#groupName").val(d.clientName);$("#responsibleLO").val(GroupHandler.prototype.getResponsibleLOName(d.loanOfficer))}else{$("#groupName").val("");$("#responsibleLO").val("")}if(exists(d.transactionList)){var a=d.transactionList.length;for(var c=0;c<a;c++){var e=d.transactionList[c];console.log(e);if(undefined!=e.transactionType&&e.transactionType==="DISBURSEMENT"){if(undefined!=e.transactionPayment){$("#transactionPaymentPaymentType").val(e.transactionPayment.paymentType)}if(undefined!=e.transactionPayment&&e.transactionPayment.paymentType==="CHEQUE"&&exists(LoanHandler.self.loan.isInitLoanRepaymentPage)){$("#transactionPaymentChequeNumber").val(e.transactionPayment.chequeNumber);$("#transactionPaymentChequeNumber").parent().parent().show()}else{if(undefined!=e.transactionPayment&&e.transactionPayment.paymentType==="MOBILE_MONEY"&&exists(LoanHandler.self.loan.isInitLoanRepaymentPage)){$("#transactionPaymentAccountName").val(e.transactionPayment.accountName);$("#transactionPaymentAccountName").parent().parent().show();$("#transactionPaymentPhoneNumber").val(e.transactionPayment.phoneNumber);$("#transactionPaymentPhoneNumber").parent().parent().show()}else{if(undefined!=e.transactionPayment&&e.transactionPayment.paymentType==="BANK_TRANSFER"&&exists(LoanHandler.self.loan.isInitLoanRepaymentPage)){$("#transactionPaymentAccountName").val(e.transactionPayment.accountName);$("#transactionPaymentAccountName").parent().parent().show();$("#transactionPaymentAccountNumber").val(e.transactionPayment.accountNumber);$("#transactionPaymentAccountNumber").parent().parent().show();$("#transactionPaymentBankBranch").val(e.transactionPayment.bankBranch);$("#transactionPaymentBankBranch").parent().parent().show();$("#transactionPaymentBankName").val(e.transactionPayment.bankName);$("#transactionPaymentBankName").parent().parent().show()}else{if(undefined!=e.transactionPayment&&e.transactionPayment.paymentType==="CASH"&&exists(LoanHandler.self.loan.isInitLoanRepaymentPage)){}}}}break}}}};LoanHandler.prototype.displayClientsOfLoan=function(d){$("#loanTabContentList .generatedClientTab").remove();var a=d.loanClients.length;for(var c=0;c<a;c++){var b=LoanHandler.self.displayClientOfLoan($("#clientTabContentTemplate").html(),d,c);b.insertAfter($("#loanTabContent"));$("#client"+c).css("height","450px");$("#client"+c).css("max-width","1000px");$("#client"+c).mCustomScrollbar({scrollButtons:{enable:true},theme:"my-theme",axis:"yx"})}};LoanHandler.prototype.displayClientOfLoan=function(e,f,a){console.log("Displaying loan clients");var c=$(e.replace(/###counter###/g,a));var g=f.loanClients[a];document.getElementById("loanClientImageID").src="images/personPlaceholderNoText.png";$.ajax({url:host+"/client/v1d/find?awamoId="+g.awamoId+"&deviceId=cockpit&datatype=PHOTOGRAPHY",type:"GET",headers:getAuthenticationHeader(),xhrFields:{responseType:"arraybuffer"}}).done(function(j){var i=new Blob([j],{type:"image/jpg"});var h=new FileReader();h.onload=function(k){document.getElementById("loanClientImageID").src=k.target.result};h.readAsDataURL(i)}).fail(function(h){document.getElementById("loanClientImageID").src="images/personPlaceholderNoText.png";console.log("fail");console.log(h)});var b=c.find("#clientName"+a);b.val("loading client ...");clientList.get(g.awamoId,function(h){if(h===null||typeof h==="undefined"){b.val("client awamo id: "+g.awamoId+" not found")}else{if(typeof h.fullname!=="undefined"){b.val(h.fullname)}}c.find("#loanClientIdNumber"+a).val(h.iddocument);c.find("#loanClientIdType"+a).val(h.iddocumenttype)});c.find("#numberOfChildren"+a).val(g.numberOfChildren);c.find("#numberOfChildrenInHousehold"+a).val(g.numberOfChildrenInHouseHold);c.find("#maritalStatus"+a).val(g.maritalStatus);c.find("#livingArea"+a).val(g.livingArea);c.find("#homeProvince"+a).val(g.address.province);c.find("#homeCity"+a).val(g.address.city);c.find("#homeStreet"+a).val(g.address.street);if(g.clientEmployments===null||!exists(g.clientEmployments||g.clientEmployments.length===0)){c.find("#employmentPanel"+a+" p.message").show();c.find("#employmentPanel"+a+" div.form-group").hide();c.find("#selfEmploymentPanel"+a+" p.message").show();c.find("#selfEmploymentPanel"+a+" div.form-group").hide()}else{var d=g.clientEmployments;if(d.length===1){if(d[0].employmentType==="SELF_EMPLOYED"){c.find("#employmentPanel"+a+" p.message").show();c.find("#employmentPanel"+a+" div.form-group").hide();c.find("#selfEmploymentPanel"+a+" p.message").hide();c.find("#selfEmploymentPanel"+a+" div.form-group").show()}else{if(d[0].employmentType==="EMPLOYED"){c.find("#employmentPanel"+a+" p.message").hide();c.find("#employmentPanel"+a+" div.form-group").show();c.find("#selfEmploymentPanel"+a+" p.message").show();c.find("#selfEmploymentPanel"+a+" div.form-group").hide()}else{c.find("#employmentPanel"+a+" p.message").show();c.find("#employmentPanel"+a+" div.form-group").hide();c.find("#selfEmploymentPanel"+a+" p.message").show();c.find("#selfEmploymentPanel"+a+" div.form-group").hide()}}}else{if(d.length===2){if(d[0].employmentType==="SELF_EMPLOYED"||d[1].employmentType==="SELF_EMPLOYED"){c.find("#selfEmploymentPanel"+a+" p.message").hide();c.find("#selfEmploymentPanel"+a+" div.form-group").show()}else{c.find("#selfEmploymentPanel"+a+" p.message").show();c.find("#selfEmploymentPanel"+a+" div.form-group").hide()}if(d[0].employmentType==="EMPLOYED"||d[1].employmentType==="EMPLOYED"){c.find("#employmentPanel"+a+" p.message").hide();c.find("#employmentPanel"+a+" div.form-group").show()}else{c.find("#employmentPanel"+a+" p.message").show();c.find("#employmentPanel"+a+" div.form-group").hide()}}else{c.find("#employmentPanel"+a+" p.message").show();c.find("#employmentPanel"+a+" div.form-group").hide();c.find("#selfEmploymentPanel"+a+" p.message").show();c.find("#selfEmploymentPanel"+a+" div.form-group").hide()}}if(exists(d[0])){if(d[0].employmentType==="EMPLOYED"){c.find("#employmentStartDate"+a).val(formatDate(d[0].startDate));c.find("#employmentMonthlyIncome"+a).val(formatCurrency(d[0].monthlyIncome)+" "+currencyCode);c.find("#employmentFormallyRegistered"+a).val(d[0].formallyRegistered?"yes":"no");c.find("#employmentNumberOfEmployees"+a).val(d[0].numberOfEmployees);c.find("#employmentSector"+a).val(d[0].businessSector);c.find("#employmentProvince"+a).val(d[0].address.province);c.find("#employmentCity"+a).val(d[0].address.city);c.find("#employmentStreet"+a).val(d[0].address.street)}if(d[0].employmentType==="SELF_EMPLOYED"){c.find("#selfEmploymentType"+a).val(d[0].selfEmploymentType);c.find("#selfEmploymentStartDate"+a).val(formatDate(d[0].startDate));c.find("#selfEmploymentMonthlyIncome"+a).val(formatCurrency(d[0].monthlyIncome)+" "+currencyCode);c.find("#selfEmploymentFormallyRegistered"+a).val(d[0].formallyRegistered?"yes":"no");c.find("#selfEmploymentNumberOfEmployees"+a).val(d[0].numberOfEmployees);if(d[0].sector==="BUSINESS_SECTOR"){c.find("#selfEmploymentBusinessSector"+a).val(d[0].businessSector);c.find("#farmer"+a).hide();c.find("#non-farmer"+a).show()}else{if(d[0].sector==="AGRICULTURAL_SECTOR"){c.find("#selfEmploymentAgriculturalSector"+a).val(d[0].agriculturalSector);c.find("#farmer"+a).show();c.find("#non-farmer"+a).hide()}}c.find("#selfEmploymentProvince"+a).val(d[0].address.province);c.find("#selfEmploymentCity"+a).val(d[0].address.city);c.find("#selfEmploymentStreet"+a).val(d[0].address.street)}}if(exists(d[1])){if(d.length>1){if(d[1].employmentType==="EMPLOYED"){c.find("#employmentStartDate"+a).val(formatDate(d[1].startDate));c.find("#employmentMonthlyIncome"+a).val(formatCurrency(d[1].monthlyIncome)+" "+currencyCode);c.find("#employmentFormallyRegistered"+a).val(d[0].formallyRegistered?"yes":"no");c.find("#employmentNumberOfEmployees"+a).val(d[1].numberOfEmployees);c.find("#employmentSector"+a).val(d[1].businessSector);c.find("#employmentProvince"+a).val(d[1].address.province);c.find("#employmentCity"+a).val(d[1].address.city);c.find("#employmentStreet"+a).val(d[1].address.street)}if(d[1].employmentType==="SELF_EMPLOYED"){c.find("#selfEmploymentType"+a).val(d[1].selfEmploymentType);c.find("#selfEmploymentStartDate"+a).val(formatDate(d[1].startDate));c.find("#selfEmploymentMonthlyIncome"+a).val(formatCurrency(d[1].monthlyIncome)+" "+currencyCode);c.find("#selfEmploymentFormallyRegistered"+a).val(d[0].formallyRegistered?"yes":"no");c.find("#selfEmploymentNumberOfEmployees"+a).val(d[1].numberOfEmployees);if(d[1].sector==="BUSINESS_SECTOR"){c.find("#selfEmploymentBusinessSector"+a).val(d[1].businessSector);c.find("#farmer"+a).hide();c.find("#non-farmer"+a).show()}else{if(d[1].sector==="AGRICULTURAL_SECTOR"){c.find("#selfEmploymentBusinessSector"+a).val(d[1].businessSector);c.find("#farmer"+a).show();c.find("#non-farmer"+a).hide()}}c.find("#selfEmploymentProvince"+a).val(d[1].address.province);c.find("#selfEmploymentCity"+a).val(d[1].address.city);c.find("#selfEmploymentStreet"+a).val(d[1].address.street)}}}}return c};LoanHandler.prototype.getRepaymentScheduleRowData=function(f,d){var l={};for(var j in LoanHandler.REPAYMENT_SCHEDULE_TITLES){var c=f[j];if(parseInt(c)<0){c=""}else{switch(j){case"no":c=d;break;case"dueDate":c=formatDate(c);break;case"due":case"amortization":case"interest":case"outstanding":c=formatCurrency(c)+" "+currencyCode;break;case"paidDate":var e=f.due;var k=f.dueDate;var h=f.outstanding;var h=f.outstanding;var m=f.paid;if(h===0){if((c!=null||c!=undefined)){c=formatDate(c)}else{c=" "}}else{if(h>0&&m>0){var a="normal";if(k!=undefined&&k!=null){var g=new Date();var b=new Date(parseInt(k));if(g>b){a="expired"}}c='<label class="'+a+'"  >Not Fully Paid</label>'}else{var a="normal";if(k!=undefined&&k!=null){var g=new Date();var b=new Date(parseInt(k));if(g>b){a="expired"}}c='<label class="'+a+'" > Not Paid </label>'}}break;default:break}}l[j]=String(c)}return l};LoanHandler.prototype.displayRepaymentScheduleOfLoan=function(g){var b=getRowContainer("#repaymentScheduleTableContainer",LoanHandler.REPAYMENT_SCHEDULE_TITLES);var d=b.parent();if(!exists(g)||!exists(g.repaymentSchedule)||!exists(g.repaymentSchedule.rows)){console.log("no repaymentSchedule found on this loan");console.log(g);console.log("---------------------------");return}var f=g.repaymentSchedule.rows;var a=f.length;for(var e=0;e<a;e++){if(f[e].dueDate<0&&f[e].paidDate<0&&f[e].due<0&&f[e].interest<0&&f[e].outstanding<0){continue}if(g.status==="ACTIVE"&&(LoanHandler.self.previousPage!==LoanHandler.self.firstGenericLoanReportsForReporting)){addRow(b,LoanHandler.prototype.getRepaymentScheduleRowData(f[e],e),g,LoanHandler.self.loanRepaymentsRowClickHandler,g.loanId)}else{addRow(b,LoanHandler.prototype.getRepaymentScheduleRowData(f[e],e),g,null,g.loanId)}}var c=getDefaultTableSorter();c.headers={0:{sorter:"awamoDateSorter"},1:{sorter:"awamoCurrencySorter"},2:{sorter:"awamoCurrencySorter"},3:{sorter:"awamoCurrencySorter"},4:{sorter:"awamoCurrencySorter"}};c.sortList=[[4,1]];initialize_datatable(d)};LoanHandler.prototype.getTotalOutstandingAmountAndTotalAmountOverDue=function(d){var c=d.repaymentSchedule.rows;var e=0;var b=0;$.each(c,function(f,g){if(g.outstanding>=0){e+=g.outstanding;if(g.paidDate===null){b+=g.outstanding}}});var a=[];a.totalAmountOutstanding=e;a.totalAmountOverdue=b;return a};LoanHandler.prototype.adjustForIndividualLoan=function(e){$("#creditCollateralType").data("loan","");$("h3.page-header").text("Individual Loan #"+e.loanId);$("#client-tab").show();$("#group-tab").hide();$("#creditCollaterals-tab").show();$("#guarantor-tab").show();$("#guarantor-tab").show();$("#groupName").parent().parent().hide();$("#responsibleLO").parent().parent().hide();if(e.creditCollaterals!==null&&e.creditCollaterals.length>0){var a=e.creditCollaterals[0];var d=$("#creditCollateralType");d.data("loan",e);d.val(a.type).removeAttr("disabled");d.html("");for(var c=0;c<e.creditCollaterals.length;c++){var f=e.creditCollaterals[c];var b=document.createElement("option");b.value=f.index;b.innerHTML=f.type;d.append(b)}d.off("change");d.on("change",function(){var h=$(this).data("loan");var i=h.creditCollaterals;var g=parseInt($(this).val());LoanHandler.self.bindCollateralInfo(h.loanId,i[g])});LoanHandler.self.bindCollateralInfo(e.loanId,a)}else{$("#creditCollateralType").attr("disabled","disabled").html("")}if(!exists(e.loanClients[0].guarantor)){$("#guarantorPanel0 p.message").show();$("#guarantorPanel0 div.form-group").hide()}else{$("#guarantorPanel0 p.message").hide();$("#guarantorPanel0 div.form-group").show();$("#guarantorName0").val(e.loanClients[0].guarantor.guarantorName);$("#guarantorValue0").val(formatCurrency(e.loanClients[0].guarantor.guarantorValue)+" "+currencyCode)}if($("#client-tab").parent().hasClass("active")||$("#group-tab").parent().hasClass("active")){$("#client-tab").tab("show");$("#client0").addClass("active in")}};LoanHandler.prototype.bindCollateralInfo=function(c,b){$("#creditCollateralDescription").val(b.description);$("#creditCollateralValue").val(formatCurrency(b.value)+" "+currencyCode);var a=$("#collateralPanel .imageframe img")[0];if(!exists(b.image)){(function(g,f,e){$.ajax({url:host+loanList.rootPath+g+"/download/co?datatype=COLLATERAL_IMG_1&index="+e.index,type:"GET",headers:getAuthenticationHeader(),xhrFields:{responseType:"arraybuffer"}}).done(function(j){var i=new Blob([j],{type:"image/jpg"});var h=new FileReader();h.onload=function(m){f.src=m.target.result;var l=$("#creditCollateralType").data("loan");var k=parseInt(e.index);l.creditCollaterals[k].image=m.target.result;$("#creditCollateralType").data("loan",l)};h.readAsDataURL(i)}).fail(function(h){f.src="images/placeholder.png";console.log("fail")}).always(function(h){})})(c,a,b)}else{var d="data:image/jpeg;base64,"+b.image;a.src=d}};LoanHandler.prototype.adjustForGroupLoan=function(d){$("h3.page-header").text("Group Loan #"+d.loanId);$("#client-tab").hide();$("#group-tab").show();$("#creditCollaterals-tab").hide();$("#guarantor-tab").hide();$("#groupName").parent().parent().show();$("#responsibleLO").parent().parent().show();$("#group-tab-contents").empty();var a=d.loanClients.length;for(var b=0;b<a;b++){var c=$("#groupLoanClientTabItem").html().replace(/###counter###/g,b);$("#group-tab-contents").append($(c));(function(e){clientList.get(d.loanClients[e].awamoId,function(f){if(exists(f)){$("#client"+e+"-tab").text(f.fullname)}else{$("#client"+e+"-tab").text("client awamo id: "+d.loanClients[e].awamoId+" not found")}})})(b)}if($("#client-tab").parent().hasClass("active")||$("#group-tab").parent().hasClass("active")){$("#client0-tab").tab("show")}if($("#creditCollaterals-tab").parent().hasClass("active")||$("#guarantor-tab").parent().hasClass("active")){$("#loan-tab").tab("show")}};LoanHandler.prototype.disableFieldsOfSingleLoan=function(a){$("#principal").prop("disabled",a);$("#duration").prop("disabled",a);$("#amortization").prop("disabled",a);$("#repayments").prop("disabled",a);$("#interestRate").prop("disabled",a);$("#interestType").prop("disabled",a);$("#interestCalculationPeriodType").prop("disabled",a);$("#paymentType").prop("disabled",a)};LoanHandler.prototype.adjustSingleActionsByStatus=function(a){LoanHandler.prototype.hideLoanActionButtons();$("#singleActions a[data-action]").hide();$("#loanActionsBackBtn").show();if($("#repaymentSchedule-tab").parent().hasClass("active")){$("#printNow").off("click touch");$("#printNow").on("click touch",LoanHandler.self.printRepaymentSchedule);$("#printableTitle").text("Repayment Schedule");$("#printNow").show()}else{$("#printNow").off("click touch");$("#printNow").hide()}switch(a){case"SUBMITTED":$("#loanActionsApproveBtn").show();$("#loanActionsRejectBtn").show();break;case"REJECTED":break;case"APPROVED":$("#loanActionsConfirmContractSignedBtn").show();break;case"APPROVED_WITH_MODIFICATIONS":$("#loanActionsAcceptModificationsBtn").show();$("#loanActionsWithdrawApplicationBtn").show();break;case"CONTRACT_SIGNED":$("#loanActionsAllowDisbursementBtn").show();break;case"AWAITING_DISBURSEMENT":$("#loanActionsDisburseBtn").show();break;case"WITHDRAWN":break;case"ACTIVE":$("#loanActionsMakeRepaymentBtn").show();break;case"CLOSED":break;case"CANCELED":break;case"OVERPAID":break;default:break}};LoanHandler.prototype.displayTransactionsOfLoan=function(b){var j=getRowContainer("#loanTransactionsTableContainer",LoanHandler.TRANSACTION_TITLES);var h=j.parent();var f=$("#loanTransactionsTableContainer");f.empty();var h=getEmptyTable(true);f.append(h);var j=h.find("thead");addRow(j,LoanHandler.TRANSACTION_TITLES);j=h.find("tbody");if(!exists(b.transactionList)||b.transactionList===0){return}var e=b.transactionList.length;for(var c=0;c<e;c++){var a=b.transactionList[c];var g=LoanHandler.prototype.getTransactionsRowData(a);addRow(j,g)}var d=getDefaultTableSorter();d.headers={0:{sorter:"awamoDateSorter"},1:{sorter:"awamoCurrencySorter"},3:{sorter:"awamoCurrencySorter"}};h.tablesorter(d);showContent(f)};LoanHandler.prototype.getTransactionsRowData=function(c){var d={};for(var a in LoanHandler.TRANSACTION_TITLES){var b=c[a];switch(a){case"transactionDate":b=formatDate(b);break;case"amount":b=formatCurrency(b)+" "+currencyCode;break;case"balance":b=exists(b)?formatCurrency(b)+" "+currencyCode:"---";break;default:break}d[a]=String(b)}return d};LoanHandler.prototype.rowClickHandler=function(a){clearExportButtons();$("#syncNow").off("click touch");$("#syncNow").attr("title","Nothing to sync");$("#printNow").off("click touch");$("#printNow").hide();$("#singleActions a").off("click touch");$("#approveNo").off("click touch");$("#approveNo").on("click touch",LoanHandler.prototype.backToDisplayOneLoan);$("#rejectNo").off("click touch");$("#rejectNo").on("click touch",LoanHandler.prototype.backToDisplayOneLoan);$("#allowDisbursementNo").off("click touch");$("#allowDisbursementNo").on("click touch",LoanHandler.prototype.backToDisplayOneLoan);$("#confirmContractSignedNo").off("click touch");$("#confirmContractSignedNo").on("click touch",LoanHandler.prototype.backToDisplayOneLoan);$("#approveYes").off("click touch");$("#approveYes").on("click touch",LoanHandler.prototype.approveApplication);$("#rejectYes").off("click touch");$("#rejectYes").on("click touch",LoanHandler.prototype.rejectApplication);$("#loanActionsAcceptModificationsBtn").off("click touch");$("#loanActionsAcceptModificationsBtn").on("click touch",LoanHandler.prototype.handleAcceptModificationsAction);$("#loanActionsWithdrawApplicationBtn").off("click touch");$("#loanActionsWithdrawApplicationBtn").on("click touch",LoanHandler.prototype.handleWithdrawLoanApplicationAction);$("#allowDisbursementYes").off("click touch");$("#allowDisbursementYes").on("click touch",LoanHandler.prototype.allowDisbursement);$("#confirmContractSignedYes").off("click touch");$("#confirmContractSignedYes").on("click touch",LoanHandler.prototype.confirmContractSigned);clearFormValidators($("#loanApplicationForm"));LoanHandler.self.displayOneLoan($(this).data("object"))};LoanHandler.prototype.handleResetChangesAction=function(){clearFormValidators($("#loanApplicationForm"));$("#loanActionsApproveWithChangesBtn").hide();$("#loanActionsResetBtn").hide();$("#loanActionsApproveBtn").show();LoanHandler.self.displayOneLoan(LoanHandler.self.loan)};LoanHandler.prototype.handleBackAction=function(){LoanHandler.self.previousPage()};LoanHandler.prototype.isValidResponse=function(b){var a=false;switch(b){case"SUBMITTED":a=true;break;case"AWAITING_DISBURSEMENT":a=true;break;case"APPROVED":a=true;break;case"APPROVED_WITH_MODIFICATIONS":a=true;break;case"CONTRACT_SIGNED":a=true;break;case"CLOSED":a=true;break;case"ACTIVE":a=true;break;case"REJECTED":a=true;break}return a};LoanHandler.prototype.buildLoanActionMessage=function(a){var b=" caused an unepected error , please refresh the application to get latest data";switch(a){case"SUBMITTED":b=" is awaiting approval, check it out in Approve Loan Applicaions";break;case"AWAITING_DISBURSEMENT":b=" is awaiting disbursement, check for it in Disburse Loan";break;case"APPROVED":b=" is already approved ,look for it under Sign Loan Contracts";break;case"APPROVED_WITH_MODIFICATIONS":b=" is already approved with modifications ,look for it under Sign Loan Contracts";break;case"CONTRACT_SIGNED":b=", already has its contract signed, looked for it under Allow Loan Disbursements";break;case"CLOSED":b=", has already been closed, your list has been updated";break;case"ACTIVE":b=", has already been disbursed, look for it in Reporting under Loans";break;case"REJECTED":b=", has already been rejected,  your list has been updated";break}return b};LoanHandler.prototype.handleApproveAction=function(){LoanHandler.self.fetchLoanStatus(function(c){if(exists(c)){console.log(c);if(c==="SUBMITTED"){var b="Confirm Loan Approval";var e="Are you sure you want to approve this loan";var d="Yes";var a="No";showDialogPopupWithHandlers(b,e,d,function(){LoanHandler.prototype.approveApplication()},a,function(){LoanHandler.prototype.backToDisplayOneLoan()})}else{hideLoader();showAlertMessage("Loan with id: "+LoanHandler.self.loan.loanId+LoanHandler.self.buildLoanActionMessage(c),AlertTypes.warning);if(c&&LoanHandler.self.isValidResponse(c)){LoanHandler.self.loan.status=c;loanList.put(loanList,LoanHandler.self.loan);LoanHandler.self.getApplications()}else{loanList.loadOne(LoanHandler.self.loan.loanId,function(f){hideLoader();loanList.put(loanList,f);LoanHandler.self.getApplications()})}}}})};LoanHandler.prototype.handleRejectAction=function(){LoanHandler.self.fetchLoanStatus(function(a){if(exists(a)){if(a==="SUBMITTED"){$("#loan").hide();$("#rejectApplication .panel-body .rejectionObject").text("loan");$("#rejectionNote").val("");showContent($("#rejectApplication"))}else{showAlertMessage("The requested action can not be performed, Loan with id: "+LoanHandler.self.loan.loanId+LoanHandler.self.buildLoanActionMessage(a),AlertTypes.warning);if(a&&LoanHandler.self.isValidResponse(a)){LoanHandler.self.loan.status=a;loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.self.getSingngContracts()}else{loanList.loadOne(LoanHandler.self.loan.loanId,function(b){hideLoader();loanList.put(loanList,b);LoanHandler.self.getSingngContracts()})}}}})};LoanHandler.prototype.handleAllowDisbursmentAction=function(){LoanHandler.self.fetchLoanStatus(function(a){if(exists(a)){if(a==="CONTRACT_SIGNED"){$("#loan").hide();$("#allowDisbursementLoanAmount").text(formatCurrency(LoanHandler.self.loan.principal)+" "+currencyCode);$("#allowDisbursementMandatorySavings").text("0 "+currencyCode);$("#allowDisbursementOtherFees").text("0 "+currencyCode);$("#allowDisbursementDisbursementAmount").text(formatCurrency(LoanHandler.self.loan.principal)+" "+currencyCode);showContent($("#allowDisbursement"))}else{showAlertMessage("The requested action can not be performed, Loan with id: "+LoanHandler.self.loan.loanId+LoanHandler.self.buildLoanActionMessage(a),AlertTypes.warning);if(a&&LoanHandler.self.isValidResponse(a)){LoanHandler.self.loan.status=a;loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.prototype.getAllowedDisbursements()}else{loanList.loadOne(LoanHandler.self.loan.loanId,function(b){hideLoader();loanList.put(loanList,b);LoanHandler.prototype.getAllowedDisbursements()})}}}})};LoanHandler.prototype.handleConfirmContractSignedAction=function(){LoanHandler.self.fetchLoanStatus(function(c){if(exists(c)){if(c==="APPROVED"||c==="APPROVED_WITH_MODIFICATIONS"){$("#loan").hide();showContent($("#confirmContractSigned"));var b="Confirm Loan Contract Signed";var e="Are you sure you want to confirm that this loan was signed";var d="Yes";var a="No";showDialogPopupWithHandlers(b,e,d,function(){LoanHandler.prototype.confirmContractSigned()},a,function(){LoanHandler.prototype.backToDisplayOneLoan()})}else{showAlertMessage("Loan with id: "+LoanHandler.self.loan.loanId+LoanHandler.self.buildLoanActionMessage(c),AlertTypes.warning);if(c&&LoanHandler.self.isValidResponse(c)){LoanHandler.self.loan.status=c;loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.self.getSingngContracts()}else{loanList.loadOne(LoanHandler.self.loan.loanId,function(f){hideLoader();loanList.put(loanList,f);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.self.getSingngContracts()})}}}})};LoanHandler.prototype.handleDisburseAction=function(){LoanHandler.self.fetchLoanStatus(function(a){if(exists(a)){if(a==="AWAITING_DISBURSEMENT"){$("#loan").hide();Options.prototype.initLoanDisbursementPage()}else{showAlertMessage("Loan with id: "+LoanHandler.self.loan.loanId+LoanHandler.self.buildLoanActionMessage(a),AlertTypes.warning);if(a&&LoanHandler.self.isValidResponse(a)){LoanHandler.self.loan.status=a;loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.prototype.getAllowedDisbursements()}else{loanList.loadOne(LoanHandler.self.loan.loanId,function(b){hideLoader();loanList.put(loanList,b);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.prototype.getAllowedDisbursements()})}}}})};LoanHandler.prototype.handleMakeLoanRepaymentAction=function(){$("#loan").hide();LoanHandler.self.initLoanRepaymentPage(LoanHandler.self.loan)};LoanHandler.prototype.singleObjectActionHandler=function(){var a=$(this).data("action");if(a!=="print"){hideContent()}switch(a){case"back":break;case"resetChanges":break;case"approveWithChanges":break;case"approve":break;case"reject":break;case"allowDisbursement":break;case"confirmContractSigned":break;case"disburse":break;case"close":break;case"print":break;case"makeLoanRepayment":break;default:break}hideControlsForReporting("Loans")};LoanHandler.prototype.loanRepaymentActions=function(){var a=$(this).data("action");switch(a){case"back":LoanHandler.self.previousPage();break;default:break}};LoanHandler.prototype.loanRepaymentsRowClickHandler=function(a){clearExportButtons();LoanHandler.self.initLoanRepaymentPage($(this).data("object"))};LoanHandler.prototype.manage_loan_repayments=function(){LoanHandler.self.previousPage=LoanHandler.self.manage_loan_repayments;LoanHandler.self.init_repayment_list()};LoanHandler.prototype.init_repayment_list=function(){hideContent();LoanHandler.prototype.currentLoan=null;initDefaultContent("Collect Loan Repayments");$("#syncNow").off("click touch");$("#syncNow").on("click touch",LoanHandler.self.synchronizeNow);$("#syncNow").attr("title","Sync loans");$("#syncNow").show();$("#printNow").off("click touch");$("#printNow").on("click touch",printData);$("#printableTitle").text("Loans");$("#printNow").show();LoanHandler.self.removeTableFilterClassesLoans();var g=LoanHandler.self.getListByStatus("OUTSTANDING_BALANCE");var a=getDefaultRowContainer(LoanHandler.ALL_TITLES,true,"collectRepaymentsTable");var c=a.parent();for(var f=0;f<g.length;f++){addRow(a,LoanHandler.prototype.getRowData(LoanHandler.ALL_TITLES,g[f]),g[f],LoanHandler.self.loanRepaymentsRowClickHandler,g[f].loanId)}var b=getDefaultTableSorter();b.headers={3:{sorter:"awamoPercentageSorter"},4:{sorter:"awamoDateSorter"}};initialize_datatable(c);var e=document.getElementById("defaultTableContainer").getElementsByTagName("table");for(var f=0;f<e.length;f++){e[f].style.textAlign="right"}if(handlers.Permissions.check_access("_EXPORT_LOANS")){var d=$("#defaultTableContainer").tableExport();d.tableExport.update({formats:["xls","xlsx"],fileName:"export",headings:true})}$("#tableTotal").text(g.length);showContent($("#tableTotalSum"));$("#defaultTableContainer").addClass("allLoansTable")};LoanHandler.prototype.loan_id=0;LoanHandler.prototype.initLoanRepaymentPage=function(a){if(a.loanClients&&a.repaymentSchedule){LoanHandler.prototype.showLoanRepaymentPage(a)}else{LoanHandler.prototype.loadLoanDataBeforeRepayment(a)}};LoanHandler.prototype.loadLoanDataBeforeRepayment=function(b){var a="/loan/v1d/getLoanDetails/"+b.loanId;console.log("getting loan data url : "+a);var c=getAuthenticationHeader();$.ajax({url:host+a,dataType:"json",contentType:"application/json; charset=utf-8",headers:c,type:"GET",beforeSend:function(){showLoader("Loading Loan Details . . .")},success:function(d){if(d.health){loanList.put(loanList,d);LoanHandler.prototype.showLoanRepaymentPage(d);hideLoader()}else{showAlertMessage("An error occured while retrieving the loan details, Please try again.",AlertTypes.danger)}},complete:function(){hideLoader()}}).fail(function(d){hideLoader();showAlertMessage("An error occured while retrieving the loan details, Please try again.",AlertTypes.danger)})};LoanHandler.prototype.showLoanRepaymentPage=function(a){hideContent();initDefaultContent("Collect Loan Repayment");LoanHandler.self.loan_id=a.loanId;LoanHandler.self.loan=a;LoanHandler.self.loan.isInitLoanRepaymentPage=true;clearFormValidators($("#LoanRepaymentForm"));registerKeyPressValidators($("#LoanRepaymentForm"));var c="Make Loan Repayments";var b=LoanHandler.self.get_current_balance(a);if(a.loanType==="GROUP"){c="<strong>Make Group Loan Repayments</strong><a href='javascript:void(0);'  class='btn customCancelButton pull-right' id='_viewloan_details' > Loan Details</a>";$("#loan_repayment_clientname").removeAttr("required");$(".loan_repayment_clientname-panel").fadeOut();$("#loan_repayment_clientdatebirth").removeAttr("required");$(".loan_repayment_clientdatebirth-panel").fadeOut();$(".loanrepayment_img").fadeOut();$("#loan_repayment_groupname").attr("required","required");$("#loan_repayment_groupname").val(a.clientName);$(".loan_repayment_groupname-panel").fadeIn();$("#loan_responsible_lo").attr("required","required");$(".loan_responsible_lo-panel").fadeIn();$("#loan_responsible_lo").val(GroupHandler.prototype.getResponsibleLOName(a.loanOfficer));$("#loan_responsible_lo").attr("disabled","disabled")}else{if(a.loanType==="INDIVIDUAL"){c="<strong>Make Individual Loan Repayments</strong><a href='javascript:void(0);'  class='btn customCancelButton pull-right' id='_viewloan_details' > Loan Details</a>";$("#loan_repayment_clientname").attr("required","required");$(".loan_repayment_clientname-panel").fadeIn();$("#loan_repayment_clientdatebirth").attr("required","attr");$(".loan_repayment_clientdatebirth-panel").fadeIn();$(".loanrepayment_img").fadeIn();$("#loan_repayment_groupname").removeAttr("required");$(".loan_repayment_groupname-panel").fadeOut();$("#loan_responsible_lo").removeAttr("required");$(".loan_responsible_lo-panel").fadeOut();$("#loan_repayment_clientname").val(a.clientName).prop("disabled",true);$("#loan_repayment_clientdatebirth").val(formatDate(a.client.birthdate)).prop("disabled",true);document.getElementById("loanrepayment_img").src="images/personPlaceholderNoText.png";$.ajax({url:host+"/client/v1d/find?awamoId="+a.awamoId+"&deviceId=cockpit&datatype=PHOTOGRAPHY",type:"GET",headers:getAuthenticationHeader(),xhrFields:{responseType:"arraybuffer"}}).done(function(g){var f=new Blob([g],{type:"image/jpg"});var d=new FileReader();d.onload=function(h){document.getElementById("loanrepayment_img").src=h.target.result};d.readAsDataURL(f)}).fail(function(d){document.getElementById("loanrepayment_img").src="images/personPlaceholderNoText.png";console.log("fail");console.log(d)})}}$("#loan_repayment_nextDueDate").val(b.dueDate);$("#loan_repayment_nextInstallment_due").val(b.requiredBalance);$("#loan_repayment_installmentDate").val("");$("#loan_repayment_transactionPaymentPaymentType").val("");$("#loan_repayment_cheque_number").val("");$("#loan_repayment_phone_number").val("");populatePhoneInputFlagAddon($("#loan_repayment_phone_number"),$("#loan_repayment_phone_numberCountryBtn"),$("#loan_repayment_phone_numberCountryList"));$("#loan_repayment_account_name").val("");$("#loan_repayment_account_number").val("");$("#loan_repayment_bank_name").val("");$("#loan_repayment_branch_name").val("");$("#loan_repayment_installmentDate").datepicker().datepicker("setDate",new Date());$("#loanRepaymentPanal button").off("click touch");$("#loanRepaymentPanal button").on("click touch",LoanHandler.self.loanRepaymentActions);$("#LoanRepaymentForm").off("submit");$("#LoanRepaymentForm").on("submit",LoanHandler.self.submit_repay_loan);$("#loan_repayment_transactionPaymentPaymentType").off("change");$("#loan_repayment_transactionPaymentPaymentType").on("change",LoanHandler.self.validate_payment_type);$("#loanRepaymentPanal .panel-heading").html(c);console.log(LoanHandler.self.loan);console.log(a);LoanHandler.self.get_current_balance(a);showContent($("#loanRepaymentPanal"));$(".mobile_money-details-panel").fadeOut();$(".banktransfer-details-panel").fadeOut();$(".cheque-details-panel").fadeOut();$("#loan_repayment_cheque_number").removeAttr("required");$("#loan_repayment_account_name").removeAttr("required");$("#loan_repayment_account_number").removeAttr("required");$("#loan_repayment_bank_name").removeAttr("required");$("#loan_repayment_branch_name").removeAttr("required");$("#loan_repayment_phone_number").removeAttr("required");$("#pay_installments").val("submit");$("#pay_installments").html("Make Repayment");$(".loan_repayment_currency_code").html(""+currencyCode);$("#_viewloan_details").off("click touch");$("#_viewloan_details").on("click touch",function(){LoanHandler.self.displayOneLoan(a)});$("#loan_repayment_transactionamount").val("");$("#loan_repayment_transactionPaymentPaymentType").val("")};LoanHandler.prototype.validate_payment_type=function(){var b=$(this).val();$(".mobile_money-details-panel").fadeOut();$(".banktransfer-details-panel").fadeOut();$(".cheque-details-panel").fadeOut();$("#loan_repayment_cheque_number").removeAttr("required");var c=$("#loan_repayment_cheque_number").parent().parent();var a=$("#loan_repayment_cheque_number").parent();clearElementValidator(c,a);$("#loan_repayment_account_name").removeAttr("required");c=$("#loan_repayment_account_name").parent().parent();a=$("#loan_repayment_account_name").parent();clearElementValidator(c,a);$("#loan_repayment_account_number").removeAttr("required");c=$("#loan_repayment_account_number").parent().parent();a=$("#loan_repayment_account_number").parent();clearElementValidator(c,a);$("#loan_repayment_bank_name").removeAttr("required");c=$("#loan_repayment_bank_name").parent().parent();a=$("#loan_repayment_bank_name").parent();clearElementValidator(c,a);$("#loan_repayment_branch_name").removeAttr("required");c=$("#loan_repayment_branch_name").parent().parent();a=$("#loan_repayment_branch_name").parent();clearElementValidator(c,a);$("#loan_repayment_phone_number").removeAttr("required");c=$("#loan_repayment_phone_number").parent().parent();a=$("#loan_repayment_phone_number").parent();clearElementValidator(c,a);switch(b){case"CASH":break;case"CHEQUE":$(".cheque-details-panel").fadeIn();$("#loan_repayment_cheque_number").attr("required","required");c=$("#loan_repayment_cheque_number").parent().parent();a=$("#loan_repayment_cheque_number").parent();if($("#loan_repayment_cheque_number").val().length<1){validateElement(c,a,validationClasses.error,"Please provide a cheque number")}break;case"MOBILE_MONEY":$(".mobile_money-details-panel").fadeIn();$("#loan_repayment_phone_number").attr("required","required");c=$("#loan_repayment_phone_number").parent().parent();a=$("#loan_repayment_phone_number").parent();console.log("check phone number size "+$("#loan_repayment_phone_number").val().length);if($("#loan_repayment_phone_number").val().length<1){validateElement(c,a,validationClasses.error,"Please provide a phone number number")}break;case"BANK_TRANSFER":$(".banktransfer-details-panel").fadeIn();$("#loan_repayment_account_name").attr("required","required");c=$("#loan_repayment_account_name").parent().parent();a=$("#loan_repayment_account_name").parent();console.log("check ac name size "+$("#loan_repayment_account_name").val().length);if($("#loan_repayment_account_name").val().length<1){validateElement(c,a,validationClasses.error,"Please provide an account name")}$("#loan_repayment_account_number").attr("required","required");c=$("#loan_repayment_account_number").parent().parent();a=$("#loan_repayment_account_number").parent();console.log("check ac number size "+$("#loan_repayment_account_number").val().length);if($("#loan_repayment_account_number").val().length<1){validateElement(c,a,validationClasses.error,"Please provide an account number")}$("#loan_repayment_bank_name").attr("required","required");c=$("#loan_repayment_bank_name").parent().parent();a=$("#loan_repayment_bank_name").parent();console.log("check bank name size "+$("#loan_repayment_bank_name").val().length);if($("#loan_repayment_bank_name").val().length<1){validateElement(c,a,validationClasses.error,"Please provide a bank name")}$("#loan_repayment_branch_name").attr("required","required");c=$("#loan_repayment_branch_name").parent().parent();a=$("#loan_repayment_branch_name").parent();console.log("check branch name size "+$("#loan_repayment_branch_name").val().length);if($("#loan_repayment_branch_name").val().length<1){validateElement(c,a,validationClasses.error,"Please provide a branch name")}break;default:$("#loan_repayment_cheque_number").removeAttr("required");$("#loan_repayment_account_name").removeAttr("required");$("#loan_repayment_account_number").removeAttr("required");$("#loan_repayment_bank_name").removeAttr("required");$("#loan_repayment_branch_name").removeAttr("required");$("#loan_repayment_phone_number").removeAttr("required");break}registerKeyPressValidators($("#LoanRepaymentForm"))};LoanHandler.prototype.submit_repay_loan=function(f){f.preventDefault();console.log("loan repayment : "+validateForm($("#LoanRepaymentForm")));if(validateForm($("#LoanRepaymentForm"))){if($("#loan_repayment_phone_number").val().length>0){showLoader("Validating Phone Number");validatePhoneInput(("#loan_repayment_phone_number"),function(){hideLoader();var j="Confirm Loan Repayment";var i=$("#loan_repayment_clientname").val().length>0?$("#loan_repayment_clientname").val():$("#loan_repayment_groupname").val();var l="Are you sure you want to repay "+i+"'s loan ?";var k="Yes";var h="No";showDialogPopupWithHandlers(j,l,k,function(){console.log("valid repayment form");var y=$(this);var p=$("input[type=submit]",y);var B=$("#loan_repayment_clientname").val();var m=$("#loan_repayment_clientdatebirth").val();var H=$("#loan_repayment_nextDueDate").val();var w=$("#loan_repayment_nextInstallment_due").val();var q=$("#loan_repayment_installmentDate").val();var u=$("#loan_repayment_transactionPaymentPaymentType").val();var J=$("#loan_repayment_transactionamount").val();if(H.length<=0||w.length<=0){showAlertMessage("Fill Blanks ",AlertTypes.warning);return}if(q<=0||u<=0||J<=0){showAlertMessage()("Fill Blanks",AlertTypes.warning);return}var I=LoanHandler.self.loan;var M=LoanHandler.self.loan.transactionList.principal;var D=LoanHandler.self.loan.transactionList.interestRate;var n=LoanHandler.self.get_current_balance(I);J=removeCommas(J);var v=J;J=J*100;var o=selecteDate;var L=$("#loan_repayment_installmentDate").datepicker("getDate");L.setHours(0);o=L.getTime();var K=new Date();if(o>K.getTime()){showAlertMessage("Repayment Date Cant not be breater than Today ",AlertTypes.warning);return}var t;switch(u){case"CASH":t='{"paymentType" : "CASH"}';break;case"CHEQUE":var s=$("#loan_repayment_cheque_number").val();if(s===undefined||s===""||s.length<=0){showAlertMessage()("Enter Check Number",AlertTypes.warning);return}t='{"paymentType" : "CHEQUE","chequeNumber":"'+s+'"}';break;case"MOBILE_MONEY":var A=$("#loan_repayment_phone_number").val();if(A===undefined||A===""||A.length<=0){showAlertMessage("Enter Mobile Money  Number",AlertTypes.warning);return}t='{"paymentType" : "MOBILE_MONEY","phoneNumber":"'+A+'"}';break;case"BANK_TRANSFER":var x=$("#loan_repayment_account_name").val();var G=$("#loan_repayment_account_number").val();var F=$("#loan_repayment_bank_name").val();var C=$("#loan_repayment_branch_name").val();if(x.length<=0||G.length<=0||F.length<=0||C.length<=0||x===undefined||G===undefined||F===undefined){showAlertMessage("Enter Account Details",AlertTypes.warning);return}t='{"paymentType" : "BANK_TRANSFER","accountName":"'+x+'" ,"accountNumber":"'+G+'" ,"bankName":"'+F+'" ,"bankBranch":"'+C+'"}';break;default:break}var z='{"transactionAmount":"'+J+'","installmentDate":"'+o+'","transactionPayment":'+t+"}";console.log(z);var r=getAuthenticationHeader();console.log(r);var E=$("body");$.ajax({url:host+"/loan/v1d/"+LoanHandler.self.loan.loanId+"/repay",data:z,dataType:"json",contentType:"application/json; charset=utf-8",headers:r,type:"POST",beforeSend:function(){showLoader();p.prop("disabled","disabled")},success:function(N){document.getElementById("userCreationForm").reset();$("#loan_repayment_transactionamount").val("");$("#loan_repayment_transactionPaymentPaymentType").val("").trigger("change");$("#pay_installments").val("submit");$("#pay_installments").html("Make Repayment");$(".loanRepaymentPanal").find("input:text").val("");$("#pay_installments").fadeOut("fast");$("#back_to_single_loan").fadeOut("fast");showLoader("Updating Lists ");loanList.loadOne(LoanHandler.self.loan.loanId,function(O){showAlertMessage("Record Saved Successfully",AlertTypes.success);loanList.put(loanList,O,function(){$("#pay_installments").fadeIn("fast");$("#back_to_single_loan").fadeIn("fast");var P=LoanHandler.self.getListByStatus("REPAYMENTDUE");LoanHandler.self.init_repayment_list();showAlertMessage("Record Saved Successfully",AlertTypes.success)})})},complete:function(){p.prop("disabled",false);selecteDate=null}}).fail(function(N){console.log(N);console.log("Response ");console.log(N.status);hideLoader();if(N.status===403){showAlertMessage("An error occured while making this repayment, Please try again or contact the awamo support team",AlertTypes.danger)}else{if(N.status===404){showAlertMessage("Awamo Servers Not Reacheable,Please Check Your Internet Connectivity and try again",AlertTypes.danger)}else{showAlertMessage("An error occured while making this repayment, Please try again or contact the awamo support team",AlertTypes.danger)}}})},h,function(){})},function(){hideLoader();showAlertMessage("Invalid Phone number",AlertTypes.danger)})}else{console.log("valid repayment form");var e=this;var c="Confirm Loan Repayment";var b=$("#loan_repayment_clientname").val().length>0?$("#loan_repayment_clientname").val():$("#loan_repayment_groupname").val();var g="Are you sure you want to repay "+b+"'s loan ?";var d="Yes";var a="No";showDialogPopupWithHandlers(c,g,d,function(){var t=$(e);var k=$("input[type=submit]",t);var w=$("#loan_repayment_clientname").val();var h=$("#loan_repayment_clientdatebirth").val();var C=$("#loan_repayment_nextDueDate").val();var r=$("#loan_repayment_nextInstallment_due").val();var l=$("#loan_repayment_installmentDate").val();var p=$("#loan_repayment_transactionPaymentPaymentType").val();var E=$("#loan_repayment_transactionamount").val();if(C.length<=0||r.length<=0){showAlertMessage("Fill Blanks ",AlertTypes.warning);return}if(l<=0||p<=0||E<=0){showAlertMessage()("Fill Blanks",AlertTypes.warning);return}var D=LoanHandler.self.loan;var H=LoanHandler.self.loan.transactionList.principal;var y=LoanHandler.self.loan.transactionList.interestRate;var i=LoanHandler.self.get_current_balance(D);E=removeCommas(E);var q=E;E=E*100;var j=selecteDate;var G=$("#loan_repayment_installmentDate").datepicker("getDate");G.setHours(0);j=G.getTime();var F=new Date();if(j>F.getTime()){showAlertMessage("Repayment Date Cant not be breater than Today ",AlertTypes.warning);return}var o;switch(p){case"CASH":o='{"paymentType" : "CASH"}';break;case"CHEQUE":var n=$("#loan_repayment_cheque_number").val();if(n===undefined||n===""||n.length<=0){showAlertMessage()("Enter Check Number",AlertTypes.warning);return}o='{"paymentType" : "CHEQUE","chequeNumber":"'+n+'"}';break;case"MOBILE_MONEY":var v=$("#loan_repayment_phone_number").val();if(v===undefined||v===""||v.length<=0){showAlertMessage("Enter Mobile Money  Number",AlertTypes.warning);return}o='{"paymentType" : "MOBILE_MONEY","phoneNumber":"'+v+'"}';break;case"BANK_TRANSFER":var s=$("#loan_repayment_account_name").val();var B=$("#loan_repayment_account_number").val();var A=$("#loan_repayment_bank_name").val();var x=$("#loan_repayment_branch_name").val();if(s.length<=0||B.length<=0||A.length<=0||x.length<=0||s===undefined||B===undefined||A===undefined){showAlertMessage("Enter Account Details",AlertTypes.warning);return}o='{"paymentType" : "BANK_TRANSFER","accountName":"'+s+'" ,"accountNumber":"'+B+'" ,"bankName":"'+A+'" ,"bankBranch":"'+x+'"}';break;default:break}var u='{"transactionAmount":"'+E+'","installmentDate":"'+j+'","transactionPayment":'+o+"}";console.log(u);var m=getAuthenticationHeader();console.log(m);var z=$("body");$.ajax({url:host+"/loan/v1d/"+LoanHandler.self.loan.loanId+"/repay",data:u,dataType:"json",contentType:"application/json; charset=utf-8",headers:m,type:"POST",beforeSend:function(){showLoader();k.prop("disabled","disabled")},success:function(I){document.getElementById("userCreationForm").reset();$("#loan_repayment_transactionamount").val("");$("#loan_repayment_transactionPaymentPaymentType").val("").trigger("change");$("#pay_installments").val("submit");$("#pay_installments").html("Make Repayment");$(".loanRepaymentPanal").find("input:text").val("");$("#pay_installments").fadeOut("fast");$("#back_to_single_loan").fadeOut("fast");showLoader("Updating Lists ");loanList.loadOne(LoanHandler.self.loan.loanId,function(J){showAlertMessage("Record Saved Successfully",AlertTypes.success);loanList.put(loanList,J,function(){$("#pay_installments").fadeIn("fast");$("#back_to_single_loan").fadeIn("fast");var K=LoanHandler.self.getListByStatus("REPAYMENTDUE");LoanHandler.self.init_repayment_list();showAlertMessage("Record Saved Successfully",AlertTypes.success)})})},complete:function(){k.prop("disabled",false);selecteDate=null}}).fail(function(I){console.log(I);console.log("Response ");console.log(I.status);hideLoader();if(I.status===403){showAlertMessage("An error occured while making this repayment, Please try again or contact the awamo support team",AlertTypes.danger)}else{if(I.status===404){showAlertMessage("Awamo Servers Not Reacheable,Please Check Your Internet Connectivity and try again",AlertTypes.danger)}else{showAlertMessage("An error occured while making this repayment, Please try again or contact the awamo support team",AlertTypes.danger)}}})},a,function(){})}}else{showAlertMessage("Please fill in all the fields correctly",AlertTypes.danger)}};LoanHandler.prototype.get_current_balance=function(e){var h=e.repaymentSchedule.rows.length;var a=[];var d=[];for(var f=0;f<h;f++){if(e.repaymentSchedule.rows[f].outstanding===0){continue}if(e.repaymentSchedule.rows[f].dueDate===-1){continue}a.push(e.repaymentSchedule.rows[f]);d.push(e.repaymentSchedule.rows[f].dueDate)}d.sort();console.log("Due Dates ");console.log(d);console.log("Panding Installments");console.log(a);var j=0;var k=0;while(k<a.length){if(d[0]===a[k].dueDate){j=k;break}k++}var b=new Date().getTime();var c=formatCurrency((a[j].outstanding>0)?(a[j].due-a[j].paid):a[j].due);var m=e.repaymentSchedule.rows;var g=m.length;var l=formatDate(a[j].dueDate);return{dueDate:l,requiredBalance:c}};LoanHandler.prototype.approveApplication=function(){LoanHandler.self.loan.status="APPROVED";showLoader(" Approving Loan Application Please wait...");ajax(LoanHandler.ROOT_PATH+LoanHandler.self.loan.loanId+"/approve","POST",LoanHandler.prototype.approveApplicationSuccessful,null,undefined,function(a){hideLoader();console.log(a);manageErors(a)})};LoanHandler.prototype.fetchLoanStatus=function(c){var b=getAuthenticationHeader();console.log(b);var a=host+LoanHandler.ROOT_PATH+LoanHandler.self.loan.loanId+"/status";$.ajax({url:a,dataType:"json",contentType:"application/json; charset=utf-8",headers:b,type:"GET",beforeSend:function(){showLoader("  Contacting server for loan status, please wait...")},success:function(d){console.log(d);hideLoader();c(d)}}).fail(function(d){hideLoader();showAlertMessage("An error occured while attempting to retrieve the loan status, Please try again",AlertTypes.danger)})};LoanHandler.prototype.approveApplicationSuccessful=function(){hideLoader();showAlertMessage("The loan has been approved successfully",AlertTypes.success);LoanHandler.self.loan.status="APPROVED";loanList.put(loanList,LoanHandler.self.loan);LoanHandler.prototype.getApplications()};LoanHandler.prototype.approveApplicationWithChanges=function(){if(validateForm($("#loanApplicationForm"))){LoanHandler.self.fetchLoanStatus(function(c){if(exists(c)){console.log(c);if(c==="SUBMITTED"){var b="Confirm Loan Approval With Changes";var e="Are you sure you wish to approve this loan with the provided changes";var d="Confirm";var a="Cancel";showDialogPopupWithHandlers(b,e,d,function(){var f={loanId:LoanHandler.self.loan.loanId,principal:unformatCurrency($("#principal").val()),duration:$("#duration").val(),amortizationType:$("#amortization").val(),numberOfRepayments:$("#repayments").val(),interestRate:unformatPercentage($("#interestRate").val()),interestType:$("#interestType").val(),interestCalculationPeriodType:$("#interestCalculationPeriodType").val()};showLoader(" Approving with changes, please wait...");console.log("changedLoanBody");console.log(JSON.stringify(f));ajax(LoanHandler.ROOT_PATH+"modifyOnApproval","PUT",function(){LoanHandler.prototype.approveApplicationWithChangesSuccessful(f)},JSON.stringify(f),undefined,function(h,i,g){hideLoader();showAlertMessage("Approving Loan with modifications failed, with error: "+g,AlertTypes.danger);manageErrors(g)},function(h,i,g){hideLoader()})},a,function(){})}else{hideLoader();showAlertMessage("Loan with id: "+LoanHandler.self.loan.loanId+LoanHandler.self.buildLoanActionMessage(c),AlertTypes.warning);if(c&&LoanHandler.self.isValidResponse(c)){LoanHandler.self.loan.status=c;loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.self.getApplications()}else{loanList.loadOne(LoanHandler.self.loan.loanId,function(f){hideLoader();loanList.put(loanList,f);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.self.getApplications()})}}}})}else{showAlertMessage("Please ensure all the fields are filled in correctly",AlertTypes.danger)}};LoanHandler.prototype.approveApplicationWithChangesSuccessful=function(a){showAlertMessage("The loan has been approved with modifications successfully",AlertTypes.success);LoanHandler.self.loan.status="APPROVED_WITH_MODIFICATIONS";LoanHandler.self.loan.principal=a.principal;LoanHandler.self.loan.duration=a.duration;LoanHandler.self.loan.amortizationType=a.amortizationType;LoanHandler.self.loan.numberOfRepayments=a.numberOfRepayments;LoanHandler.self.loan.interestRate=a.interestRate;LoanHandler.self.loan.interestType=a.interestType;LoanHandler.self.loan.interestCalculationPeriodType=a.interestCalculationPeriodType;loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.prototype.getApplications();hideLoader()};LoanHandler.prototype.approveApplicationWithChangesFailed=function(a){showAlertMessage("The operation to approve the loan failed, Please try again",AlertTypes.danger);hideLoader()};LoanHandler.prototype.rejectApplication=function(){var b=LoanHandler.ROOT_PATH+LoanHandler.self.loan.loanId+"/reject";var a={};if(exists(LoanHandler.rejectNote)){a='{"note":"'+LoanHandler.rejectNote+'"}'}else{a='{"note":"'+$("#rejectionNote").val()+'"}'}showLoader(" Rejecting loan,please wait...");ajax(b,"POST",LoanHandler.prototype.rejectApplicationSuccessful,a)};LoanHandler.prototype.rejectApplicationSuccessful=function(){hideLoader();showAlertMessage("The loan has been rejected successfully",AlertTypes.success);LoanHandler.self.loan.status="REJECTED";loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.prototype.getApplications()};LoanHandler.prototype.confirmContractSigned=function(){var a=LoanHandler.ROOT_PATH+LoanHandler.self.loan.loanId+"/confirmContractSigned";showLoader(" Confirming loan contract, please wait...");ajax(a,"POST",LoanHandler.prototype.confirmContractSignedSuccessful,null,undefined,function(c,d,b){hideLoader();manageErrors(b);showAlertMessage("Failed to sign the loan contract, please try again, if the problem persists, contact support",AlertTypes.danger)},function(c,d,b){})};LoanHandler.prototype.handleAcceptModificationsAction=function(){LoanHandler.self.fetchLoanStatus(function(c){if(exists(c)){console.log(c);console.log(c==="APPROVED_WITH_MODIFICATIONS");if(c==="APPROVED_WITH_MODIFICATIONS"){var b="Accept Loan Modifications";var e="Please confirm that you want to accept the changes made to this loan Application";var d="Confirm";var a="Cancel";showDialogPopupWithHandlers(b,e,d,LoanHandler.prototype.handleSubmitAcceptModificationsAction,a,LoanHandler.prototype.handleCancelSubmitModificationsAction)}else{hideLoader();showAlertMessage("Loan with id: "+LoanHandler.self.loan.loanId+LoanHandler.self.buildLoanActionMessage(c),AlertTypes.warning);if(c&&LoanHandler.self.isValidResponse(c)){LoanHandler.self.loan.status=c;loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.self.getSingngContracts()}else{loanList.loadOne(LoanHandler.self.loan.loanId,function(f){hideLoader();loanList.put(loanList,f);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.self.getSingngContracts()})}}}})};LoanHandler.prototype.handleWithdrawLoanApplicationAction=function(){LoanHandler.self.fetchLoanStatus(function(c){if(exists(c)){console.log(c);if(c==="APPROVED_WITH_MODIFICATIONS"){var b="Withdraw Loan Modifications";var e="Please confirm that you want to withdraw this loan Application";var d="Confirm";var a="Cancel";showDialogPopupWithHandlers(b,e,d,LoanHandler.prototype.handleSubmitWithdrawLoanApplication,a,LoanHandler.prototype.handleCancelWithdrawLoanApplicationAction)}else{hideLoader();showAlertMessage("Loan with id: "+LoanHandler.self.loan.loanId+LoanHandler.self.buildLoanActionMessage(c),AlertTypes.warning);if(c&&LoanHandler.self.isValidResponse(c)){LoanHandler.self.loan.status=c;loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.self.getSingngContracts()}else{loanList.loadOne(LoanHandler.self.loan.loanId,function(f){hideLoader();loanList.put(loanList,f);LoanHandler.self.getSingngContracts()})}}}})};LoanHandler.prototype.handleSubmitWithdrawLoanApplication=function(){var b=getAuthenticationHeader();var a=host+LoanHandler.ROOT_PATH+LoanHandler.self.loan.loanId+"/withdraw";$.ajax({url:a,dataType:"json",contentType:"application/json; charset=utf-8",headers:b,type:"POST",beforeSend:function(){showLoader()},success:function(c){LoanHandler.self.loan.status="WITHDRAWN";loanList.put(loanList,LoanHandler.self.loan);showAlertMessage("Loan changes accepted successfully",AlertTypes.success);LoanHandler.prototype.getSingngContracts();hideLoader()}}).fail(function(c){showAlertMessage("Loan changes not accepted successfully",AlertTypes.danger);hideLoader()})};LoanHandler.prototype.handleSubmitAcceptModificationsAction=function(){var b=getAuthenticationHeader();var a=host+LoanHandler.ROOT_PATH+LoanHandler.self.loan.loanId+"/acceptModification";console.log("uri");console.log(a);$.ajax({url:a,dataType:"json",contentType:"application/json; charset=utf-8",headers:b,type:"POST",beforeSend:function(){showLoader()},success:function(c){$("#loanActionsAcceptModificationsBtn").hide();$("#loanActionsWithdrawApplicationBtn").hide();$("#loanActionsConfirmContractSignedBtn").show();$("#loanActionsBackBtn").show();LoanHandler.self.loan.status="APPROVED";loanList.put(loanList,LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();hideLoader();showAlertMessage("Loan changes accepted successfully",AlertTypes.success)}}).fail(function(c){showAlertMessage("Loan changes not accepted successfully",AlertTypes.danger);hideLoader()})};LoanHandler.prototype.handleCancelSubmitModificationsAction=function(){};LoanHandler.prototype.handleCancelWithdrawLoanApplicationAction=function(){};LoanHandler.prototype.confirmContractSignedSuccessful=function(){hideLoader();showAlertMessage("Operation successful, loan contract has been confirmed signed",AlertTypes.success);LoanHandler.self.loan.status="CONTRACT_SIGNED";loanList.store(LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.prototype.getSingngContracts()};LoanHandler.prototype.allowDisbursement=function(){var a=LoanHandler.ROOT_PATH+LoanHandler.self.loan.loanId+"/allowDisbursement";showLoader(" Allowing a disbursement, please wait...");ajax(a,"POST",LoanHandler.prototype.allowDisbursementSuccessful)};LoanHandler.prototype.allowDisbursementSuccessful=function(){hideLoader();showAlertMessage("Operation successful, loan disbursement has been allowed",AlertTypes.success);LoanHandler.self.loan.status="AWAITING_DISBURSEMENT";loanList.store(LoanHandler.self.loan);ActionRequiredHandler.prototype._dataModelChanged();LoanHandler.prototype.getDisbursements()};LoanHandler.prototype.backToDisplayOneLoan=function(){LoanHandler.self.displayOneLoan(LoanHandler.self.loan)};LoanHandler.prototype.dataChangedHandler=function(){clearFormValidators($("#loanApplicationForm"));registerKeyPressValidators($("#loanApplicationForm"));$("#loanActionsApproveWithChangesBtn").show();$("loanActionsResetBtn").show();$("#loanActionsApproveBtn").hide()};LoanHandler.prototype.dataModelChanged=function(){};LoanHandler.prototype.loanEntityChanged=function(a,b){switch(b){case eventtype.CREATE:case eventtype.UPDATE:LoanHandler.self.outputLoan(a);break;case eventtype.DELETE:console.log("not yet implemented: loan entity ["+a.mainId+"] deleted");break;default:break}};LoanHandler.prototype.clientEntityChanged=function(a,b){switch(b){case eventtype.CREATE:console.log("not yet implemented: client entity ["+a.mainId+"]created");break;case eventtype.UPDATE:console.log("not yet implemented: client entity["+a.mainId+"] updated");break;case eventtype.DELETE:console.log("not yet implemented: client entity ["+a.mainId+"] deleted");break;default:break}};LoanHandler.prototype.notifyClientListChanged=function(a){};LoanHandler.prototype.printRepaymentSchedule=function(){var e=LoanHandler.self.loan;var c=formatLocalDate(new Date());var g='\n	<p style="text-align: right; width: 100%;">awamo360 Cockpit - '+c+"</p>\n";var d='<br>\n<br>\n		<table>\n			<thead>\n				<tr>\n					<th colspan="5" style="text-align: left;">\n						Loan #'+e.loanId+'\n					</th>\n				</tr>\n			</thead>\n			<tbody>\n				<tr>\n					<td>Client name</td>\n					<td style="width: 616px; text-align: left;">'+e.clientName+'</td>\n				</tr>\n				<tr>\n					<td>Status</td>\n					<td style="width: 616px; text-align: left;">'+e.status+'</td>\n				</tr>\n				<tr>\n					<td>Interest rate p.a.</td>\n					<td style="width: 616px; text-align: left;">'+formatPercentage(e.interestRate)+' %</td>\n				</tr>\n				<tr>\n					<td>Principal</td>\n					<td style="width: 616px; text-align: left;">'+formatCurrency(e.principal)+" "+currencyCode+"</td>\n				</tr>\n			</tbody>\n		</table>\n";var a=$("#repaymentScheduleTableContainer").html();var l=$(a).clone();l.find("tr:nth-child(2)").remove();l.find("td:nth-child(2)").css("font-weight","bold");var j=l.find("td:last-child");$.each(j,function(m){var o=$(j[m]);var n=o.text();if(!n.startsWith("0")){o.text("-"+n)}});l.find("thead").prepend($('<tr>\n<th colspan="5" style="text-align: left;">Loan repayment schedule</th>\n</tr>\n'));a="<br><br><table>"+l.html()+"</table>\n";var k=window.open("","print repayment schedule","width=800,height=1200",true);var h="\ndiv {\n	width: 100%;\n	height: 95%;\n	margin-top: 20px;\n}\n\ntable {\n	display: blocK;\n	margin-left: auto;\n	margin-right: auto;\n	border-collapse: collapse;\n	width: 770px;\n}\n\ntable, th, td {\n	border: 1px solid black;\n	padding-left: 10px;\n	padding-right: 10px;\n	text-align: right;\n}\n\ntd {\n	width: 154px;\n}\n\nbutton {\n	background-color: #ffc266;\n	border-color: #ffc266;\n	color: #333333;\n	outline: none;\n	outline-color: transparent;\n	text-decoration: none;\n	line-height: 20px;\n	padding: 15px 10px;\n	font-size: 14px;\n	font-weight: 400;\n	text-align: center;\n	border: 1px solid transparent;\n	border-radius: 4px;\n}\n\nbutton:hover {\n	background-color: #ff9900;\n	border-color: #ff9900;\n}\n\n@media print {\n	button {\n		display: none;\n	}\n}\n";var b=document.createElement("style");b.type="text/css";if(b.styleSheet){b.styleSheet.cssText=h}else{b.appendChild(document.createTextNode(h))}var i='<br>\n<br>\n<button onClick="window.print();">Print repayment schedule</button>\n';var f='<div class="content">'+g+d+a+i+"</div>";k.document.head.appendChild(b);$(k.document.body).html(f)};LoanHandler.prototype.loanStatusFilter=function(a){return function(b){return b.status===a}};LoanHandler.prototype.synchronizeNow=function(){loanList.reload()};LoanHandler.prototype.sendEmailLoanReportRequest=function(){var c={tenantId:tenantId};var b="/tenant/v1d/mis/reportEmail";var a='{"startTime":"0","endTime":"0","reportEmailEntity":"LOAN","reportEmailType":"ALL","email":"'+$("#emailReportC").val()+'"}';ajax(b,"POST",LoanHandler.prototype.emailReportResponseHandler,a,c,LoanHandler.prototype.emailReportFailedResponseHandler)};LoanHandler.prototype.emailReportResponseHandler=function(a){message("Success","Message Sent Successfully",MessageType.SUCCESS)};LoanHandler.prototype.emailReportFailedResponseHandler=function(a){message("Error",a.responseJSON.message,MessageType.WARNING)};function refreshDialer(){var a=document.getElementById("loanClientImageID");var b=a.innerHTML;a.innerHTML=b}LoanHandler.prototype.isPrePaid=function(d){if(!exists(d)||!exists(d.repaymentSchedule)||!exists(d.repaymentSchedule.rows)){console.log("no repaymentSchedule found on this loan");console.log(d);console.log("---------------------------");return}if(!exists(d.transactionList)){return}var g=d.transactionList.length;if(d.transactionList.length>0){var c=d.transactionList[0];var h=c.balance}else{false}for(var e=0;e<g;e++){var c=d.transactionList[e];if(h>c.balance){var h=c.balance}}var a=new Date().getTime();var b=d.principal;var j=d.repaymentSchedule.rows;var f=j.length;for(var e=0;e<f;e++){if(j[e]["dueDate"]<a){if(j[e]["balance"]<b){b=j[e]["balance"]}}}if(h<b){return true}else{return false}};LoanHandler.prototype.fullyRepaid=function(b){if(!exists(b.transactionList)){return}for(var a=0;a<b.transactionList.length;a++){var c=b.transactionList[a];if(c.balance<=0){if(c.transactionDate<toLoanEndDateDateLimit&&c.transactionDate>fromLoanEndDateDateLimit){return true}}}return false};LoanHandler.prototype.getTotalRepayments=function(c){if(!exists(c.transactionList)){return 0}var b=0;for(var a=0;a<c.transactionList.length;a++){var d=c.transactionList[a];if(d.transactionType==="REPAYMENT"){console.log("Transaction Ammount");console.log(d.amount);b=b+d.amount}}return b};LoanHandler.prototype.getExpectedEndDate=function(d){if(!exists(d)||!exists(d.repaymentSchedule)||!exists(d.repaymentSchedule.rows)){console.log("no repaymentSchedule found on this loan");console.log(d);console.log("---------------------------");return}var c=d.repaymentSchedule.rows;var a=c.length;for(var b=0;b<a;b++){if(c[b]["balance"]===0){return c[b]["dueDate"]}}};LoanHandler.prototype.hasPayment=function(d){if(!exists(d)||!exists(d.repaymentSchedule)||!exists(d.repaymentSchedule.rows)){console.log("no repaymentSchedule found on this loan");console.log(d);console.log("---------------------------");return}var c=d.repaymentSchedule.rows;var a=c.length;for(var b=0;b<a;b++){if(c[b]["dueDate"]<toRepaymentDateLimit&&c[b]["dueDate"]>fromRepaymentDateLimit){return true}}return false};LoanHandler.prototype.getEndDate=function(b){if(!exists(b.transactionList)){return}for(var a=0;a<b.transactionList.length;a++){var c=b.transactionList[a];if(c.balance<=0){return c.transactionDate}}return"---"};